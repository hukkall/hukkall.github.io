<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>FouRod</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2020-07-09T18:47:59.392Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>AaJal</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>494. ç›®æ ‡å’Œ</title>
    <link href="http://yoursite.com/p/9c78cf30.html"/>
    <id>http://yoursite.com/p/9c78cf30.html</id>
    <published>2020-07-08T17:47:58.000Z</published>
    <updated>2020-07-09T18:47:59.392Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸åŠ¨æ€è§„åˆ’ä½œæ–—äº‰-å…¶äºŒ</p><a id="more"></a><h1 id="é¢˜ç›®"><a class="markdownIt-Anchor" href="#é¢˜ç›®"></a> é¢˜ç›®</h1><p>ç»™å®šä¸€ä¸ª<strong>éè´Ÿæ•´æ•°</strong>æ•°ç»„ï¼Œa1, a2, â€¦, an, å’Œä¸€ä¸ªç›®æ ‡æ•°ï¼ŒSã€‚ç°åœ¨ä½ æœ‰ä¸¤ä¸ªç¬¦å· + å’Œ -ã€‚å¯¹äºæ•°ç»„ä¸­çš„ä»»æ„ä¸€ä¸ªæ•´æ•°ï¼Œä½ éƒ½å¯ä»¥ä» + æˆ– -ä¸­é€‰æ‹©ä¸€ä¸ªç¬¦å·æ·»åŠ åœ¨å‰é¢ã€‚</p><p>è¿”å›å¯ä»¥ä½¿æœ€ç»ˆæ•°ç»„å’Œä¸ºç›®æ ‡æ•° S çš„æ‰€æœ‰æ·»åŠ ç¬¦å·çš„æ–¹æ³•æ•°ã€‚</p><p><strong>ç¤ºä¾‹ï¼š</strong></p><p><strong>è¾“å…¥ï¼š</strong><code>nums: [1, 1, 1, 1, 1], S: 3</code><br /><strong>è¾“å‡ºï¼š</strong><code>5</code><br /><strong>è§£é‡Šï¼š</strong></p><blockquote><p>-1+1+1+1+1 = 3<br />+1-1+1+1+1 = 3<br />+1+1-1+1+1 = 3<br />+1+1+1-1+1 = 3<br />+1+1+1+1-1 = 3</p></blockquote><p>ä¸€å…±æœ‰5ç§æ–¹æ³•è®©æœ€ç»ˆç›®æ ‡å’Œä¸º3ã€‚</p><p><strong>æç¤ºï¼š</strong></p><ul><li>æ•°ç»„éç©ºï¼Œä¸”é•¿åº¦ä¸ä¼šè¶…è¿‡ 20 ã€‚</li><li>åˆå§‹çš„æ•°ç»„çš„å’Œä¸ä¼šè¶…è¿‡ 1000 ã€‚</li><li>ä¿è¯è¿”å›çš„æœ€ç»ˆç»“æœèƒ½è¢« 32 ä½æ•´æ•°å­˜ä¸‹ã€‚</li></ul><h1 id="ç†è§£"><a class="markdownIt-Anchor" href="#ç†è§£"></a> ç†è§£</h1><p>â€‹ä¸€å¼€å§‹æˆ‘å°±æƒ³ç€æ˜¯ä¸æ˜¯ç”¨æ·±åº¦ä¼˜å…ˆæœç´¢æˆ–è€…åŠ¨æ€è§„åˆ’æ¥åšï¼Œæˆ‘çœ‹äº†çœ‹é¢˜è§£ï¼Œå‘ç°å¤§éƒ¨åˆ†äººè¯´ä¼šè¶…æ—¶ï¼Œæœ€åè¿˜æ˜¯ç”¨åŠ¨æ€è§„åˆ’æ¥åšäº†ã€‚</p><p>â€‹å‚è€ƒè¯„è®ºåŒºçš„å¤§ä½¬çš„è¯´æ³•ï¼šä¸€èˆ¬åœ°ï¼Œé—®é¢˜å¦‚æœæ˜¯ä»ä¸€ä¸ªæ•°ç»„é‡Œé¢é€‰æ‹©ä¸€äº›æ•°å­—æ¥ç»„åˆæˆä¸€ä¸ªæ•°ï¼Œå°±å¯ä»¥åŒ–è§£æˆ<strong>0-1èƒŒåŒ…é—®é¢˜</strong>ã€‚</p><p>è¿™é“é¢˜é¢˜ç›®å¯ä»¥è½¬åŒ–ä¸ºï¼šæ‰¾åˆ°ç»™å®šæ•°ç»„çš„ä¸€ä¸ªæ­£å­é›†å’Œè´Ÿå­é›†ï¼Œä½¿å…¶çš„å’Œä¸º<code>target</code></p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mtext>è®¾Pä¸ºæ­£å­é›†ï¼ŒNä¸ºè´Ÿå­é›†ï¼ŒUä¸ºæ•´ä¸ªæ•°ç»„ã€‚æœ‰ï¼š</mtext><mspace linebreak="newline"></mspace><mi mathvariant="normal">Î£</mi><mrow><mo stretchy="false">(</mo><mi>P</mi><mo stretchy="false">)</mo></mrow><mo>âˆ’</mo><mi mathvariant="normal">Î£</mi><mrow><mo stretchy="false">(</mo><mi>N</mi><mo stretchy="false">)</mo></mrow><mo>=</mo><mi>T</mi><mi>a</mi><mi>r</mi><mi>g</mi><mi>e</mi><mi>t</mi><mspace linebreak="newline"></mspace><mtext>ä¸¤è¾¹åŒæ—¶åŠ ä¸Š</mtext><mi mathvariant="normal">Î£</mi><mrow><mo stretchy="false">(</mo><mi>P</mi><mo stretchy="false">)</mo></mrow><mo>âˆ’</mo><mi mathvariant="normal">Î£</mi><mrow><mo stretchy="false">(</mo><mi>N</mi><mo stretchy="false">)</mo></mrow><mo>:</mo><mspace linebreak="newline"></mspace><mi mathvariant="normal">Î£</mi><mrow><mo stretchy="false">(</mo><mi>P</mi><mo stretchy="false">)</mo></mrow><mo>+</mo><mi mathvariant="normal">Î£</mi><mrow><mo stretchy="false">(</mo><mi>P</mi><mo stretchy="false">)</mo></mrow><mo>âˆ’</mo><mi mathvariant="normal">Î£</mi><mrow><mo stretchy="false">(</mo><mi>N</mi><mo stretchy="false">)</mo></mrow><mo>+</mo><mi mathvariant="normal">Î£</mi><mrow><mo stretchy="false">(</mo><mi>N</mi><mo stretchy="false">)</mo></mrow><mo>=</mo><mi>T</mi><mi>a</mi><mi>r</mi><mi>g</mi><mi>e</mi><mi>t</mi><mo>+</mo><mi mathvariant="normal">Î£</mi><mrow><mo stretchy="false">(</mo><mi>U</mi><mo stretchy="false">)</mo></mrow><mspace linebreak="newline"></mspace><mtext>å³</mtext><mspace linebreak="newline"></mspace><mn>2</mn><mo>â‹…</mo><mi mathvariant="normal">Î£</mi><mrow><mo stretchy="false">(</mo><mi>P</mi><mo stretchy="false">)</mo></mrow><mo>=</mo><mi>T</mi><mi>a</mi><mi>r</mi><mi>g</mi><mi>e</mi><mi>t</mi><mo>+</mo><mi mathvariant="normal">Î£</mi><mrow><mo stretchy="false">(</mo><mi>U</mi><mo stretchy="false">)</mo></mrow></mrow><annotation encoding="application/x-tex">\text{è®¾Pä¸ºæ­£å­é›†ï¼ŒNä¸ºè´Ÿå­é›†ï¼ŒUä¸ºæ•´ä¸ªæ•°ç»„ã€‚æœ‰ï¼š}\\\Sigma{(P)}-\Sigma{(N)}=Target\\\text{ä¸¤è¾¹åŒæ—¶åŠ ä¸Š}\Sigma{(P)}-\Sigma{(N)}:\\\Sigma{(P)}+\Sigma{(P)}-\Sigma{(N)}+\Sigma{(N)} = Target+\Sigma{(U)}\\\text{å³}\\2\cdot\Sigma{(P)}=Target+\Sigma{(U)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord text"><span class="mord cjk_fallback">è®¾</span><span class="mord">P</span><span class="mord cjk_fallback">ä¸ºæ­£å­é›†ï¼Œ</span><span class="mord">N</span><span class="mord cjk_fallback">ä¸ºè´Ÿå­é›†ï¼Œ</span><span class="mord">U</span><span class="mord cjk_fallback">ä¸ºæ•´ä¸ªæ•°ç»„ã€‚æœ‰ï¼š</span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">Î£</span><span class="mord"><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mclose">)</span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">Î£</span><span class="mord"><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord mathdefault">e</span><span class="mord mathdefault">t</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord cjk_fallback">ä¸¤è¾¹åŒæ—¶åŠ ä¸Š</span></span><span class="mord">Î£</span><span class="mord"><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mclose">)</span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">Î£</span><span class="mord"><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">:</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">Î£</span><span class="mord"><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mclose">)</span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">Î£</span><span class="mord"><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mclose">)</span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">Î£</span><span class="mord"><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">Î£</span><span class="mord"><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord mathdefault">e</span><span class="mord mathdefault">t</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">Î£</span><span class="mord"><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.10903em;">U</span><span class="mclose">)</span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord text"><span class="mord cjk_fallback">å³</span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">Î£</span><span class="mord"><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.13889em;">P</span><span class="mclose">)</span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault" style="margin-right:0.03588em;">g</span><span class="mord mathdefault">e</span><span class="mord mathdefault">t</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">Î£</span><span class="mord"><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.10903em;">U</span><span class="mclose">)</span></span></span></span></span></span></p><p>â€‹å°±æ˜¯è¯´åœ¨ç»™å®šçš„æ•°ç»„é‡Œé¢æ‰¾åˆ°ä¸€äº›æ•°ï¼Œä»–ä»¬çš„å’Œçš„ä¸¤å€æ˜¯ç›®æ ‡æ•°å­—åŠ ä¸Šæ•´ä¸ªæ•°ç»„ä¹‹å’Œã€‚æ¢è¨€ä¹‹ï¼Œå¦‚æœç›®æ ‡æ•°å­—åŠ ä¸Šæ•´ä¸ªæ•°ç»„ä¹‹å’Œä¸æ˜¯ä¸ªå¶æ•°ï¼Œé‚£ä¹ˆå°±è‚¯å®šä¸å­˜åœ¨è¿™ä¸ªæ­£å­é›†ã€‚è¿™æ˜¯ä¸€ä¸ªåˆ¤æ–­æ¡ä»¶ã€‚</p><p>â€‹é‚£ä¹ˆæŒ‰ç…§åŠ¨æ€è§„åˆ’çš„æ€è·¯ï¼š</p><blockquote><ul><li>å®šçŠ¶æ€</li><li>æ‰¾åŸºæ€</li><li>å†™è½¬ç§»æ–¹ç¨‹</li></ul></blockquote><p>â€‹æˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥æ¥ï¼Œå…ˆæ˜¯å®šçŠ¶æ€ï¼Œå‰é¢æˆ‘ä»¬å·²ç»è®²è¿‡ï¼Œè¿™é“é¢˜å¯ä»¥è½¬æ¢ä¸ºèƒŒåŒ…é—®é¢˜æ¥è§£å†³ã€‚ä¸€æ ·çš„ï¼Œæˆ‘ä»¬çš„çŠ¶æ€å¯ä»¥ä¸º<strong>é€‰å–æ•°çš„èŒƒå›´</strong>ï¼ˆç‰©å“ï¼‰ä»¥åŠ<strong>è¦å‡‘æˆçš„æ•°</strong>ï¼ˆé‡é‡ï¼‰è¿™ä¸¤ç§ã€‚å¾ˆå®¹æ˜“çš„ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªäºŒç»´æ•°ç»„<code>dp[i][j]</code>æ¥è¡¨ç¤ºå¯¹äºç´¢å¼•<code>[0,i]</code>çš„æ•°ï¼Œæˆ‘ä»¬èƒ½å‡‘å‡º<code>j</code>çš„æ–¹æ³•æ•°é‡ã€‚</p><p>â€‹çŠ¶æ€æˆ‘ä»¬æ˜ç¡®äº†ï¼Œé‚£ä¹ˆå°±æ¥æ‰¾æ‰¾æœ€åŸºç¡€çš„çŠ¶æ€äº†ï¼Œæ ¹æ®èƒŒåŒ…é—®é¢˜çš„ç»éªŒï¼Œ<code>dp[0][0]</code>çš„æ–¹æ³•æ•°é‡å§‹ç»ˆä¸º<code>1</code>ï¼Œå› ä¸ºé€‰æ‹©å‰<code>0</code>ä¸ªæ•°çš„æ—¶å€™ï¼Œåˆæˆ<code>0</code>çš„æ–¹æ³•æ°¸è¿œéƒ½æ˜¯<code>1</code>ï¼Œå³ä»€ä¹ˆéƒ½ä¸é€‰ã€‚</p><p>â€‹æ¥ä¸‹æ¥å°±æ˜¯æˆ‘è§‰å¾—åŠ¨æ€è§„åˆ’æœ€è®©äººå¤´ç–¼çš„çŠ¶æ€è½¬ç§»äº†ï¼Œå¯¹äºå½“å‰çš„<code>nums[i]</code>ï¼Œæœ‰ä¸¤ç§é€‰æ‹©ï¼Œè¦ä¹ˆåŠ è¿›èƒŒåŒ…ï¼Œè¦ä¹ˆä¸åŠ è¿›å»ï¼Œç”±äºæˆ‘ä»¬æ˜¯è¦æ±‚æ–¹æ³•çš„æ•°é‡ï¼Œæ‰€ä»¥è¦æŠŠ<code>nums[i]</code>æ²¡æ”¾è¿›èƒŒåŒ…çš„æƒ…å†µçš„æ–¹æ³•æ•°é‡åŠ ä¸Šæ”¾è¿›èƒŒåŒ…çš„æƒ…å†µã€‚å¯¹äº<code>dp[i][j]</code>ï¼Œå®ƒçš„å€¼ç­‰äº:</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>d</mi><mi>p</mi><mo stretchy="false">[</mo><mi>i</mi><mo>âˆ’</mo><mn>1</mn><mo stretchy="false">]</mo><mo stretchy="false">[</mo><mi>j</mi><mo stretchy="false">]</mo><mo>+</mo><mi>d</mi><mi>p</mi><mo stretchy="false">[</mo><mi>i</mi><mo>âˆ’</mo><mn>1</mn><mo stretchy="false">]</mo><mo stretchy="false">[</mo><mi>j</mi><mo>âˆ’</mo><mi>n</mi><mi>u</mi><mi>m</mi><mi>s</mi><mo stretchy="false">[</mo><mi>i</mi><mo stretchy="false">]</mo><mo stretchy="false">]</mo><mspace linebreak="newline"></mspace><mtext>æ²¡æ”¾è¿›å»</mtext><mo>+</mo><mtext>æ”¾è¿›å»äº†</mtext></mrow><annotation encoding="application/x-tex">dp[i-1][j]+dp[i-1][j-nums[i]]\\\text{æ²¡æ”¾è¿›å»}+\text{æ”¾è¿›å»äº†}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">d</span><span class="mord mathdefault">p</span><span class="mopen">[</span><span class="mord mathdefault">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">]</span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">d</span><span class="mord mathdefault">p</span><span class="mopen">[</span><span class="mord mathdefault">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">]</span><span class="mopen">[</span><span class="mord mathdefault" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault">n</span><span class="mord mathdefault">u</span><span class="mord mathdefault">m</span><span class="mord mathdefault">s</span><span class="mopen">[</span><span class="mord mathdefault">i</span><span class="mclose">]</span><span class="mclose">]</span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord text"><span class="mord cjk_fallback">æ²¡æ”¾è¿›å»</span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord text"><span class="mord cjk_fallback">æ”¾è¿›å»äº†</span></span></span></span></span></span></p><p>è¿™å¼å­å¾ˆå¥½ç†è§£ï¼Œæ²¡æ”¾è¿›å»çš„è¯ï¼Œè‚¯å®šç»§æ‰¿äº†ä¸Šä¸€æ¬¡çš„æ•°é‡å˜›ï¼›æ”¾è¿›å»çš„è¯ï¼Œå°±è¦æ‰¾ä¸€æ‰¾ä¸Šä¸€æ¬¡<strong>æ²¡åŠ ä¸Šè¿™ä¸ªæ•°</strong>çš„æ—¶å€™çš„æ–¹æ³•æ•°é‡ã€‚</p><blockquote><p>æˆ‘çŸ¥é“æˆ‘è¿™äººæ²¡å¤šä¹…å°±ä¼šå¾ˆéš¾ç†è§£åé¢è¿™å¥è¯çš„æ„æ€ï¼Œæ‰€ä»¥è¶ç€æˆ‘ç°åœ¨å¤§æ¦‚èƒ½ç†è§£ï¼Œèµ¶ç´§è®²æ˜ç™½ï¼š</p><p>æŠŠåé¢çš„é‚£ä¸ª<code>dp[i-1][j-nums[i]]</code>çš„<code>j</code>å½“åšç°åœ¨çš„èƒŒåŒ…çš„æ€»é‡é‡ï¼ˆå°±æ˜¯å·²ç»æŠŠ<code>nums[i]</code>è£…è¿›å»äº†ï¼‰ï¼Œé‚£ä¹ˆæˆ‘æƒ³çŸ¥é“ç°åœ¨èƒŒåŒ…çš„æ€»ä»·å€¼ï¼Œé‚£æˆ‘æ˜¯ä¸æ˜¯å¿…é¡»å¾—çŸ¥é“æ²¡è£…è¿™ä¸ªç‰©å“çš„æ—¶å€™ï¼Œæˆ‘çš„èƒŒåŒ…çš„æ€»ä»·å€¼ï¼Ÿ</p><p>è¿™ä¸ªä¹ŸåŒç†å˜›ï¼Œæƒ³çŸ¥é“æˆ‘åŠ ä¸Šè¿™ä¸ªæ•°ï¼ˆ<code>nums[i]</code>)ä¹‹åä¸€å…±æœ‰å¤šå°‘ç§æ–¹æ³•åˆæˆå½“å‰çš„æ•°å­—(<code>j</code>ï¼‰ï¼Ÿé‚£æˆ‘èµ·ç å¾—çŸ¥é“æ²¡åŠ è¿›å»ï¼ˆ<code>dp[i-1][j-nums[i]]</code>ï¼‰çš„æ—¶å€™æœ‰å¤šå°‘ç§æ–¹æ³•å˜›ã€‚</p></blockquote><h1 id="ä»£ç "><a class="markdownIt-Anchor" href="#ä»£ç "></a> ä»£ç </h1><div class="hljs"><pre><code class="hljs java"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Solution</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">findTargetSumWays</span><span class="hljs-params">(<span class="hljs-keyword">int</span>[] nums, <span class="hljs-keyword">int</span> S)</span> </span>&#123;        <span class="hljs-keyword">int</span> sum = <span class="hljs-number">0</span>;        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> num : nums) &#123;            sum += num;        &#125;        <span class="hljs-keyword">if</span> ((S + sum) % <span class="hljs-number">2</span> != <span class="hljs-number">0</span> || sum &lt; Math.abs(S)) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;        <span class="hljs-keyword">int</span> val = (S + sum) / <span class="hljs-number">2</span>;        <span class="hljs-keyword">int</span>[] dp = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[val + <span class="hljs-number">1</span>];        dp[<span class="hljs-number">0</span>] = <span class="hljs-number">1</span>;        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> num : nums) &#123;            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = val; j &gt;= num; j--) &#123;                dp[j] = dp[j] + dp[j - num];            &#125;        &#125;        <span class="hljs-keyword">return</span> dp[val];    &#125;&#125;</code></pre></div><p>â€‹é‚£ä¹ˆæˆ‘è¿™é‡Œä¸ºä»€ä¹ˆåªç”¨äº†ä¸€ä¸ªä¸€ç»´æ•°ç»„å‘¢ï¼Ÿå› ä¸ºæˆ‘ä»¬è§‚å¯ŸçŠ¶æ€è½¬ç§»æ–¹ç¨‹å¯ä»¥çŸ¥é“ï¼šå½“å‰çŠ¶æ€éƒ½æ˜¯ä¸Šä¸€æ¬¡çŠ¶æ€è½¬ç§»è¿‡æ¥çš„ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªä¸€ç»´æ•°ç»„ä¿å­˜æ•°æ®å°±å¯ä»¥äº†ã€‚å…¶ä¸­<code>dp[i-1][j]</code>å’Œä»£ç ä¸­å·¦ä¾§çš„<code>dp[j]</code>æ˜¯ä¸€æ ·çš„ï¼Œåœ¨ä¸ºå·¦è¾¹çš„<code>dp[j]</code>èµ‹å€¼çš„æ—¶å€™ï¼Œå³è¾¹çš„<code>dp[j]</code>è¿˜ä¿å­˜ç€ä¸Šä¸€æ¬¡å¾ªç¯çš„å€¼ï¼Œå¯¹å§ï¼Ÿ<code>dp[j-num]</code>ä¹ŸåŒç†ã€‚</p><p>â€‹è¿˜æœ‰ï¼Œä¸ºä»€ä¹ˆè¦é€†åºï¼Ÿä¸ºäº†ç¡®ä¿å³è¾¹çš„<code>dp[j]</code>å’Œ<code>dp[j-num]</code>ä¿å­˜çš„è¿˜æ˜¯ä¹‹å‰çš„å€¼ï¼Œæ‹¿<code>dp[j-num]</code>æ¥è®²ï¼š</p><blockquote><p>è®¾<code>dp[10]</code>ç­‰äº<code>dp[10]+dp[10-4]</code>æ¥è®²ï¼Œå¦‚æœé¡ºåºæ›´æ–°ï¼Œé‚£æˆ‘<code>dp[6]</code>æ˜¯ä¸æ˜¯æ¯”<code>dp[10]</code>å…ˆæ›´æ–°ï¼Ÿè¿™å°±ä¸ç¬¦åˆæˆ‘ä»¬çš„è¦æ±‚äº†å˜›</p></blockquote><p>â€‹è¿˜æœ‰ï¼Œä¸ºä»€ä¹ˆè¦ä»¥å½“å‰çš„<code>num[i]</code>ä½œä¸º<code>j</code>çš„ä¸‹é™å‘¢ï¼Ÿä½ æ€»æ²¡è§è¿‡è´Ÿæ•°çš„ç´¢å¼•å§ï¼Ÿå†µä¸”<code>j</code>å¯ä»¥çœ‹ä¸ºå½“å‰çš„èƒŒåŒ…å®¹é‡ï¼Œå¦‚æœèƒŒåŒ…å®¹é‡ä¸è¶³ä»¥è£…ä¸‹è¿™ä¸ªæ•°å­—ï¼Œé‚£è¿˜è£…ä¸ªğŸ”¨ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä¸åŠ¨æ€è§„åˆ’ä½œæ–—äº‰-å…¶äºŒ&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="ç®—æ³•" scheme="http://yoursite.com/tags/%E7%AE%97%E6%B3%95/"/>
    
      <category term="åŠ¨æ€è§„åˆ’" scheme="http://yoursite.com/tags/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/"/>
    
      <category term="èƒŒåŒ…é—®é¢˜å˜ç§" scheme="http://yoursite.com/tags/%E8%83%8C%E5%8C%85%E9%97%AE%E9%A2%98%E5%8F%98%E7%A7%8D/"/>
    
  </entry>
  
  <entry>
    <title>416.åˆ†å‰²ç­‰å’Œå­é›†</title>
    <link href="http://yoursite.com/p/7c6d07f7.html"/>
    <id>http://yoursite.com/p/7c6d07f7.html</id>
    <published>2020-07-07T16:31:23.000Z</published>
    <updated>2020-07-09T18:47:59.392Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸åŠ¨æ€è§„åˆ’ä½œæ–—äº‰-å…¶ä¸€</p><a id="more"></a><h1 id="é¢˜ç›®"><a class="markdownIt-Anchor" href="#é¢˜ç›®"></a> é¢˜ç›®</h1><p>ç»™å®šä¸€ä¸ªåªåŒ…å«<strong>æ­£æ•´æ•°</strong>çš„<strong>éç©º</strong>æ•°ç»„ã€‚æ˜¯å¦å¯ä»¥å°†è¿™ä¸ªæ•°ç»„åˆ†å‰²æˆä¸¤ä¸ªå­é›†ï¼Œä½¿å¾—ä¸¤ä¸ªå­é›†çš„å…ƒç´ å’Œç›¸ç­‰ã€‚</p><p><strong>æ³¨æ„:</strong></p><p>æ¯ä¸ªæ•°ç»„ä¸­çš„å…ƒç´ ä¸ä¼šè¶…è¿‡ 100<br />æ•°ç»„çš„å¤§å°ä¸ä¼šè¶…è¿‡ 200<br /><strong>ç¤ºä¾‹ 1:</strong></p><div class="hljs"><pre><code class="hljs angelscript">è¾“å…¥: [<span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">11</span>, <span class="hljs-number">5</span>]è¾“å‡º: <span class="hljs-literal">true</span>è§£é‡Š: æ•°ç»„å¯ä»¥åˆ†å‰²æˆ [<span class="hljs-number">1</span>, <span class="hljs-number">5</span>, <span class="hljs-number">5</span>] å’Œ [<span class="hljs-number">11</span>].</code></pre></div><p><strong>ç¤ºä¾‹ 2:</strong></p><div class="hljs"><pre><code class="hljs angelscript">è¾“å…¥: [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>]è¾“å‡º: <span class="hljs-literal">false</span>è§£é‡Š: æ•°ç»„ä¸èƒ½åˆ†å‰²æˆä¸¤ä¸ªå…ƒç´ å’Œç›¸ç­‰çš„å­é›†.</code></pre></div><h1 id="ç†è§£"><a class="markdownIt-Anchor" href="#ç†è§£"></a> ç†è§£</h1><p>â€‹é¢˜ç›®çš„ä¸¤ä¸ªå­é›†çš„å’Œç›¸ç­‰ä»£è¡¨ç€åŸæ¥æ•°ç»„çš„å’Œåº”è¯¥æ˜¯ä¸€ä¸ªå¶æ•°ï¼Œä¸ç„¶åˆ†æˆä¸¤ä¸ªå­é›†ä¹‹åï¼Œä»–ä»¬çš„å’Œå°±ä¸èƒ½ç›¸ç­‰ï¼Œè¿™æ˜¯éœ€è¦åˆ¤æ–­çš„ä¸€ä¸ªç‚¹ã€‚</p><p>â€‹è¿™ä¸ªé—®é¢˜å¯ä»¥è½¬åŒ–ä¸ºä¸€ä¸ª0-1èƒŒåŒ…é—®é¢˜ï¼Œä½¿ç”¨ä¸€ä¸ªäºŒç»´æ•°ç»„<code>dp[i][s]</code>æ¥è¡¨ç¤ºï¼š</p><blockquote><p>èƒ½å¦ä»<code>[0,i]</code>çš„èŒƒå›´å†…é€‰æ‹©ä¸€äº›æ•°å­—ï¼Œä½¿å¾—é€‰å‡ºæ¥çš„æ•°å­—ä¹‹å’Œæ°å¥½ç­‰äºsã€‚</p></blockquote><p>â€‹æˆ‘ä»¬å…ˆçœ‹çœ‹æœ€åŸºç¡€çš„çŠ¶æ€ï¼Œæ¯”å¦‚<code>dp[i][0]</code>è¿™ç§æƒ…å†µï¼Œä¸ç®¡èƒ½é€‰å¤šå°‘ä¸ªæ•°å­—ï¼Œæˆ‘ä¸€ä¸ªéƒ½ä¸é€‰ï¼Œè‚¯å®šèƒ½æ»¡è¶³ä»–ä»¬ä¹‹å’Œä¸º0ï¼Œæ‰€ä»¥<code>dp[i][0]</code>æ’ä¸º<code>true</code>ï¼Œè¿˜æœ‰<code>dp[0][s]</code>çš„æƒ…å†µï¼Œæˆ‘æ²¡æœ‰æ•°å­—å¯ä»¥é€‰æ‹©ï¼Œæ€ä¹ˆæˆ‘éƒ½å‡‘ä¸é½ä½ è¦çš„<code>s</code>ï¼Œæ‰€ä»¥é™¤äº†<code>dp[0][0]</code>ä»¥å¤–çš„æ‰€æœ‰<code>dp[0][s]</code>çš„å€¼æ’ä¸º<code>false</code>ã€‚</p><p>â€‹æ ¹æ®ä¸Šé¢çš„å®šä¹‰ï¼Œæ»¡è¶³é¢˜æ„çš„è§£ç­”æ˜¯<code>dp[len][sum/2]</code>ï¼Œå…¶ä¸­<code>len</code>æ˜¯æ•°ç»„çš„é•¿åº¦ï¼Œ<code>sum</code>æ˜¯æ•°ç»„çš„å„å…ƒç´ ä¹‹å’Œã€‚</p><p>â€‹åŸºç¡€çŠ¶æ€æœ‰äº†ï¼Œ<code>dp</code>æ•°ç»„çš„å«ä¹‰ä¹Ÿæœ‰äº†ï¼Œé‚£ä¹ˆå°±è¦ç ”ç©¶ä¸‹çŠ¶æ€è½¬ç§»äº†ã€‚</p><p>â€‹å¯¹äºå½“å‰çš„æ•°å­—<code>nums[i]</code>ï¼Œè€ƒè™‘<strong>é€‰æ‹©</strong>è¿˜æ˜¯<strong>ä¸é€‰</strong>ï¼š</p><blockquote><p>ä¸é€‰æ‹©ï¼š é‚£ä¹ˆ<code>dp[i][s]</code>çš„å€¼å°±ç­‰äºä¸Šä¸€æ¬¡çš„å€¼ï¼Œå› ä¸ºè¿™æ¬¡ä½ æ²¡æœ‰åšä»»ä½•æ”¹å˜ï¼Œç»§æ‰¿äº†ä¸Šä¸€æ¬¡çš„å€¼ï¼Œå³<code>dp[i][s] = dp[i-1][s]</code></p><p>é€‰æ‹©ï¼š <code>dp[i][s]</code>çš„å€¼å–å†³ä¸Šä¸€æ¬¡é€‰æ‹©èŒƒå›´å†…<code>[0,i-1]</code>ï¼Œæœ‰æ²¡æœ‰æ•°å­—çš„å’Œç­‰äº<code>s-nums[i]</code>ã€‚å³<code>dp[i][s] = dp[i-1][s-nums[i-1]]</code>  ã€‚</p><p>ä¸ºä»€ä¹ˆæ˜¯<code>nums[i-1]</code>? å› ä¸º<code>dp</code>æ•°ç»„çš„<code>i</code>ä»1å¼€å§‹ç®—ï¼Œæ‰€ä»¥æ¯”<code>nums</code>æ•°ç»„çš„å¤§1ã€‚</p><p>ä¸ºä»€ä¹ˆæ˜¯<code>s-nums[i-1]</code>? å› ä¸ºå¦‚æœä¸Šä¸€æ¬¡é€‰æ‹©èŒƒå›´å†…æœ‰æ•°å­—ä¹‹å’Œç­‰äº<code>s-nums[i-1]</code>ï¼Œé‚£ä¹ˆæˆ‘è¿™æ¬¡åŠ ä¸Š<code>nums[i-1]</code>è‚¯å®šæ˜¯å¯ä»¥æ»¡è¶³å’Œç­‰äº<code>s</code>çš„ã€‚</p></blockquote><p>â€‹</p><p>â€‹<strong>ä¸ºä»€ä¹ˆä»1å¼€å§‹å‘¢ï¼Ÿ</strong>å› ä¸ºåŸºç¡€çŠ¶æ€å·²ç»ç®—å‡º<code>i</code>ä¸º<code>0</code>çš„æƒ…å†µå’Œ<code>s</code>ä¸º<code>0</code>çš„æƒ…å†µäº†ã€‚</p><p>â€‹å¯¹äº<strong>ç¤ºä¾‹ä¸€</strong>è€Œè¨€ï¼š</p><blockquote><p>å½“ç„¶è¿™ä¸‹é¢çš„è´Ÿæ•°ç´¢å¼•åœ¨æ­£å¼ç¼–ç¨‹é‡Œä¼šæ’é™¤æ‰ï¼š</p><p><code>j - nums[i - 1] &lt; 0</code>//ä»£è¡¨<strong>å’Œ</strong>æ¯”å¾…åŠ ä¸Šå»çš„æ•°å°ï¼Œè¿™åœ¨è¿™ä¸ªæ­£æ•´æ•°æ•°ç»„é‡Œæ˜¯ä¸å¯èƒ½çš„ï¼Œæ¢è¨€ä¹‹å°±æ˜¯è¯´èƒŒåŒ…å®¹é‡ä¸è¶³äº†ã€‚</p><p><code>dp[i][s]=dp[i-1][s]</code>//åªèƒ½è®©ä»–çš„çŠ¶å†µä¿æŒåŸæ¥ä¸å˜äº†ã€‚</p><p><code>dp[1][1] = dp[0][1] || dp[0][1-1]</code> æ ¹æ®åŸºç¡€çŠ¶æ€å¯å¾—ä¸ºçœŸ</p><p><code>dp[1][2] = dp[0][2] || dp[0][2-1]</code> æ ¹æ®åŸºç¡€çŠ¶æ€å¯å¾—ä¸ºå‡</p><p>â€¦</p><p>ä¸€ç›´åˆ°<code>dp[1][11]</code> éƒ½ä¸ºå‡ã€‚</p><p><code>dp[2][1] = dp[1][1] || dp[1][1-5]</code> æ ¹æ®ä¹‹å‰è®°å½•çš„<code>dp[1][1]</code>å¯å¾—ï¼Œä¸ºçœŸã€‚</p><p><code>dp[2][2] = dp[1][2] || dp[1][2-5]</code> æ ¹æ®ä¹‹å‰çš„è®°å½•<code>dp[1][2]</code>å¯å¾—ï¼Œä¸ºå‡ã€‚</p><p>â€¦</p><p><code>dp[2][5] = dp[1][5] || dp[1][5-5]</code> æ ¹æ®åŸºç¡€çŠ¶æ€<code>dp[i][0]</code>å¯å¾—ï¼Œä¸ºçœŸã€‚</p><p><code>dp[2][6] = dp[1][6] || dp[1][6-1]</code>æ ¹æ®ä¹‹å‰çš„è®°å½•<code>dp[1][1]</code>å¯å¾—ï¼Œä¸ºçœŸã€‚</p><p>â€¦</p><p>ä¸€ç›´åˆ°<code>dp[2][11]</code>éƒ½ä¸ºå‡ã€‚</p><p>â€¦</p><p>å…¶ä½™çŠ¶æ€<code>dp[3][1...11]</code>ã€<code>dp[4][1...11]</code>åŒç†ã€‚</p></blockquote><p>æœ€åè¿”å›çš„ç»“æœä¸º<code>dp[4][11]</code>ï¼Œä¹Ÿå°±æ˜¯åœ¨æ•´ä¸ªæ•°ç»„èŒƒå›´<code>[1,4]</code>å†…ï¼Œèƒ½ä¸èƒ½æ‰¾åˆ°ä¸€äº›æ•°ï¼Œä½¿å¾—ä»–ä»¬ä¹‹å’Œä¸º<code>11</code>ï¼Œæ˜¾ç„¶æœ‰çš„ã€‚</p><h1 id="ä»£ç "><a class="markdownIt-Anchor" href="#ä»£ç "></a> ä»£ç </h1><div class="hljs"><pre><code class="hljs java"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Solution</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">canPartition</span><span class="hljs-params">(<span class="hljs-keyword">int</span>[] nums)</span> </span>&#123;        <span class="hljs-keyword">int</span> len = nums.length;        <span class="hljs-keyword">if</span> (len == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;        <span class="hljs-keyword">int</span> sum = <span class="hljs-number">0</span>;        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; len; i++) &#123;            sum += nums[i];        &#125;        <span class="hljs-keyword">if</span> (sum % <span class="hljs-number">2</span> != <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;        sum /= <span class="hljs-number">2</span>;        <span class="hljs-keyword">boolean</span>[][] dp = <span class="hljs-keyword">new</span> <span class="hljs-keyword">boolean</span>[len + <span class="hljs-number">1</span>][sum + <span class="hljs-number">1</span>];        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; len + <span class="hljs-number">1</span>; i++) &#123;            dp[i][<span class="hljs-number">0</span>] = <span class="hljs-keyword">true</span>;        &#125;        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span>; i &lt;= len; i++) &#123;            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">1</span>; j &lt;= sum; j++) &#123;                <span class="hljs-keyword">if</span> (j - nums[i - <span class="hljs-number">1</span>] &lt; <span class="hljs-number">0</span>) &#123;                    <span class="hljs-comment">//å®¹é‡ä¸è¶³</span>                    dp[i][j] = dp[i - <span class="hljs-number">1</span>][j];                &#125; <span class="hljs-keyword">else</span> &#123;                    dp[i][j] = dp[i - <span class="hljs-number">1</span>][j] || dp[i - <span class="hljs-number">1</span>][j - nums[i - <span class="hljs-number">1</span>]];                &#125;            &#125;        &#125;        <span class="hljs-keyword">return</span> dp[len][sum];    &#125;&#125;</code></pre></div>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä¸åŠ¨æ€è§„åˆ’ä½œæ–—äº‰-å…¶ä¸€&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="ç®—æ³•" scheme="http://yoursite.com/tags/%E7%AE%97%E6%B3%95/"/>
    
      <category term="åŠ¨æ€è§„åˆ’" scheme="http://yoursite.com/tags/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/"/>
    
  </entry>
  
  <entry>
    <title>JWT+AjaxéªŒè¯</title>
    <link href="http://yoursite.com/p/6f7d03df.html"/>
    <id>http://yoursite.com/p/6f7d03df.html</id>
    <published>2020-06-30T00:28:33.000Z</published>
    <updated>2020-07-09T18:47:59.392Z</updated>
    
    <content type="html"><![CDATA[<p>å¯¹Securityå’ŒJWTçš„æµç¨‹æœ‰äº†ä¸€å®šè®¤è¯†ä¹‹åå†™çš„ä¸€ä¸ªDemo</p><a id="more"></a><h1 id="å‰è¨€"><a class="markdownIt-Anchor" href="#å‰è¨€"></a> å‰è¨€</h1><p>â€‹æ˜¨å¤©å¯¹æ•´ä¸ªSpring Security çš„é‰´æƒå’Œæˆæƒæµç¨‹æœ‰äº†ä¸ªå¤§æ¦‚çš„äº†è§£ï¼Œä½œä¸ºä¸€ä¸ªå¯¹ä»€ä¹ˆéƒ½æƒ³è‡ªå®šä¹‰çš„äººï¼Œè‚¯å®šè¦å»å°è¯•ä¸€æ³¢è‡ªå®šä¹‰è‡ªå·±çš„æƒé™ç®¡ç†ã€‚</p><p>å…·ä½“ä»£ç å¯ä»¥çœ‹ï¼š<a href="https://gitee.com/gukkibokou/spring_sql" target="_blank" rel="noopener">Gitee</a> <a href="https://github.com/hukkall/security_jwt_json" target="_blank" rel="noopener">Github</a></p><h1 id="æŠ€æœ¯æ ˆ"><a class="markdownIt-Anchor" href="#æŠ€æœ¯æ ˆ"></a> æŠ€æœ¯æ ˆ</h1><ul><li>Spring Boot</li><li>Spring Security</li><li>Json Web Token</li><li>MyBatis-Plus</li></ul><h1 id="ç³»ç»Ÿæµç¨‹"><a class="markdownIt-Anchor" href="#ç³»ç»Ÿæµç¨‹"></a> ç³»ç»Ÿæµç¨‹</h1><h2 id="æˆæƒ"><a class="markdownIt-Anchor" href="#æˆæƒ"></a> æˆæƒ</h2><img src="/img/image-20200701162121415.png" srcset="/img/loading.gif" alt="image-20200701162121415" style="zoom:80%;" /><h2 id="é‰´æƒ"><a class="markdownIt-Anchor" href="#é‰´æƒ"></a> é‰´æƒ</h2><img src="/img/image-20200701165911025.png" srcset="/img/loading.gif" alt="image-20200701165911025" style="zoom:80%;" /><h1 id="æ“ä½œæµç¨‹"><a class="markdownIt-Anchor" href="#æ“ä½œæµç¨‹"></a> æ“ä½œæµç¨‹</h1><h2 id="å»ºè¡¨"><a class="markdownIt-Anchor" href="#å»ºè¡¨"></a> å»ºè¡¨</h2><div class="hljs"><pre><code class="hljs mysql">&#x2F;* Navicat Premium Data Transfer Source Server         : LOCA Source Server Type    : MySQL Source Server Version : 80019 Source Host           : localhost:3306 Source Schema         : boot_test Target Server Type    : MySQL Target Server Version : 80019 File Encoding         : 65001 Date: 01&#x2F;07&#x2F;2020 17:00:45*&#x2F;SET NAMES utf8mb4;SET FOREIGN_KEY_CHECKS &#x3D; 0;-- ------------------------------ Table structure for permission_role-- ----------------------------DROP TABLE IF EXISTS &#96;permission_role&#96;;CREATE TABLE &#96;permission_role&#96;  (  &#96;PREMISSION_ID&#96; int(0) NOT NULL,  &#96;ROLE_ID&#96; int(0) NOT NULL,  INDEX &#96;PREMISSION_ID&#96;(&#96;PREMISSION_ID&#96;) USING BTREE,  INDEX &#96;ROLE_ID1&#96;(&#96;ROLE_ID&#96;) USING BTREE,  CONSTRAINT &#96;PREMISSION_ID&#96; FOREIGN KEY (&#96;PREMISSION_ID&#96;) REFERENCES &#96;premission&#96; (&#96;ID&#96;) ON DELETE RESTRICT ON UPDATE RESTRICT,  CONSTRAINT &#96;ROLE_ID1&#96; FOREIGN KEY (&#96;ROLE_ID&#96;) REFERENCES &#96;role&#96; (&#96;ROLE_ID&#96;) ON DELETE RESTRICT ON UPDATE RESTRICT) ENGINE &#x3D; InnoDB CHARACTER SET &#x3D; utf8 COLLATE &#x3D; utf8_general_ci ROW_FORMAT &#x3D; Dynamic;-- ------------------------------ Records of permission_role-- ----------------------------INSERT INTO &#96;permission_role&#96; VALUES (1, 1);INSERT INTO &#96;permission_role&#96; VALUES (2, 2);-- ------------------------------ Table structure for premission-- ----------------------------DROP TABLE IF EXISTS &#96;premission&#96;;CREATE TABLE &#96;premission&#96;  (  &#96;ID&#96; int(0) NOT NULL,  &#96;PERMISSION&#96; varchar(255) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,  PRIMARY KEY (&#96;ID&#96;) USING BTREE) ENGINE &#x3D; InnoDB CHARACTER SET &#x3D; utf8 COLLATE &#x3D; utf8_general_ci ROW_FORMAT &#x3D; Dynamic;-- ------------------------------ Records of premission-- ----------------------------INSERT INTO &#96;premission&#96; VALUES (1, &#39;check:edit:delete&#39;);INSERT INTO &#96;premission&#96; VALUES (2, &#39;view&#39;);-- ------------------------------ Table structure for role-- ----------------------------DROP TABLE IF EXISTS &#96;role&#96;;CREATE TABLE &#96;role&#96;  (  &#96;ROLE_ID&#96; int(0) NOT NULL,  &#96;ROLE_NAME&#96; varchar(255) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,  PRIMARY KEY (&#96;ROLE_ID&#96;) USING BTREE) ENGINE &#x3D; InnoDB CHARACTER SET &#x3D; utf8 COLLATE &#x3D; utf8_general_ci ROW_FORMAT &#x3D; Dynamic;-- ------------------------------ Records of role-- ----------------------------INSERT INTO &#96;role&#96; VALUES (1, &#39;admin&#39;);INSERT INTO &#96;role&#96; VALUES (2, &#39;user&#39;);-- ------------------------------ Table structure for user-- ----------------------------DROP TABLE IF EXISTS &#96;user&#96;;CREATE TABLE &#96;user&#96;  (  &#96;ID&#96; bigint(0) NOT NULL AUTO_INCREMENT,  &#96;NAME&#96; varchar(255) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,  &#96;PASSWORD&#96; varchar(255) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,  PRIMARY KEY (&#96;ID&#96;) USING BTREE) ENGINE &#x3D; InnoDB AUTO_INCREMENT &#x3D; 1 CHARACTER SET &#x3D; utf8 COLLATE &#x3D; utf8_general_ci ROW_FORMAT &#x3D; Dynamic;-- ------------------------------ Records of user-- ----------------------------INSERT INTO &#96;user&#96; VALUES (1, &#39;admin&#39;, &#39;$2a$10$4tCuODS2p98tvk8EWtlhd.Mdbk1mXPwbruD4Y2VL.STIaP2Avz5bi&#39;);INSERT INTO &#96;user&#96; VALUES (2, &#39;user&#39;, &#39;$2a$10$UiSHiNwZdZ2mUSOf7bNCfONRNhMdwAJ37dJ9YVTjPvTfPPKWoLiuy&#39;);-- ------------------------------ Table structure for user_role-- ----------------------------DROP TABLE IF EXISTS &#96;user_role&#96;;CREATE TABLE &#96;user_role&#96;  (  &#96;USER_ID&#96; bigint(0) NOT NULL,  &#96;ROLE_ID&#96; int(0) NOT NULL,  &#96;ID&#96; int(0) NOT NULL AUTO_INCREMENT,  PRIMARY KEY (&#96;ID&#96;) USING BTREE,  INDEX &#96;USER_ID&#96;(&#96;USER_ID&#96;) USING BTREE,  INDEX &#96;ROLE_ID&#96;(&#96;ROLE_ID&#96;) USING BTREE,  CONSTRAINT &#96;ROLE_ID&#96; FOREIGN KEY (&#96;ROLE_ID&#96;) REFERENCES &#96;role&#96; (&#96;ROLE_ID&#96;) ON DELETE RESTRICT ON UPDATE RESTRICT,  CONSTRAINT &#96;USER_ID&#96; FOREIGN KEY (&#96;USER_ID&#96;) REFERENCES &#96;user&#96; (&#96;ID&#96;) ON DELETE RESTRICT ON UPDATE RESTRICT) ENGINE &#x3D; InnoDB AUTO_INCREMENT &#x3D; 1 CHARACTER SET &#x3D; utf8 COLLATE &#x3D; utf8_general_ci ROW_FORMAT &#x3D; Dynamic;-- ------------------------------ Records of user_role-- ----------------------------INSERT INTO &#96;user_role&#96; VALUES (1, 1, 1);INSERT INTO &#96;user_role&#96; VALUES (2, 2, 2);SET FOREIGN_KEY_CHECKS &#x3D; 1;</code></pre></div><h2 id="ä»£ç ç”Ÿæˆ"><a class="markdownIt-Anchor" href="#ä»£ç ç”Ÿæˆ"></a> ä»£ç ç”Ÿæˆ</h2><p>â€‹è¿™é‡Œæˆ‘ä½¿ç”¨äº†Mybatis-Plusçš„ä»£ç ç”Ÿæˆå™¨</p><div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">//1ã€å…¨å±€é…ç½®</span>        GlobalConfig config = <span class="hljs-keyword">new</span> GlobalConfig();        String projectPath = System.getProperty(<span class="hljs-string">"user.dir"</span>);        config.setActiveRecord(<span class="hljs-keyword">true</span>)<span class="hljs-comment">//å¼€å¯ARæ¨¡å¼</span>                .setAuthor(<span class="hljs-string">""</span>)<span class="hljs-comment">//è®¾ç½®ä½œè€…</span>                .setOutputDir(projectPath + <span class="hljs-string">"/src/main/java"</span>)<span class="hljs-comment">//ç”Ÿæˆè·¯å¾„(ä¸€èˆ¬åœ¨æ­¤é¡¹ç›®çš„src/main/javaä¸‹)</span>                .setFileOverride(<span class="hljs-keyword">true</span>)<span class="hljs-comment">//ç¬¬äºŒæ¬¡ç”Ÿæˆä¼šæŠŠç¬¬ä¸€æ¬¡ç”Ÿæˆçš„è¦†ç›–æ‰</span>                <span class="hljs-comment">//.setSwagger2(true)//å®ä½“å±æ€§ Swagger2 æ³¨è§£</span>                .setIdType(IdType.AUTO)<span class="hljs-comment">//ä¸»é”®ç­–ç•¥</span>                .setServiceName(<span class="hljs-string">"%sService"</span>)<span class="hljs-comment">//ç”Ÿæˆçš„serviceæ¥å£åå­—é¦–å­—æ¯æ˜¯å¦ä¸ºIï¼Œè¿™æ ·è®¾ç½®å°±æ²¡æœ‰I</span>                .setBaseResultMap(<span class="hljs-keyword">true</span>)<span class="hljs-comment">//ç”ŸæˆresultMap</span>                .setBaseColumnList(<span class="hljs-keyword">true</span>);<span class="hljs-comment">//åœ¨xmlä¸­ç”ŸæˆåŸºç¡€åˆ—</span>        <span class="hljs-comment">//2ã€æ•°æ®æºé…ç½®</span>        DataSourceConfig dataSourceConfig = <span class="hljs-keyword">new</span> DataSourceConfig();        dataSourceConfig.setDbType(DbType.MYSQL)<span class="hljs-comment">//æ•°æ®åº“ç±»å‹</span>                .setDriverName(<span class="hljs-string">"com.mysql.cj.jdbc.Driver"</span>)                .setUrl(<span class="hljs-string">"jdbc:mysql://localhost:3306/xiaoluo?useSSL=true&amp;serverTimezone=GMT"</span>)                .setUsername(<span class="hljs-string">"root"</span>)                .setPassword(<span class="hljs-string">"ä½ çš„å¯†ç "</span>);        <span class="hljs-comment">//3ã€ç­–ç•¥é…ç½®</span>        StrategyConfig strategyConfig = <span class="hljs-keyword">new</span> StrategyConfig();        strategyConfig.setCapitalMode(<span class="hljs-keyword">true</span>)<span class="hljs-comment">//å¼€å¯å…¨å±€å¤§å†™å‘½å</span>                .setNaming(NamingStrategy.no_change)<span class="hljs-comment">//è¡¨åæ˜ å°„åˆ°å®ä½“çš„å‘½åç­–ç•¥(ä¸‹åˆ’çº¿åˆ°é©¼å³°)</span>                <span class="hljs-comment">//è¡¨å­—æ®µæ˜ å°„å±æ€§åç­–ç•¥(æœªæŒ‡å®šæŒ‰naming)</span>                .setColumnNaming(NamingStrategy.no_change)                <span class="hljs-comment">//.setTablePrefix("tb_")//è¡¨åå‰ç¼€</span>                <span class="hljs-comment">//.setSuperEntityClass("ä½ è‡ªå·±çš„çˆ¶ç±»å®ä½“,æ²¡æœ‰å°±ä¸ç”¨è®¾ç½®!")</span>                <span class="hljs-comment">//.setSuperEntityColumns("id");//å†™äºçˆ¶ç±»ä¸­çš„å…¬å…±å­—æ®µ</span>                <span class="hljs-comment">//.setSuperControllerClass("è‡ªå®šä¹‰ç»§æ‰¿çš„Controllerç±»å…¨ç§°ï¼Œå¸¦åŒ…å,æ²¡æœ‰å°±ä¸ç”¨è®¾ç½®!")</span>                .setRestControllerStyle(<span class="hljs-keyword">true</span>) <span class="hljs-comment">//ç”Ÿæˆ @RestController æ§åˆ¶å™¨</span>                .setEntityLombokModel(<span class="hljs-keyword">true</span>);<span class="hljs-comment">//ä½¿ç”¨lombok</span>        <span class="hljs-comment">//4ã€åŒ…åç­–ç•¥é…ç½®</span>        PackageConfig packageConfig = <span class="hljs-keyword">new</span> PackageConfig();        packageConfig.setParent(<span class="hljs-string">"com.gukki"</span>)<span class="hljs-comment">//è®¾ç½®åŒ…åçš„parent</span>                .setMapper(<span class="hljs-string">"mapper"</span>)                .setService(<span class="hljs-string">"service"</span>)                .setController(<span class="hljs-string">"controller"</span>)                .setEntity(<span class="hljs-string">"entity"</span>)                .setXml(<span class="hljs-string">"mapper"</span>);<span class="hljs-comment">//è®¾ç½®xmlæ–‡ä»¶çš„ç›®å½•</span>        <span class="hljs-comment">//5ã€æ•´åˆé…ç½®</span>        AutoGenerator autoGenerator = <span class="hljs-keyword">new</span> AutoGenerator();        autoGenerator.setGlobalConfig(config)                .setDataSource(dataSourceConfig)                .setStrategy(strategyConfig)                .setPackageInfo(packageConfig);        <span class="hljs-comment">//6ã€æ‰§è¡Œ</span>        autoGenerator.execute();</code></pre></div><p>æ‰§è¡Œå³å¯è‡ªåŠ¨ç”Ÿæˆä»£ç </p><h2 id="ç¼–å†™jwtå·¥å…·ç±»-jwtutil"><a class="markdownIt-Anchor" href="#ç¼–å†™jwtå·¥å…·ç±»-jwtutil"></a> ç¼–å†™JWTå·¥å…·ç±» JWTUtil</h2><div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Slf</span>4j<span class="hljs-meta">@Component</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JWTUtil</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span> </span>&#123;    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> JWT_TOKEN_VALIDITY = <span class="hljs-number">5</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span>;    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String key = <span class="hljs-string">"imakeytolong"</span>;    <span class="hljs-comment">//ç¬¬äºŒä¸ªå‚æ•°æ„æ€æ˜¯æŒ‡å®šç”¨ä»€ä¹ˆæ–¹æ³•å¤„ç†è¿™æ®µtoken</span>    <span class="hljs-comment">//æ¢è¨€ä¹‹å°±æ˜¯è°ƒç”¨ä»€ä¹ˆæ–¹æ³•å»è·å–è¿™æ®µtokené‡Œé¢çš„å€¼</span>    <span class="hljs-comment">//ç”±Tå†³å®šè¿”å›ç±»å‹</span>    <span class="hljs-comment">//æŒ‡å®šå¥½æ–¹æ³•ï¼ŒæœŸæœ›å°†è¾“å…¥çš„token è½¬æ¢ä¸ºè¾“å‡ºå€¼</span>    <span class="hljs-comment">/*</span><span class="hljs-comment">        çŒœæµ‹resolve.applyç­‰ä»·äºï¼š&#123;claims-&gt;ä¼ å…¥çš„å‡½æ•°ä½“&#125;</span><span class="hljs-comment">        å³ï¼ŒTä¸ºå‡½æ•°çš„è¿”å›ç±»å‹ï¼ŒClaimä¸ºä¼ å…¥çš„å‡½æ•°ç±»å‹ã€‚</span><span class="hljs-comment">     */</span>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; <span class="hljs-function">T <span class="hljs-title">getClaimFromToken</span><span class="hljs-params">(String token, Function&lt;Claims, T&gt; resolve)</span> </span>&#123;        Claims claims = getAllClaims(token);        <span class="hljs-keyword">return</span> resolve.apply(claims);    &#125;    <span class="hljs-comment">//æ³¨æ„ï¼Œè¿™é‡Œè¦ç”¨valueOfæ–¹æ³•ï¼Œæˆ‘åœ¨è¿™é‡Œå‡ºè¿‡ä¸€æ¬¡é—®é¢˜ã€‚</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Long <span class="hljs-title">getUserID</span><span class="hljs-params">(String token)</span></span>&#123;        <span class="hljs-keyword">return</span> Long.valueOf(getClaimFromToken(token,Claims::getId));    &#125;    <span class="hljs-comment">//Get All Claims</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Claims <span class="hljs-title">getAllClaims</span><span class="hljs-params">(String token)</span> </span>&#123;        <span class="hljs-keyword">return</span> Jwts.parser().setSigningKey(key).parseClaimsJws(token).getBody();    &#125;    <span class="hljs-comment">//è·å–JWTçš„è½½è·éƒ¨åˆ†</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">getAClaim</span><span class="hljs-params">(String token,String claimName)</span></span>&#123;        <span class="hljs-keyword">return</span> getAllClaims(token).get(claimName).toString();    &#125;    <span class="hljs-comment">//è·å–ä¸»é¢˜åï¼Œä¹Ÿå°±æ˜¯ç”¨æˆ·å</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">getUserNameFromToken</span><span class="hljs-params">(String token)</span> </span>&#123;        <span class="hljs-keyword">return</span> getClaimFromToken(token, Claims::getSubject);    &#125;    <span class="hljs-comment">//è·å¾—tokenè¿‡æœŸæ—¶é—´</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Date <span class="hljs-title">getExpirationDate</span><span class="hljs-params">(String token)</span> </span>&#123;        <span class="hljs-keyword">return</span> getClaimFromToken(token, Claims::getExpiration);    &#125;    <span class="hljs-comment">//æŸ¥è¯¢token æ˜¯å¦è¿‡æœŸ</span>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Boolean <span class="hljs-title">isExpired</span><span class="hljs-params">(String token)</span> </span>&#123;        Date date = getExpirationDate(token);        <span class="hljs-keyword">return</span> date.before(<span class="hljs-keyword">new</span> Date());    &#125;    <span class="hljs-comment">//ç”Ÿæˆä¸€ä¸²tokenç»™ç”¨æˆ·</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">genKey</span><span class="hljs-params">(SecurityUser details)</span> </span>&#123;        <span class="hljs-keyword">return</span> doGenkey(details);    &#125;    <span class="hljs-comment">//ç”Ÿæˆ</span>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">doGenkey</span><span class="hljs-params">(SecurityUser details)</span> </span>&#123;        System.out.println(details.getId());        <span class="hljs-keyword">return</span> Jwts.builder()                .setId(String.valueOf(details.getId()))                .claim(<span class="hljs-string">"authorities"</span>, JSON.toJSONString(details.getAuthorities()))                .setSubject(details.getUsername())                .setIssuedAt(<span class="hljs-keyword">new</span> Date(System.currentTimeMillis()))                .setExpiration(<span class="hljs-keyword">new</span> Date(System.currentTimeMillis() + JWT_TOKEN_VALIDITY * <span class="hljs-number">100</span>))                .signWith(SignatureAlgorithm.HS256, key).compact();    &#125;    <span class="hljs-comment">//æ ¡éªŒ</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Boolean <span class="hljs-title">verifyToken</span><span class="hljs-params">(String token, UserDetails details)</span> </span>&#123;        <span class="hljs-keyword">final</span> String name = details.getUsername();        <span class="hljs-keyword">return</span> (name.equals(getUserNameFromToken(token)) &amp;&amp; !isExpired(token));    &#125;&#125;</code></pre></div><h2 id="ç¼–å†™è¿”å›ç»“æœç±»-resutil"><a class="markdownIt-Anchor" href="#ç¼–å†™è¿”å›ç»“æœç±»-resutil"></a> ç¼–å†™è¿”å›ç»“æœç±» ResUtil</h2><div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Slf</span>4j<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ResUtil</span> </span>&#123;    <span class="hljs-comment">//è½¬æ¢ä¸ºJSONè¾“å‡º</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ResponseJSON</span><span class="hljs-params">(ServletResponse resp, Map&lt;String, Object&gt; resultMap)</span> </span>&#123;        PrintWriter pw = <span class="hljs-keyword">null</span>;        <span class="hljs-keyword">try</span> &#123;            resp.setCharacterEncoding(<span class="hljs-string">"UTF-8"</span>);            resp.setContentType(<span class="hljs-string">"application/json"</span>);            pw = resp.getWriter();            pw.println(JSON.toJSONString(resultMap));        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;            log.error(e.getMessage());        &#125; <span class="hljs-keyword">finally</span> &#123;            <span class="hljs-keyword">if</span> (pw != <span class="hljs-keyword">null</span>) &#123;                pw.flush();                pw.close();            &#125;        &#125;    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Map&lt;String, Object&gt; <span class="hljs-title">Success</span><span class="hljs-params">()</span> </span>&#123;        Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();        map.put(<span class="hljs-string">"result"</span>, <span class="hljs-string">"Success"</span>);        map.put(<span class="hljs-string">"code"</span>, <span class="hljs-number">200</span>);        <span class="hljs-keyword">return</span> map;    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Map&lt;String, Object&gt; <span class="hljs-title">Fail</span><span class="hljs-params">()</span> </span>&#123;        Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();        map.put(<span class="hljs-string">"result"</span>, <span class="hljs-string">"Fail"</span>);        map.put(<span class="hljs-string">"code"</span>, <span class="hljs-number">500</span>);        <span class="hljs-keyword">return</span> map;    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Map&lt;String, Object&gt; <span class="hljs-title">CustomResult</span><span class="hljs-params">(<span class="hljs-keyword">int</span> code, String msg)</span> </span>&#123;        HashMap&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();        map.put(<span class="hljs-string">"result"</span>, msg);        map.put(<span class="hljs-string">"code"</span>, code);        <span class="hljs-keyword">return</span> map;    &#125;&#125;</code></pre></div><h2 id="ç™»å½•æµç¨‹"><a class="markdownIt-Anchor" href="#ç™»å½•æµç¨‹"></a> ç™»å½•æµç¨‹</h2><h3 id="jsonè®¤è¯å¤„ç†ç±»-jsonauthfilter"><a class="markdownIt-Anchor" href="#jsonè®¤è¯å¤„ç†ç±»-jsonauthfilter"></a> JSONè®¤è¯å¤„ç†ç±» JSONAuthFilter</h3><p>â€‹ä¸ºäº†æ›¿æ¢æ‰è‡ªå¸¦çš„è¡¨å•æäº¤ï¼Œæˆ‘ä»¬éœ€è¦é‡å†™<code>UsernamePasswordAuthenticationFilter</code>ç±»é‡Œçš„<code>attemptAuthentication</code>æ–¹æ³•ã€‚</p><p>æˆ‘åˆ©ç”¨<code>FastJson</code>å°†æäº¤è¿‡æ¥çš„JSONè½¬æ¢ä¸ºä¸€ä¸ªMapï¼Œä»é‡Œé¢æå–åˆ°ç”¨æˆ·åã€å¯†ç ç­‰ä¿¡æ¯ï¼Œç»„è£…æˆä¸€ä¸ªç¬¦åˆSecurityæ ‡å‡†çš„è®¤è¯ç±»å¹¶è¯·æ±‚è®¤è¯ã€‚æ³¨æ„ï¼Œæ­¤æ—¶å¯†ç å’Œç”¨æˆ·åéƒ½æ²¡è®¤è¯ï¼Œæ‰€ä»¥è¿™ä¸ªç”¨æˆ·çš„æƒé™ä¿¡æ¯æ˜¯<code>null</code>ã€‚è¿™äº›é‰´å®šçš„äº‹æƒ…æ˜¯äº¤ç»™æˆ‘è‡ªå®šä¹‰çš„è®¤è¯ç±»å¹²çš„ã€‚</p><div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><span class="hljs-meta">@Slf</span>4j<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JSONAuthFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">UsernamePasswordAuthenticationFilter</span> </span>&#123;    <span class="hljs-meta">@Override</span>    <span class="hljs-meta">@Autowired</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setAuthenticationManager</span><span class="hljs-params">(AuthenticationManager authenticationManager)</span> </span>&#123;        <span class="hljs-keyword">super</span>.setAuthenticationManager(authenticationManager);    &#125;    <span class="hljs-meta">@Autowired</span>    LoginSuccessHandler successHandler;    <span class="hljs-meta">@Autowired</span>    LoginFailureHandler failureHandler;    <span class="hljs-meta">@Autowired</span>    AccessDenied accessDenied;    <span class="hljs-function"><span class="hljs-keyword">public</span> Authentication <span class="hljs-title">attemptAuthentication</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> AuthenticationException </span>&#123;        log.info(<span class="hljs-string">"è¿›å…¥äº†JSONç™»é™†è®¸å¯æ ¡éªŒ"</span>);        <span class="hljs-keyword">if</span> (request.getContentType().equals(MediaType.APPLICATION_JSON_UTF8_VALUE) || request.getContentType().equals(MediaType.APPLICATION_JSON_VALUE)) &#123;            UsernamePasswordAuthenticationToken token = <span class="hljs-keyword">null</span>;            <span class="hljs-keyword">try</span>(InputStream inputStream = request.getInputStream()) &#123;                Map&lt;String,String&gt; map = JSON.parseObject(inputStream, Charset.defaultCharset(),Map<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;                token = <span class="hljs-keyword">new</span> UsernamePasswordAuthenticationToken(map.get(<span class="hljs-string">"username"</span>),map.get(<span class="hljs-string">"password"</span>));                <span class="hljs-comment">//å®šä¹‰å¥½è¿™ä¸ªè¿‡æ»¤å™¨æ‰€å¤„ç†çš„url</span>                setFilterProcessesUrl(<span class="hljs-string">"/login"</span>);                <span class="hljs-comment">//å®šä¹‰å¥½ç™»é™†å¤±è´¥çš„å¤„ç†ç±»</span>                setAuthenticationFailureHandler(failureHandler);                <span class="hljs-comment">//å®šä¹‰å¥½ç™»å½•æˆåŠŸçš„å¤„ç†ç±»ï¼Œè¿™å¾ˆé‡è¦ï¼Œå› ä¸ºæˆ‘è¿™é‡Œè£…é…JWTçš„åœ°æ–¹å°±æ˜¯è¿™ä¸ªå¤„ç†ç±»ã€‚</span>                setAuthenticationSuccessHandler(successHandler);            &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;                logger.error(e.getMessage());                token = <span class="hljs-keyword">new</span> UsernamePasswordAuthenticationToken(<span class="hljs-string">""</span>,<span class="hljs-string">""</span>);            &#125;<span class="hljs-keyword">finally</span> &#123;                setDetails(request,token);                <span class="hljs-comment">//è¯·æ±‚è®¤è¯ï¼Œè¿™å°±è°ƒç”¨äº†æˆ‘çš„è‡ªå®šä¹‰çš„è®¤è¯ç±»ã€‚</span>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.getAuthenticationManager().authenticate(token);            &#125;        &#125;        <span class="hljs-keyword">else</span>&#123;            <span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.attemptAuthentication(request,response);        &#125;    &#125;&#125;</code></pre></div><h3 id="è‡ªå®šä¹‰çš„è®¤è¯ç±»-customauthprovider"><a class="markdownIt-Anchor" href="#è‡ªå®šä¹‰çš„è®¤è¯ç±»-customauthprovider"></a> è‡ªå®šä¹‰çš„è®¤è¯ç±» CustomAuthProvider</h3><p>â€‹å¾—åˆ°ä¸Šé¢ä¼ æ¥çš„ç”¨æˆ·åå’Œå¯†ç ï¼Œæˆ‘ä»¬å°±éœ€è¦ä»æ•°æ®åº“é‡Œé¢æ‹¿åˆ°å¯¹åº”ç”¨æˆ·åçš„ä¸ªäººä¿¡æ¯å¹¶è¿›è¡Œæ¯”å¯¹äº†ï¼ŒåŒ¹é…æˆåŠŸä¹‹åæˆ‘ä»¬å°±å¯ä»¥å»è®¤è¯æˆåŠŸç±»è£…é…JWTäº†ã€‚è‹¥æƒ³å®ç°è‡ªå®šä¹‰è®¤è¯ï¼Œéœ€è¦å®ç°<code>AuthenticationProvider</code>è¿™ä¸ªç±»ä¸‹çš„<code>authenticate</code>æ–¹æ³•</p><div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Slf</span>4j<span class="hljs-meta">@Component</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomAuthProvider</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">AuthenticationProvider</span> </span>&#123;    <span class="hljs-meta">@Autowired</span>    CustomUserDetailService userDetailService;    <span class="hljs-meta">@Autowired</span>    UserRoleService userRoleService;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> Authentication <span class="hljs-title">authenticate</span><span class="hljs-params">(Authentication authentication)</span> <span class="hljs-keyword">throws</span> AuthenticationException </span>&#123;        log.info(<span class="hljs-string">"è¿›å…¥äº†ç™»å½•ç›‘æµ‹"</span>);        String name = (String) authentication.getPrincipal();        String password = (String) authentication.getCredentials();        SecurityUser user = userDetailService.loadUserByUsername(name);        log.info(user.toString());        <span class="hljs-keyword">if</span> (user == <span class="hljs-keyword">null</span>) &#123;            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> UsernameNotFoundException(<span class="hljs-string">"æœªæ‰¾åˆ°ç”¨æˆ·å"</span>);        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">new</span> BCryptPasswordEncoder().matches(password, user.getPassword())) &#123;            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BadCredentialsException(<span class="hljs-string">"å¯†ç é”™è¯¯"</span>);        &#125;        <span class="hljs-comment">// è·å–è§’è‰²åˆ—è¡¨</span>        HashSet&lt;GrantedAuthority&gt; authorities = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();        <span class="hljs-comment">/*</span><span class="hljs-comment">        SELECT</span><span class="hljs-comment">            role.ROLE_ID,</span><span class="hljs-comment">            role.ROLE_NAME</span><span class="hljs-comment">        FROM</span><span class="hljs-comment">            role</span><span class="hljs-comment">                LEFT JOIN</span><span class="hljs-comment">            user_role</span><span class="hljs-comment">            ON</span><span class="hljs-comment">                role.ROLE_ID = user_role.ROLE_ID</span><span class="hljs-comment">        WHERE</span><span class="hljs-comment">            user_role.USER_ID = #&#123;id&#125;</span><span class="hljs-comment">        */</span>        List&lt;Role&gt; list = userRoleService.getRoleByID(user.getId());        <span class="hljs-comment">//Lambda è¡¨è¾¾å¼ å°†è·å–åˆ°çš„è§’è‰²å¤„ç†ä¹‹åæ”¾å…¥ç”¨æˆ·ä¿¡æ¯ä¸­çš„æƒé™ç»„</span>        list.forEach(userRole -&gt; authorities.add(<span class="hljs-keyword">new</span> SimpleGrantedAuthority(<span class="hljs-string">"ROLE_"</span> + userRole.getRoleName())));        user.setAuthorities(authorities);        <span class="hljs-comment">//è®¤è¯æˆåŠŸä¹‹åè¿”å›ä¸€ä¸ªå……æ»¡äº†ç”¨æˆ·ä¿¡æ¯çš„ç±»ï¼Œä»¥åŠä»–æ‰€æœ‰çš„æƒé™ä¿¡æ¯ã€‚</span>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> UsernamePasswordAuthenticationToken(user, <span class="hljs-keyword">null</span>, authorities);    &#125;    <span class="hljs-comment">//å…¶å®è¿™é‡Œå¯ä»¥åšä¸€äº›åˆ¤æ–­ï¼Œåˆ¤æ–­ä¼ å…¥çš„è®¤è¯ç±»æ˜¯å¦è¢«è¿™ä¸ªæ‰€æ”¯æŒã€‚</span>    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">supports</span><span class="hljs-params">(Class&lt;?&gt; authentication)</span> </span>&#123;        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;    &#125;&#125;</code></pre></div><h3 id="è‡ªå®šä¹‰è®¤è¯æˆåŠŸç±»-loginsuccesshandler"><a class="markdownIt-Anchor" href="#è‡ªå®šä¹‰è®¤è¯æˆåŠŸç±»-loginsuccesshandler"></a> è‡ªå®šä¹‰è®¤è¯æˆåŠŸç±» LoginSuccessHandler</h3><p>â€‹è¿™ä¸ªç±»åŠŸèƒ½å¾ˆç®€å•ï¼Œå¦‚æœè®¤è¯æˆåŠŸä¹‹åè®¤è¯ç±»ä¼šä¼ å›ä¸€ä¸ªå……æ»¡ä¸ªäººä¿¡æ¯çš„è®¤è¯ç±»ï¼Œæˆ‘ä»¬å°†è¿™ä¸ªç±»ç»„è£…æˆä¸€ä¸ªJWTï¼Œå¹¶ä¸”è¿”å›ç»™ç”¨æˆ·ã€‚</p><p>è‹¥æƒ³å®ç°è¿™ä¸ªåŠŸèƒ½ï¼Œéœ€å®ç°<code>AuthenticationSuccessHandler</code>ä¸‹çš„<code>onAuthenticationSuccess</code>æ–¹æ³•</p><div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><span class="hljs-meta">@Slf</span>4j<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LoginSuccessHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">AuthenticationSuccessHandler</span> </span>&#123;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onAuthenticationSuccess</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span> <span class="hljs-keyword">throws</span> IOException, ServletException </span>&#123;        SecurityUser user = (SecurityUser) authentication.getPrincipal();        log.info(user.toString());        String token = JWTUtil.genKey(user);        HashMap&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();        map.put(<span class="hljs-string">"token"</span>,token);        ResUtil.ResponseJSON(response,map);    &#125;&#125;</code></pre></div><p>è¿™æ ·çš„è¯ï¼Œç”¨æˆ·å°±èƒ½æ‹¿åˆ°ä»–çš„tokenäº†ã€‚</p><h3 id="æ³¨å†Œåˆ°spring-security-securityconfig"><a class="markdownIt-Anchor" href="#æ³¨å†Œåˆ°spring-security-securityconfig"></a> æ³¨å†Œåˆ°Spring Security SecurityConfig</h3><p>â€‹å†™å®Œè¿™äº›ç±»è¿˜ä¸ç®—å®Œï¼Œéœ€è¦å°†å…¶æ³¨å†Œåˆ°Securityçš„é…ç½®é‡Œé¢å»ã€‚</p><div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Slf</span>4j<span class="hljs-meta">@Configuration</span><span class="hljs-meta">@EnableWebSecurity</span><span class="hljs-meta">@EnableGlobalMethodSecurity</span>(prePostEnabled = <span class="hljs-keyword">true</span>)<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">WebSecurityConfigurerAdapter</span> </span>&#123;    <span class="hljs-meta">@Autowired</span>    JSONAuthFilter filter;    ...    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        ...        http.addFilterAt(filter, UsernamePasswordAuthenticationFilter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;    &#125;&#125;</code></pre></div><p>ç™»å½•çš„æµç¨‹å°±å·®ä¸å¤šäº†ï¼Œå¯ä»¥çœ‹ä¸‹ç»“æœï¼š</p><p><img src="/img/image-20200701180435010.png" srcset="/img/loading.gif" alt="image-20200701180435010" /></p><h2 id="é‰´æƒæµç¨‹"><a class="markdownIt-Anchor" href="#é‰´æƒæµç¨‹"></a> é‰´æƒæµç¨‹</h2><h3 id="tokenè®¤è¯ç±»-jwtauthfilter"><a class="markdownIt-Anchor" href="#tokenè®¤è¯ç±»-jwtauthfilter"></a> Tokenè®¤è¯ç±» JWTAuthFilter</h3><p>â€‹ç”±äºJWTæ˜¯ä¸€ç§æ— çŠ¶æ€çš„åº”ç”¨æˆæƒæ–¹å¼ï¼Œå³ï¼ŒæœåŠ¡å™¨ä¸ä¿å­˜ç”¨æˆ·ä¿¡æ¯ï¼Œè€Œæ˜¯ç”¨æˆ·æ¯æ¬¡è®¿é—®çš„æ—¶å€™éƒ½è¦å¸¦ä¸ŠJWTã€‚æ‰€ä»¥éœ€è¦ä¸€ä¸ªç±»å»è·å–åˆ°è¯·æ±‚å¤´ä¸Šçš„Tokenå¹¶è¿›è¡Œè§£æä¸è®¤è¯ã€‚éœ€è¦ç»§æ‰¿<code>BasicAuthenticationFilter</code>å¹¶é‡å†™<code>doFilterInternal</code>æ–¹æ³•ã€‚</p><div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Slf</span>4j<span class="hljs-comment">//è®¤è¯</span><span class="hljs-comment">//æµç¨‹ï¼šæ£€æŸ¥è¯·æ±‚å¤´æœ‰æ— è®¤è¯ä¿¡æ¯ï¼Œæœ‰-&gt;ä»Tokenä¸­è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œè·å–è§’è‰²ç»„-&gt;ç»„è£…æˆä¸€ä¸ªç”¨æˆ·ä¿¡æ¯ç±»ï¼ˆç»§æ‰¿äº†UserDetailsï¼‰â€”&gt;å°è£…æˆä¸€ä¸ªè®¤è¯ç±»-&gt;æäº¤è‡³å®‰å…¨ä¸Šä¸‹æ–‡ã€‚</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JWTAuthFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BasicAuthenticationFilter</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">JWTAuthFilter</span><span class="hljs-params">(AuthenticationManager manager)</span> </span>&#123;        <span class="hljs-keyword">super</span>(manager);    &#125;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doFilterInternal</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)</span> <span class="hljs-keyword">throws</span> ServletException, IOException </span>&#123;        log.info(<span class="hljs-string">"è¿›å…¥äº†Tokenè®¤è¯"</span>);        String header = request.getHeader(<span class="hljs-string">"Authorization"</span>);        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">null</span> != header &amp;&amp; header.startsWith(<span class="hljs-string">"Bearer "</span>)) &#123;            String token = header.substring(<span class="hljs-number">7</span>);            <span class="hljs-comment">//Get name</span>            String name = JWTUtil.getUserNameFromToken(token);            <span class="hljs-comment">//Get ID</span>            Long ID = JWTUtil.getUserID(token);            <span class="hljs-comment">//è·å–è§’è‰²</span>            <span class="hljs-keyword">if</span> (!name.isEmpty() &amp;&amp; (ID != <span class="hljs-keyword">null</span>)) &#123;                <span class="hljs-keyword">try</span> &#123;                    List&lt;GrantedAuthority&gt; authorityList = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();                    String authority = JWTUtil.getAClaim(token, <span class="hljs-string">"authorities"</span>);                    <span class="hljs-keyword">if</span> (!authority.isEmpty()) &#123;                        <span class="hljs-comment">//[&#123;"authority":"ROLE_USER"&#125;,&#123;"authority":"ROLE_ADMIN"&#125;]</span>                        List&lt;Map&lt;String, String&gt;&gt; authorityMap = JSONObject.parseObject(authority, List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;                        <span class="hljs-keyword">for</span> (Map&lt;String, String&gt; map : authorityMap) &#123;                            <span class="hljs-keyword">if</span> (!map.isEmpty()) &#123;                                authorityList.add(<span class="hljs-keyword">new</span> SimpleGrantedAuthority(map.get(<span class="hljs-string">"authority"</span>)));                            &#125;                        &#125;                        SecurityUser user = <span class="hljs-keyword">new</span> SecurityUser(ID, name, authorityList);                        UsernamePasswordAuthenticationToken token1 = <span class="hljs-keyword">new</span> UsernamePasswordAuthenticationToken(user, <span class="hljs-keyword">null</span>, authorityList);                        <span class="hljs-comment">//ä¿å­˜åˆ°å®‰å…¨ä¸Šä¸‹æ–‡ï¼Œç­‰ä¼šé‰´æƒæ—¶ç”¨åˆ°ã€‚</span>                        SecurityContextHolder.getContext().setAuthentication(token1);                    &#125;                &#125; <span class="hljs-keyword">catch</span> (ExpiredJwtException e) &#123;                    logger.error(e.getMessage());                &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;                    logger.error(e.getMessage());                &#125;            &#125;        &#125;        filterChain.doFilter(request, response);    &#125;&#125;</code></pre></div><h3 id="æ³¨å†Œåˆ°spring-security"><a class="markdownIt-Anchor" href="#æ³¨å†Œåˆ°spring-security"></a> æ³¨å†Œåˆ°Spring Security</h3><div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Slf</span>4j<span class="hljs-meta">@Configuration</span><span class="hljs-meta">@EnableWebSecurity</span><span class="hljs-meta">@EnableGlobalMethodSecurity</span>(prePostEnabled = <span class="hljs-keyword">true</span>)<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">WebSecurityConfigurerAdapter</span> </span>&#123;    ...    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        ...        http.addFilter(<span class="hljs-keyword">new</span> JWTAuthFilter(authenticationManager()));    &#125;&#125;</code></pre></div><p>ä¸€èˆ¬æ¥è®²ï¼Œå¦‚æœæ˜¯ä»¥è§’è‰²(<code>hasRole</code>)æ¥åˆ¤æ–­èƒ½å¦è®¿é—®èµ„æºçš„è¯ï¼ˆå°±åƒä¸‹é¢çš„ä¸€æ ·ï¼‰ï¼Œåˆ°è¿™é‡Œå°±ç»“æŸäº†</p><div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@PreAuthorize</span>(<span class="hljs-string">"hasRole('admin')"</span>)    <span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/admin"</span>)    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">test</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-keyword">return</span> <span class="hljs-string">"Success"</span>;    &#125;</code></pre></div><p>ä½†æ˜¯æœ‰æ—¶äº‹æƒ…å¹¶æ²¡æœ‰é‚£ä¹ˆç®€å•ï¼Œæ¯”å¦‚å¤šäººåˆä½œçš„ä¸€ä»½æ–‡æ¡£ï¼Œæœ‰äººå¯ä»¥ç¼–è¾‘ï¼Œæœ‰äººå¯ä»¥åˆ é™¤ï¼Œæœ‰äººåªå¯ä»¥æŸ¥çœ‹ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦æŠŠæƒé™æ§åˆ¶çš„ç²’åº¦ç»†åŒ–ä¸€äº›ã€‚ä¹Ÿå°±æ˜¯è¯´ä»€ä¹ˆäººå¯ä»¥å¹²ä»€ä¹ˆäº‹æƒ…ä¹‹ç±»çš„ï¼Œä½†æ˜¯æˆ‘è¿™é‡Œ<strong>æ²¡è¿™æ ·å†™</strong>ï¼Œ<s>åªèƒ½ç­‰ä»¥åäº†</s>ã€‚åªå†™äº†ä¸€ä¸ªä»€ä¹ˆè§’è‰²å¯¹æœ‰ç€ä»€ä¹ˆæ“ä½œæƒé™ï¼Œå¯¹äºä¸€ä¸ªå·²ç»é™å®šå¥½æ“ä½œæƒé™çš„èµ„æºï¼Œä¸ç®¡ä½ çš„è§’è‰²æ˜¯ä»€ä¹ˆï¼Œåªè¦ä½ æœ‰å®ƒæ‰€è¦æ±‚çš„æƒé™å°±å¯ä»¥å¯¹ä»–æ“ä½œäº†ã€‚</p><h3 id="è‡ªå®šä¹‰æƒé™æ¯”è¾ƒå™¨-customevaluator"><a class="markdownIt-Anchor" href="#è‡ªå®šä¹‰æƒé™æ¯”è¾ƒå™¨-customevaluator"></a> è‡ªå®šä¹‰æƒé™æ¯”è¾ƒå™¨ CustomEvaluator</h3><p>â€‹éœ€è¦å®ç°<code>PermissionEvaluator</code>ä¸‹çš„<code>hasPermission</code>æ–¹æ³•</p><div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Slf</span>4j<span class="hljs-meta">@Component</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomEvaluator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">PermissionEvaluator</span> </span>&#123;    <span class="hljs-meta">@Autowired</span>    PermissionRoleService service;    <span class="hljs-comment">//authentication ä¼šè‡ªåŠ¨ä¼ è¿›å»çš„ã€‚</span>    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">hasPermission</span><span class="hljs-params">(Authentication authentication, Object targetDomainObject, Object permission)</span> </span>&#123;        SecurityUser user = (SecurityUser) authentication.getPrincipal();        Collection&lt;? extends GrantedAuthority&gt; authorities = user.getAuthorities();        Set&lt;String&gt; permissions = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();        List&lt;Permission&gt; permissionList = service.getPremissionByID(user.getId());        permissionList.forEach(item -&gt; &#123;permissions.add(item.getPermission());&#125;);        <span class="hljs-keyword">if</span>(permissions.contains(permission.toString())) <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;    &#125;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">hasPermission</span><span class="hljs-params">(Authentication authentication, Serializable targetId, String targetType, Object permission)</span> </span>&#123;        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;    &#125;&#125;</code></pre></div><p>å¯¹äºï¼š</p><div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@PreAuthorize</span>(<span class="hljs-string">"hasPermission('/user/user','view:edit')"</span>)    <span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/user"</span>)    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">user</span><span class="hljs-params">()</span></span>&#123;        <span class="hljs-keyword">return</span> <span class="hljs-string">"User Success"</span>;    &#125;</code></pre></div><p>è¿™ç§å½¢å¼çš„çš„ï¼Œåªè¦ä½ çš„æƒé™é‡Œé¢æœ‰<code>view:edit</code>è¿™ä¸¤ä¸ªæƒé™ï¼Œéƒ½å¯ä»¥è®¿é—®è¿™ä¸ªé“¾æ¥ã€‚</p><p>-å¤§æ¦‚å°±ç»“æŸäº†ï¼Ÿ</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¯¹Securityå’ŒJWTçš„æµç¨‹æœ‰äº†ä¸€å®šè®¤è¯†ä¹‹åå†™çš„ä¸€ä¸ªDemo&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="JavaWeb" scheme="http://yoursite.com/tags/JavaWeb/"/>
    
  </entry>
  
  <entry>
    <title>JWTå­¦ä¹ </title>
    <link href="http://yoursite.com/p/cec8f3e6.html"/>
    <id>http://yoursite.com/p/cec8f3e6.html</id>
    <published>2020-06-29T14:39:37.000Z</published>
    <updated>2020-07-09T18:47:59.392Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸€ä¸ªæ–°æ‰‹å¯¹äºJWTçš„è®¤è¯†</p><a id="more"></a><h1 id="jwt-å­¦ä¹ "><a class="markdownIt-Anchor" href="#jwt-å­¦ä¹ "></a> JWT å­¦ä¹ </h1><h2 id="1-æ¦‚å¿µ"><a class="markdownIt-Anchor" href="#1-æ¦‚å¿µ"></a> 1ã€æ¦‚å¿µ</h2><p>â€‹ JWT(Jason Web Token)æŒ‰ç…§æˆ‘ä¸ªäººç†è§£ï¼Œæ˜¯ä¸€ä¸²æœåŠ¡ç«¯æŒ‰ç…§ç‰¹å®šçš„åŠ å¯†ç®—æ³•ç”Ÿæˆçš„å­—ç¬¦ä¸²ã€‚</p><p>â€‹åœ¨ç”¨æˆ·ç™»å½•æˆåŠŸä¹‹åï¼ŒæœåŠ¡å™¨å°†ç”¨æˆ·çš„ä¸ªäººä¿¡æ¯åŠ å¯†å¹¶ç­¾åæˆä¸€ä¸²å­—ç¬¦ä¸²å‘é€å›ç”¨æˆ·æµè§ˆå™¨ï¼Œåœ¨æ¯æ¬¡è®¿é—®å—æƒé™æ§åˆ¶çš„ç½‘é¡µçš„æ—¶å€™å°†è¿™ä¸²å­—ç¬¦ä¸²å‘å›ç»™æœåŠ¡å™¨ï¼Œç”¨äºè¯æ˜â€œä½ è¿˜æ˜¯ä½ â€ã€‚ç„¶åæœåŠ¡ç«¯å¯ä»¥è§£å¯†è¿™ä¸²å­—ç¬¦ä¸²ï¼Œä»é‡Œé¢æ‹¿åˆ°ç”¨æˆ·çš„ç›¸å…³ä¿¡æ¯ï¼Œå¹¶åˆ¤æ–­ç”¨æˆ·æœ‰æ— æƒé™è®¿é—®æ­¤é¡µé¢ã€‚</p><p>â€‹ç»¿å°èçš„å¼€å‘ä¸­ï¼Œæˆ‘ä»¬é‡‡ç”¨äº†ä¼ ç»Ÿçš„sessionæ¥è®°å½•ç”¨æˆ·ä¿¡æ¯ï¼Œè¿™æ ·åœ¨æœ¬åœ°æˆ–è€…è¯´å•æœºå¼€å‘æ˜¯æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ã€‚ä½†æ˜¯ä¸€æ—¦å‡ºç°å‰åç«¯åˆ†åˆ«å¤„äºä¸åŒçš„æœåŠ¡å™¨é‡Œï¼Œäº§ç”Ÿäº†è·¨åŸŸçš„é—®é¢˜ï¼Œè¿™æ ·çš„è¯sessionå°±æ¯”è¾ƒéš¾å¤„ç†äº†ã€‚</p><p>â€‹é‡‡ç”¨JWTçš„è¯ï¼ŒæœåŠ¡å™¨ä¸ä¿å­˜ç”¨æˆ·çš„sessionï¼Œåªå‡­JWTé‡Œé¢çš„ä¿¡æ¯æ¥é‰´åˆ«ç”¨æˆ·ï¼Œè¿™æ ·çš„è¯ï¼Œè·¨åŸŸå°±å˜å¾—å¾ˆç®€å•äº†ã€‚</p><p>â€‹JWTè¿™ä¸ªå­—ç¬¦ä¸²ç”±ä¸‰ä¸ªç»“æ„ç»„æˆ</p><blockquote><ul><li>å¤´éƒ¨(Header)</li><li>â€œalgâ€ åŠ å¯†ç±»å‹</li><li>â€œtypâ€ è¿™ä¸²tokençš„ç±»å‹ï¼Œè‡ªç„¶æ˜¯JWT</li><li>è½½è·(PayLoad)</li><li>å¯è‡ªå®šä¹‰ï¼Œé‡‡ç”¨é”®å€¼å¯¹çš„æ–¹å¼</li><li>ç­¾å</li><li>ä¸æœåŠ¡ç«¯æŒ‡å®šçš„å¯†åŒ™æœ‰å…³</li></ul></blockquote><p>â€‹é™„ï¼šæˆ‘ä»¬ä½¿ç”¨çš„sessionè®¤è¯æµç¨‹ï¼š</p><blockquote><ol><li>ç”¨æˆ·ç™»å½•ï¼Œå‘é€ç”¨æˆ·åå’Œå¯†ç åˆ°åå°</li><li>åå°éªŒè¯é€šè¿‡ä¹‹åï¼Œå°†ä»æ•°æ®åº“å–å‡ºæ¥çš„ç”¨æˆ·ä¿¡æ¯ä¿å­˜åˆ°sessioné‡Œ</li><li>åå°å‘ç”¨æˆ·æµè§ˆå™¨è¿”å›ä¸€ä¸ªsession_idï¼Œå†™å…¥æµè§ˆå™¨çš„cookieé‡Œã€‚</li><li>ä¹‹åçš„æ¯ä¸€ä¸ªè¯·æ±‚ï¼Œéƒ½ä¼šå°†cookieé‡Œé¢çš„session_idå‘é€å›åå°</li><li>åå°é€šè¿‡å‰å°ä¼ æ¥çš„session_idï¼Œæ‰¾åˆ°ä¿å­˜èµ·æ¥çš„sessionï¼Œå¹¶ä»é‡Œé¢å–å¾—ç”¨æˆ·ä¿¡æ¯ã€‚</li></ol></blockquote><h2 id="2-å°è¯•ç‰›åˆ€"><a class="markdownIt-Anchor" href="#2-å°è¯•ç‰›åˆ€"></a> 2ã€å°è¯•ç‰›åˆ€</h2><p>â€‹ç½‘ä¸Šæ‰¾äº†ä¸ªæ•™ç¨‹ï¼Œè®²çš„å¾ˆå¥½ï¼Œæˆ‘æ¨¡ä»¿ä»–çš„ä¾‹å­ï¼ŒåŠ ä¸Šäº†è‡ªå·±ç†è§£çš„æ³¨é‡Šï¼š</p><div class="hljs"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">contextLoads</span><span class="hljs-params">()</span> </span>&#123;        String s = genToken();        verifyToken(s);    &#125;<span class="hljs-comment">//ç”ŸæˆJWT</span>    <span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">genToken</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-comment">//å…ˆç”Ÿæˆtokenï¼Œé¢„è®¾å¥½ä¸€ä¸ªKey</span>        String secret = <span class="hljs-string">"imkey"</span>;        <span class="hljs-comment">//åŠ å¯†</span>        Algorithm algorithm = Algorithm.HMAC256(secret);        <span class="hljs-comment">//è®¾ç½®å¤´éƒ¨ä¿¡æ¯</span>        <span class="hljs-comment">//ä¹Ÿå°±æ˜¯åŠ å¯†ç®—æ³•ç±»å‹ä»¥åŠtokenç±»å‹</span>        Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();        map.put(<span class="hljs-string">"alg"</span>, <span class="hljs-string">"HS256"</span>);        map.put(<span class="hljs-string">"typ"</span>, <span class="hljs-string">"JWT"</span>);        <span class="hljs-comment">//è®¾ç½®è½½è·ï¼ˆpayloadï¼‰</span>        String token = JWT.create()                <span class="hljs-comment">//å®šä¹‰å¤´éƒ¨</span>                .withHeader(map)                <span class="hljs-comment">//è‡ªå®šä¹‰è½½è·</span>                .withClaim(<span class="hljs-string">"name"</span>, <span class="hljs-string">"æä¸€"</span>)                <span class="hljs-comment">//å®šä¹‰ä¸»é¢˜</span>                .withSubject(<span class="hljs-string">"ä¸€ä¸ªtoken"</span>)                <span class="hljs-comment">//ç­¾åå¤´éƒ¨</span>                .sign(algorithm);        <span class="hljs-keyword">return</span> token;    &#125;<span class="hljs-comment">//æ ¡éªŒJWT</span>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">verifyToken</span><span class="hljs-params">(String token)</span></span>&#123;        <span class="hljs-comment">//å®šä¹‰åŠ å¯†ç±»å‹</span>        Algorithm algorithm = Algorithm.HMAC256(<span class="hljs-string">"imkey"</span>);        <span class="hljs-comment">//è·å–è¿™ç§ç®—æ³•çš„å¯¹åº”çš„è§£å¯†ï¼ˆæ ¡éªŒï¼‰å¯¹è±¡</span>        JWTVerifier require = JWT.require(algorithm)                .build();        System.out.println(require);        <span class="hljs-comment">//è§£å¯†</span>        DecodedJWT decodedJWT = require.verify(token);        <span class="hljs-comment">//è·å–è½½è·é‡Œé¢çš„å€¼</span>        Claim claim = decodedJWT.getClaim(<span class="hljs-string">"name"</span>);        System.out.println(claim);        <span class="hljs-comment">//è¾“å‡ºè½½è·çš„å€¼</span>        System.out.println(claim.asString());    &#125;</code></pre></div><p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p><p><img src="/img/image-20200626083111707-1593413542002.png" srcset="/img/loading.gif" alt="image-20200626083111707" /></p><p>æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚</p><h2 id="3-ä½¿ç”¨ajaxå‘é€ç”¨æˆ·ä¿¡æ¯å¹¶è¿›è¡Œç™»å½•è®¤è¯çš„jwtåº”ç”¨"><a class="markdownIt-Anchor" href="#3-ä½¿ç”¨ajaxå‘é€ç”¨æˆ·ä¿¡æ¯å¹¶è¿›è¡Œç™»å½•è®¤è¯çš„jwtåº”ç”¨"></a> 3ã€ä½¿ç”¨ajaxå‘é€ç”¨æˆ·ä¿¡æ¯å¹¶è¿›è¡Œç™»å½•è®¤è¯çš„JWTåº”ç”¨</h2><p>â€‹é¡¹ç›®ç»“æ„å¦‚ä¸‹æ‰€ç¤º</p><p><img src="/img/image-20200626122914327.png" srcset="/img/loading.gif" alt="image-20200626122914327" /></p><p>æµç¨‹å›¾ï¼ˆ<a href="https://www.cnblogs.com/fishpro/p/spring-boot-study-securing-jwt.html" target="_blank" rel="noopener">å¼•ç”¨äº†ä¸€ä¸ªå¤§ä½¬çš„å›¾</a>ï¼Œè¯¦æƒ…è¯·è§æœ¬ç« æœ«å°¾ï¼‰</p><p><img src="/img/o_jwt2.jpg" srcset="/img/loading.gif" alt="o_jwt2" /></p><p><img src="/img/o_jwt3.jpg" srcset="/img/loading.gif" alt="o_jwt3" /></p><p><img src="/img/o_jwt4.jpg" srcset="/img/loading.gif" alt="o_jwt4" /></p><p><strong>JwtAuthenticationController</strong></p><div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * ç”¨äºéªŒè¯ jwt è¿”å›å®¢æˆ·ç«¯ jwtï¼ˆjson web tokenï¼‰</span><span class="hljs-comment"> * */</span><span class="hljs-meta">@RestController</span><span class="hljs-meta">@CrossOrigin</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JwtAuthenticationController</span> </span>&#123;    <span class="hljs-meta">@Autowired</span>    <span class="hljs-keyword">private</span> AuthenticationManager authenticationManager;    <span class="hljs-meta">@Autowired</span>    <span class="hljs-keyword">private</span> JwtTokenUtil jwtTokenUtil;    <span class="hljs-meta">@Autowired</span>    <span class="hljs-keyword">private</span> JwtUserDetailsService userDetailsService;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * è·å– å®¢æˆ·ç«¯æ¥çš„ username password ä½¿ç”¨ç§˜é’¥åŠ å¯†æˆ json web token</span><span class="hljs-comment">     * */</span>    <span class="hljs-meta">@RequestMapping</span>(value = <span class="hljs-string">"/authenticate"</span>, method = RequestMethod.POST)    <span class="hljs-keyword">public</span> ResponseEntity&lt;?&gt; createAuthenticationToken(<span class="hljs-meta">@RequestBody</span> JwtRequest authenticationRequest) <span class="hljs-keyword">throws</span> Exception &#123;        <span class="hljs-comment">//è·å–å‰å°ä¼ æ¥çš„æ˜æ–‡è´¦å·å¯†ç å¹¶è¿›è¡Œè®¤è¯</span>        authenticate(authenticationRequest.getUsername(), authenticationRequest.getPassword());        <span class="hljs-comment">//è®¤è¯æ“ä½œæˆåŠŸåï¼Œä»¥ä¸‹çš„è¯­å¥æ‰ä¼šæ‰§è¡Œ</span>        <span class="hljs-comment">//è·å–ç”¨æˆ·ä¿¡æ¯</span>        <span class="hljs-keyword">final</span> UserDetails userDetails = userDetailsService                .loadUserByUsername(authenticationRequest.getUsername());        <span class="hljs-comment">//ç”Ÿæˆtoken</span>        <span class="hljs-keyword">final</span> String token = jwtTokenUtil.generateToken(userDetails);        <span class="hljs-comment">//å‘å‰å°è¿”å›åºåˆ—åŒ–åçš„token</span>        <span class="hljs-keyword">return</span> ResponseEntity.ok(<span class="hljs-keyword">new</span> JwtResponse(token));    &#125;    <span class="hljs-comment">/**</span><span class="hljs-comment">     *  è·å– å®¢æˆ·ç«¯æ¥çš„ username password ä½¿ç”¨ç§˜é’¥åŠ å¯†æˆ json web token</span><span class="hljs-comment">     * */</span>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">authenticate</span><span class="hljs-params">(String username, String password)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        <span class="hljs-keyword">try</span> &#123;            <span class="hljs-comment">//åˆ›å»ºä¸€ä¸ªæ²¡æœ‰è®¤è¯çš„tokenå®ä¾‹ï¼Œæ­¤æ—¶â€œæ˜¯å¦èº«ä»½è®¤è¯è¿‡â€å±æ€§ä¸ºfalse</span>            <span class="hljs-comment">//ç”±äºæ­¤æ—¶æœªè¿›è¡Œèº«ä»½è®¤è¯ï¼Œæ‰€ä»¥ä»–çš„æƒé™æœªçŸ¥</span>            <span class="hljs-comment">//è®¤è¯ä¿¡æ¯ç®¡ç†ï¼ˆauthenticationManagerï¼‰ï¼Œä»æŒ‡å®šçš„ç”¨æˆ·æ•°æ®æºåŠ è½½ç”¨æˆ·ä¿¡æ¯</span>            <span class="hljs-comment">//ç„¶åä½¿ç”¨çº¦å®šå¥½çš„åŠ å¯†æ–¹å¼ï¼Œè¿›è¡Œè®¤è¯ã€‚</span>            <span class="hljs-comment">//è®¤è¯å¤±è´¥ä¹‹åï¼Œç›´æ¥è¿”å›ç»™å‰å°401</span>            authenticationManager.authenticate(<span class="hljs-keyword">new</span> UsernamePasswordAuthenticationToken(username, password));        &#125; <span class="hljs-keyword">catch</span> (DisabledException e) &#123;            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Exception(<span class="hljs-string">"USER_DISABLED"</span>, e);        &#125; <span class="hljs-keyword">catch</span> (BadCredentialsException e) &#123;            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Exception(<span class="hljs-string">"INVALID_CREDENTIALS"</span>, e);        &#125;    &#125;&#125;</code></pre></div><p><strong>JwtAuthenticationEntryPoint</strong></p><div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * AuthenticationEntryPoint ç”¨æ¥è§£å†³åŒ¿åç”¨æˆ·è®¿é—®æ— æƒé™èµ„æºæ—¶çš„å¼‚å¸¸</span><span class="hljs-comment"> * AccessDeineHandler ç”¨æ¥è§£å†³è®¤è¯è¿‡çš„ç”¨æˆ·è®¿é—®æ— æƒé™èµ„æºæ—¶çš„å¼‚å¸¸</span><span class="hljs-comment"> * */</span><span class="hljs-meta">@Component</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JwtAuthenticationEntryPoint</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">AuthenticationEntryPoint</span>, <span class="hljs-title">Serializable</span> </span>&#123;    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> serialVersionUID = -<span class="hljs-number">7858869558953243875L</span>;    <span class="hljs-comment">//å½“å‡ºé”™çš„æ—¶å€™ å‘é€ Unauthorized</span>    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">commence</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response,</span></span><span class="hljs-function"><span class="hljs-params">                         AuthenticationException authException)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;        response.sendError(HttpServletResponse.SC_UNAUTHORIZED, <span class="hljs-string">"Unauthorized"</span>);    &#125;&#125;</code></pre></div><p><strong>JwtRequestFilter</strong></p><div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * è¿‡æ»¤å™¨ ç”¨äº Spring Boot Security</span><span class="hljs-comment"> * OncePerRequestFilter ä¸€æ¬¡è¯·æ±‚åªé€šè¿‡ä¸€æ¬¡filterï¼Œè€Œä¸éœ€è¦é‡å¤æ‰§è¡Œ</span><span class="hljs-comment"> * */</span><span class="hljs-meta">@Component</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JwtRequestFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">OncePerRequestFilter</span> </span>&#123;    <span class="hljs-meta">@Autowired</span>    <span class="hljs-keyword">private</span> JwtUserDetailsService jwtUserDetailsService;    <span class="hljs-meta">@Autowired</span>    <span class="hljs-keyword">private</span> JwtTokenUtil jwtTokenUtil;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doFilterInternal</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain)</span></span><span class="hljs-function">            <span class="hljs-keyword">throws</span> ServletException, IOException </span>&#123;        <span class="hljs-comment">//è·å¾—è¯·æ±‚å¤´</span>        <span class="hljs-keyword">final</span> String requestTokenHeader = request.getHeader(<span class="hljs-string">"Authorization"</span>);        String username = <span class="hljs-keyword">null</span>;        String jwtToken = <span class="hljs-keyword">null</span>;        <span class="hljs-comment">// JWT Token è·å–è¯·æ±‚å¤´éƒ¨çš„ Bearer</span>        <span class="hljs-comment">// only the Token</span>        <span class="hljs-keyword">if</span> (requestTokenHeader != <span class="hljs-keyword">null</span> &amp;&amp; requestTokenHeader.startsWith(<span class="hljs-string">"Bearer "</span>)) &#123;            jwtToken = requestTokenHeader.substring(<span class="hljs-number">7</span>);            <span class="hljs-keyword">try</span> &#123;                <span class="hljs-comment">//ä»tokené‡Œè·å–ç”¨æˆ·å</span>                username = jwtTokenUtil.getUsernameFromToken(jwtToken);            &#125; <span class="hljs-keyword">catch</span> (IllegalArgumentException e) &#123;                System.out.println(<span class="hljs-string">"Unable to get JWT Token"</span>);            &#125; <span class="hljs-keyword">catch</span> (ExpiredJwtException e) &#123;                System.out.println(<span class="hljs-string">"JWT Token has expired"</span>);            &#125;        &#125; <span class="hljs-keyword">else</span> &#123;            logger.warn(<span class="hljs-string">"JWT Token does not begin with Bearer String"</span>);        &#125;        <span class="hljs-comment">// éªŒè¯</span>        <span class="hljs-keyword">if</span> (username != <span class="hljs-keyword">null</span> &amp;&amp; SecurityContextHolder.getContext().getAuthentication() == <span class="hljs-keyword">null</span>) &#123;            <span class="hljs-comment">//æˆ‘çŒœï¼Œä¹‹æ‰€ä»¥è¦åœ¨è¿™é‡Œå†æ ¡éªŒä¸€æ¬¡ç”¨æˆ·åï¼Œæ˜¯é˜²æ­¢ä¸Šé¢çš„å¼‚å¸¸æŠ›å‡ºçš„åï¼Œusernameä¸ºç©ºçš„æƒ…å†µã€‚</span>            <span class="hljs-comment">//è·å–ç”¨æˆ·çš„åœ¨åå°ä¿å­˜çš„è´¦å·å¯†ç ï¼Œå°è£…æˆä¸€ä¸ªå¯¹è±¡ï¼Œé€šè¿‡æŸ¥è¯¢ç”¨æˆ·åçš„æ–¹å¼</span>            UserDetails userDetails = <span class="hljs-keyword">this</span>.jwtUserDetailsService.loadUserByUsername(username);            <span class="hljs-comment">// JWT éªŒè¯é€šè¿‡ ä½¿ç”¨Spring Security ç®¡ç†</span>            <span class="hljs-comment">//å°†tokené‡Œé¢çš„ç”¨æˆ·åå’Œä¿å­˜çš„å¯¹è±¡è¿›è¡Œæ ¡éªŒ</span>            <span class="hljs-keyword">if</span> (jwtTokenUtil.validateToken(jwtToken, userDetails)) &#123;                <span class="hljs-comment">//ä¼ å…¥ç”¨æˆ·ä¿¡æ¯ï¼Œ</span>                UsernamePasswordAuthenticationToken usernamePasswordAuthenticationToken = <span class="hljs-keyword">new</span> UsernamePasswordAuthenticationToken(                        userDetails, <span class="hljs-keyword">null</span>, userDetails.getAuthorities());                usernamePasswordAuthenticationToken                        .setDetails(<span class="hljs-keyword">new</span> WebAuthenticationDetailsSource().buildDetails(request));                <span class="hljs-comment">// After setting the Authentication in the context, we specify</span>                <span class="hljs-comment">// that the current user is authenticated. So it passes the</span>                <span class="hljs-comment">// Spring Security Configurations successfully.</span>                SecurityContextHolder.getContext().setAuthentication(usernamePasswordAuthenticationToken);            &#125;        &#125;        <span class="hljs-comment">//æ²¡æœ‰tokenï¼Œåˆ™è·‘å»jwtcontroller</span>        chain.doFilter(request, response);    &#125;&#125;</code></pre></div><p><strong>JwtUserDetailsService</strong></p><div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">//ç”¨æˆ·ä¿¡æ¯æ¥æº</span><span class="hljs-meta">@Service</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JwtUserDetailsService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UserDetailsService</span> </span>&#123;<span class="hljs-comment">//é€šè¿‡ç”¨æˆ·ååŠ è½½</span>    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> UserDetails <span class="hljs-title">loadUserByUsername</span><span class="hljs-params">(String username)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException </span>&#123;        <span class="hljs-keyword">if</span> (<span class="hljs-string">"javainuse"</span>.equals(username)) &#123;            <span class="hljs-comment">//æ–°å»ºä¸€ä¸ªç”¨æˆ·åä¸ºï¼šjavainuseçš„ç”¨æˆ·ï¼Œå¯†ç ä¸ºç”¨BCåŠ å¯†çš„password,åé¢çš„æ•°ç»„æ˜¯è¿™ä¸ªç”¨æˆ·çš„æƒé™åˆ—è¡¨ï¼Œç›®å‰ä¸ºç©ºã€‚</span>            <span class="hljs-comment">//BCåŠ å¯†åçš„å­—ç¬¦ä¸²æœ‰ç€å®ƒç‰¹æ®Šçš„æ„æ€ï¼Œå‰é¢çš„2aè¡¨ç¤ºä½¿ç”¨äº†bcåŠ å¯†ï¼Œåé¢çš„10è¡¨ç¤ºå®ƒhashäº†10æ¬¡</span>            <span class="hljs-comment">//ç„¶åä»ç¬¬ä¸‰ä¸ª$å¼€å§‹ç®—èµ·çš„21ä¸ªå­—ç¬¦éƒ½æ˜¯å®ƒçš„saltï¼Œç”¨äºæ··æ·†ç”¨çš„</span>            <span class="hljs-comment">//åé¢çš„å…¨éƒ½æ˜¯å¯†æ–‡å¯†ç å’Œslat hash10æ¬¡ä¹‹åçš„å¯†æ–‡</span>            <span class="hljs-comment">//å¦‚ä½•æ ¡éªŒï¼Ÿ</span>            <span class="hljs-comment">//è·å¾—å‰å°ä¼ æ¥çš„æ˜æ–‡å¯†ç ï¼Œå–å‚¨å­˜å¥½çš„BCåŠ å¯†åçš„å­—ç¬¦ä¸²ï¼Œå–å…¶ä¸­çš„ç›ï¼Œhash10æ¬¡ä¹‹åï¼Œå’Œå¯†æ–‡è¿›è¡ŒåŒ¹é…ã€‚</span>            <span class="hljs-comment">//è¿”å›ç”¨æˆ·çš„ç”¨æˆ·åã€BCåŠ å¯†åçš„å¯†ç ã€ä»¥åŠæƒé™åˆ—è¡¨ã€‚</span>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> User(<span class="hljs-string">"javainuse"</span>, <span class="hljs-string">"$2a$10$slYQmyNdGzTn7ZLBXBChFOC9f6kFjAqPhccnP6DxlWXx2lPk1C3G6"</span>,                    <span class="hljs-keyword">new</span> ArrayList&lt;&gt;());        &#125; <span class="hljs-keyword">else</span> &#123;            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> UsernameNotFoundException(<span class="hljs-string">"User not found with username: "</span> + username);        &#125;    &#125;&#125;</code></pre></div><p><strong>WebSecurityConfig</strong></p><div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><span class="hljs-meta">@EnableWebSecurity</span><span class="hljs-meta">@EnableGlobalMethodSecurity</span>(prePostEnabled = <span class="hljs-keyword">true</span>)<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebSecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">WebSecurityConfigurerAdapter</span> </span>&#123;    <span class="hljs-meta">@Autowired</span>    <span class="hljs-keyword">private</span> JwtAuthenticationEntryPoint jwtAuthenticationEntryPoint;    <span class="hljs-meta">@Autowired</span>    <span class="hljs-keyword">private</span> UserDetailsService jwtUserDetailsService;    <span class="hljs-meta">@Autowired</span>    <span class="hljs-keyword">private</span> JwtRequestFilter jwtRequestFilter;    <span class="hljs-meta">@Autowired</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configureGlobal</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        <span class="hljs-comment">// configure AuthenticationManager so that it knows from where to load</span>        <span class="hljs-comment">// user for matching credentials</span>        <span class="hljs-comment">// Use BCryptPasswordEncoder</span>        <span class="hljs-comment">//é…ç½®ç”¨äºç”¨æˆ·ä¿¡æ¯æ¥æºï¼Œå¹¶è®¾ç½®å¥½åŠ å¯†æ–¹å¼</span>        auth.userDetailsService(jwtUserDetailsService).passwordEncoder(passwordEncoder());    &#125;    <span class="hljs-meta">@Bean</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> PasswordEncoder <span class="hljs-title">passwordEncoder</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> BCryptPasswordEncoder();    &#125;    <span class="hljs-meta">@Bean</span>    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> AuthenticationManager <span class="hljs-title">authenticationManagerBean</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        <span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.authenticationManagerBean();    &#125;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity httpSecurity)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        <span class="hljs-comment">// æœ¬ç¤ºä¾‹ä¸éœ€è¦ä½¿ç”¨CSRF</span>        httpSecurity.csrf().disable()                <span class="hljs-comment">// è®¤è¯é¡µé¢ä¸éœ€è¦æƒé™</span>                .authorizeRequests().antMatchers(<span class="hljs-string">"/authenticate"</span>).permitAll().                <span class="hljs-comment">//å…¶ä»–é¡µé¢</span>                        anyRequest().authenticated().and().                <span class="hljs-comment">//ç™»å½•é¡µé¢ æ¨¡æ‹Ÿå®¢æˆ·ç«¯</span>                formLogin().loginPage(<span class="hljs-string">"/login.html"</span>).permitAll().and().                <span class="hljs-comment">// store user's state.</span>                 exceptionHandling().authenticationEntryPoint(jwtAuthenticationEntryPoint).and().sessionManagement()                <span class="hljs-comment">//ä¸ä½¿ç”¨session</span>                .sessionCreationPolicy(SessionCreationPolicy.STATELESS);        <span class="hljs-comment">//éªŒè¯è¯·æ±‚æ˜¯å¦æ­£ç¡®</span>        httpSecurity.addFilterBefore(jwtRequestFilter, UsernamePasswordAuthenticationFilter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;    &#125;&#125;</code></pre></div><p><strong>HelloWorldController</strong></p><div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HelloWorldController</span> </span>&#123;    <span class="hljs-meta">@RequestMapping</span>(&#123; <span class="hljs-string">"/hello"</span> &#125;)    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">firstPage</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-keyword">return</span> <span class="hljs-string">"Hello World"</span>;    &#125;&#125;</code></pre></div><p><strong>JwtRequest</strong></p><div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JwtRequest</span></span>&#123;   <span class="hljs-comment">// private static final long serialVersionUID = 5926468583005150707L;</span>    <span class="hljs-keyword">private</span> String username;    <span class="hljs-keyword">private</span> String password;    <span class="hljs-comment">//need default constructor for JSON Parsing</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">JwtRequest</span><span class="hljs-params">()</span></span><span class="hljs-function">    </span>&#123;    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">JwtRequest</span><span class="hljs-params">(String username, String password)</span> </span>&#123;        <span class="hljs-keyword">this</span>.setUsername(username);        <span class="hljs-keyword">this</span>.setPassword(password);    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getUsername</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.username;    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUsername</span><span class="hljs-params">(String username)</span> </span>&#123;        <span class="hljs-keyword">this</span>.username = username;    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getPassword</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.password;    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setPassword</span><span class="hljs-params">(String password)</span> </span>&#123;        <span class="hljs-keyword">this</span>.password = password;    &#125;&#125;</code></pre></div><p><strong>JwtResponse</strong></p><div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JwtResponse</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span> </span>&#123;    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> serialVersionUID = -<span class="hljs-number">8091879091924046844L</span>;    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String jwttoken;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">JwtResponse</span><span class="hljs-params">(String jwttoken)</span> </span>&#123;        <span class="hljs-keyword">this</span>.jwttoken = jwttoken;    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getToken</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.jwttoken;    &#125;&#125;</code></pre></div><p><strong>JwtTokenUtil</strong></p><div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JwtTokenUtil</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span> </span>&#123;    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> serialVersionUID = -<span class="hljs-number">2550185165626007488L</span>;    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> JWT_TOKEN_VALIDITY = <span class="hljs-number">5</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span>;    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"$&#123;jwt.secret&#125;"</span>)    <span class="hljs-keyword">private</span> String secret;    <span class="hljs-comment">//retrieve username from jwt token</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getUsernameFromToken</span><span class="hljs-params">(String token)</span> </span>&#123;        <span class="hljs-keyword">return</span> getClaimFromToken(token, Claims::getSubject);    &#125;    <span class="hljs-comment">//retrieve expiration date from jwt token</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> Date <span class="hljs-title">getExpirationDateFromToken</span><span class="hljs-params">(String token)</span> </span>&#123;        <span class="hljs-keyword">return</span> getClaimFromToken(token, Claims::getExpiration);    &#125;    <span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-function">T <span class="hljs-title">getClaimFromToken</span><span class="hljs-params">(String token, Function&lt;Claims, T&gt; claimsResolver)</span> </span>&#123;        <span class="hljs-keyword">final</span> Claims claims = getAllClaimsFromToken(token);        <span class="hljs-keyword">return</span> claimsResolver.apply(claims);    &#125;    <span class="hljs-comment">//for retrieveing any information from token we will need the secret key</span>    <span class="hljs-function"><span class="hljs-keyword">private</span> Claims <span class="hljs-title">getAllClaimsFromToken</span><span class="hljs-params">(String token)</span> </span>&#123;        <span class="hljs-keyword">return</span> Jwts.parser().setSigningKey(secret).parseClaimsJws(token).getBody();    &#125;    <span class="hljs-comment">//check if the token has expired</span>    <span class="hljs-function"><span class="hljs-keyword">private</span> Boolean <span class="hljs-title">isTokenExpired</span><span class="hljs-params">(String token)</span> </span>&#123;        <span class="hljs-keyword">final</span> Date expiration = getExpirationDateFromToken(token);        <span class="hljs-keyword">return</span> expiration.before(<span class="hljs-keyword">new</span> Date());    &#125;    <span class="hljs-comment">//generate token for user</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">generateToken</span><span class="hljs-params">(UserDetails userDetails)</span> </span>&#123;        Map&lt;String, Object&gt; claims = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();        <span class="hljs-keyword">return</span> doGenerateToken(claims, userDetails.getUsername());    &#125;    <span class="hljs-comment">//while creating the token -</span>    <span class="hljs-comment">//1. Define  claims of the token, like Issuer, Expiration, Subject, and the ID</span>    <span class="hljs-comment">//2. Sign the JWT using the HS512 algorithm and secret key.</span>    <span class="hljs-comment">//3. According to JWS Compact Serialization(https://tools.ietf.org/html/draft-ietf-jose-json-web-signature-41#section-3.1)</span>    <span class="hljs-comment">//   compaction of the JWT to a URL-safe string</span>    <span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">doGenerateToken</span><span class="hljs-params">(Map&lt;String, Object&gt; claims, String subject)</span> </span>&#123;        <span class="hljs-keyword">return</span> Jwts.builder().setClaims(claims).setSubject(subject).setIssuedAt(<span class="hljs-keyword">new</span> Date(System.currentTimeMillis()))                .setExpiration(<span class="hljs-keyword">new</span> Date(System.currentTimeMillis() + JWT_TOKEN_VALIDITY * <span class="hljs-number">1000</span>))                .signWith(SignatureAlgorithm.HS512, secret).compact();    &#125;    <span class="hljs-comment">//æ ¡éªŒ token</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> Boolean <span class="hljs-title">validateToken</span><span class="hljs-params">(String token, UserDetails userDetails)</span> </span>&#123;        <span class="hljs-comment">//è·å–tokençš„ç”¨æˆ·åï¼Œå¹¶è¿›è¡ŒåŒ¹é…</span>        <span class="hljs-keyword">final</span> String username = getUsernameFromToken(token);        <span class="hljs-keyword">return</span> (username.equals(userDetails.getUsername()) &amp;&amp; !isTokenExpired(token));    &#125;&#125;</code></pre></div><p>ç™»å½•ç”¨çš„ajaxï¼š</p><div class="hljs"><pre><code class="hljs javascript">$(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>&#123;        $(<span class="hljs-string">"#btnSave"</span>).click(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;            <span class="hljs-keyword">var</span> username=$(<span class="hljs-string">"#userName"</span>).val();            <span class="hljs-keyword">var</span> password=$(<span class="hljs-string">"#password"</span>).val();            $.ajax(&#123;                cache: <span class="hljs-literal">true</span>,                type: <span class="hljs-string">"POST"</span>,                url: <span class="hljs-string">"/authenticate"</span>,                contentType: <span class="hljs-string">"application/json;charset=UTF-8"</span>,                data:<span class="hljs-built_in">JSON</span>.stringify(&#123;<span class="hljs-string">"username"</span>:username ,<span class="hljs-string">"password"</span> : password&#125;),                dataType: <span class="hljs-string">"json"</span>,                <span class="hljs-keyword">async</span>: <span class="hljs-literal">false</span>,                error: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">request</span>) </span>&#123;                    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Connection error"</span>);                &#125;,                success: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">data</span>) </span>&#123;                    <span class="hljs-comment">//save token</span>                    localStorage.setItem(<span class="hljs-string">"token"</span>,data.token);                &#125;            &#125;);        &#125;);    &#125;);</code></pre></div><p>æ³¨æ„ï¼Œè¿™ä¸ªé¡¹ç›®çš„javaç‰ˆæœ¬è¦æ±‚æ˜¯java8ï¼Œå¦‚æœä½ æ˜¯å’Œæˆ‘ä¸€æ ·ä½¿ç”¨java11æˆ–æ›´é«˜çš„ç‰ˆæœ¬çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨æˆ‘çš„pom.xmlé‡Œé¢çš„é…ç½®ã€‚</p><div class="hljs"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>javax.xml.bind<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jaxb-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.3.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.sun.xml.bind<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jaxb-impl<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.3.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.sun.xml.bind<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jaxb-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.3.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>javax.activation<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>activation<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.jsonwebtoken<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jjwt<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.9.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.security<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-security-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span></code></pre></div><p>å‚è€ƒæ¥æºï¼š</p><p><a href="https://www.cnblogs.com/fishpro/p/spring-boot-study-securing-jwt.html" target="_blank" rel="noopener">Spring Boot Security JWT æ•´åˆå®ç°å‰åç«¯åˆ†ç¦»è®¤è¯ç¤ºä¾‹</a></p><p><a href="https://www.javainuse.com/spring/boot-jwt" target="_blank" rel="noopener">Spring Boot Security + JWT Hello World Example</a></p><h2 id="4-jwtæ•°æ®åº“-æˆæƒéƒ¨åˆ†"><a class="markdownIt-Anchor" href="#4-jwtæ•°æ®åº“-æˆæƒéƒ¨åˆ†"></a> 4ã€ JWT+æ•°æ®åº“ æˆæƒéƒ¨åˆ†</h2><p>â€‹æˆ‘è§‰å¾—è¿™ç©æ„å¯éš¾äº†ï¼Œå­¦äº†ä¸ªä¸¤å¤©æ‰å‹‰å‹‰å¼ºå¼ºææ˜ç™½ä¸ªä¸€å°åŠã€‚å”‰ï¼Œåƒäº†è‹±è¯­ä¸å¥½çš„äºã€‚</p><p>â€‹ä»¥ä¸‹æ˜¯å¤§æ¦‚çš„æµç¨‹ï¼š</p><img src="/img/image-20200628170759526.png" srcset="/img/loading.gif" alt="A" style="zoom: 100%;" /><p>æ‰€ç”¨åˆ°çš„ç±»ï¼š</p><h3 id="æ‹¦æˆªå™¨ç±»-jwtauthenticationtokenfilter"><a class="markdownIt-Anchor" href="#æ‹¦æˆªå™¨ç±»-jwtauthenticationtokenfilter"></a> æ‹¦æˆªå™¨ç±» JWTAuthenticationTokenFilter</h3><div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JWTAuthenticationTokenFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BasicAuthenticationFilter</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">JWTAuthenticationTokenFilter</span><span class="hljs-params">(AuthenticationManager authenticationManager)</span> </span>&#123;        <span class="hljs-keyword">super</span>(authenticationManager);    &#125;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doFilterInternal</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)</span> <span class="hljs-keyword">throws</span> ServletException, IOException </span>&#123;        <span class="hljs-comment">// è·å–è¯·æ±‚å¤´ä¸­JWTçš„Token</span>        String tokenHeader = request.getHeader(JWTConfig.tokenHeader);        <span class="hljs-comment">// &amp;&amp; tokenHeader.startsWith(JWTConfig.tokenPrefix)</span>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">null</span>!=tokenHeader) &#123;            <span class="hljs-keyword">try</span> &#123;                <span class="hljs-comment">// æˆªå–JWTå‰ç¼€</span>                String token = tokenHeader.replace(<span class="hljs-string">"Bearer Sans-"</span>, <span class="hljs-string">""</span>);                <span class="hljs-comment">// è§£æJWT</span>                Claims claims = Jwts.parser()                        .setSigningKey(JWTConfig.secret)                        .parseClaimsJws(token)                        .getBody();                log.info(claims.toString());                <span class="hljs-comment">// è·å–ç”¨æˆ·å</span>                String username = claims.getSubject();                String userId=claims.getId();                <span class="hljs-keyword">if</span>(!StringUtils.isEmpty(username)&amp;&amp;!StringUtils.isEmpty(userId)) &#123;                    <span class="hljs-comment">// è·å–è§’è‰²</span>                    List&lt;GrantedAuthority&gt; authorities = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();                    String authority = claims.get(<span class="hljs-string">"authorities"</span>).toString();                    log.info(authority);                    <span class="hljs-keyword">if</span>(!StringUtils.isEmpty(authority))&#123;                        List&lt;Map&lt;String,String&gt;&gt; authorityMap = JSONObject.parseObject(authority, List<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;                        <span class="hljs-keyword">for</span> (Map&lt;String, String&gt; stringStringMap : authorityMap) &#123;                            <span class="hljs-keyword">for</span> (String s : stringStringMap.keySet()) &#123;                                log.info(s);                                log.info(stringStringMap.get(s));                            &#125;                        &#125;                        <span class="hljs-keyword">for</span>(Map&lt;String,String&gt; role : authorityMap)&#123;                            <span class="hljs-keyword">if</span>(!StringUtils.isEmpty(role)) &#123;                                authorities.add(<span class="hljs-keyword">new</span> SimpleGrantedAuthority(role.get(<span class="hljs-string">"authority"</span>)));                                <span class="hljs-comment">//log.info(role.get("authority"));</span>                            &#125;                        &#125;                    &#125;                    <span class="hljs-comment">//ç»„è£…å‚æ•°</span>                    SelfUserEntity selfUserEntity = <span class="hljs-keyword">new</span> SelfUserEntity();                    selfUserEntity.setUsername(claims.getSubject());                    selfUserEntity.setUserId(Long.parseLong(claims.getId()));                    selfUserEntity.setAuthorities(authorities);                    UsernamePasswordAuthenticationToken authentication = <span class="hljs-keyword">new</span> UsernamePasswordAuthenticationToken(selfUserEntity, userId, authorities);                    SecurityContextHolder.getContext().setAuthentication(authentication);                &#125;            &#125; <span class="hljs-keyword">catch</span> (ExpiredJwtException e)&#123;                log.info(<span class="hljs-string">"Tokenè¿‡æœŸ"</span>);            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;                log.error(e.getMessage());                log.info(<span class="hljs-string">"Tokenæ— æ•ˆ"</span>);            &#125;        &#125;        filterChain.doFilter(request, response);        <span class="hljs-keyword">return</span>;    &#125;&#125;</code></pre></div><h3 id="securityé…ç½®ç±»-securityconfig"><a class="markdownIt-Anchor" href="#securityé…ç½®ç±»-securityconfig"></a> Securityé…ç½®ç±» SecurityConfig</h3><div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><span class="hljs-meta">@EnableWebSecurity</span><span class="hljs-meta">@EnableGlobalMethodSecurity</span>(prePostEnabled = <span class="hljs-keyword">true</span>) <span class="hljs-comment">//å¼€å¯æƒé™æ³¨è§£,é»˜è®¤æ˜¯å…³é—­çš„</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">WebSecurityConfigurerAdapter</span> </span>&#123;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * è‡ªå®šä¹‰ç™»å½•æˆåŠŸå¤„ç†å™¨</span><span class="hljs-comment">     */</span>    <span class="hljs-meta">@Autowired</span>    <span class="hljs-keyword">private</span> UserLoginSuccessHandler userLoginSuccessHandler;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * è‡ªå®šä¹‰ç™»å½•å¤±è´¥å¤„ç†å™¨</span><span class="hljs-comment">     */</span>    <span class="hljs-meta">@Autowired</span>    <span class="hljs-keyword">private</span> UserLoginFailureHandler userLoginFailureHandler;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * è‡ªå®šä¹‰æ³¨é”€æˆåŠŸå¤„ç†å™¨</span><span class="hljs-comment">     */</span>    <span class="hljs-meta">@Autowired</span>    <span class="hljs-keyword">private</span> UserLogoutSuccessHandler userLogoutSuccessHandler;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * è‡ªå®šä¹‰æš‚æ— æƒé™å¤„ç†å™¨</span><span class="hljs-comment">     */</span>    <span class="hljs-meta">@Autowired</span>    <span class="hljs-keyword">private</span> UserAuthAccessDeniedHandler userAuthAccessDeniedHandler;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * è‡ªå®šä¹‰æœªç™»å½•çš„å¤„ç†å™¨</span><span class="hljs-comment">     */</span>    <span class="hljs-meta">@Autowired</span>    <span class="hljs-keyword">private</span> UserAuthenticationEntryPointHandler userAuthenticationEntryPointHandler;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * è‡ªå®šä¹‰ç™»å½•é€»è¾‘éªŒè¯å™¨</span><span class="hljs-comment">     */</span>    <span class="hljs-meta">@Autowired</span>    <span class="hljs-keyword">private</span> UserAuthenticationProvider userAuthenticationProvider;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * åŠ å¯†æ–¹å¼</span><span class="hljs-comment">     * <span class="hljs-doctag">@Author</span> Sans</span><span class="hljs-comment">     * <span class="hljs-doctag">@CreateTime</span> 2019/10/1 14:00</span><span class="hljs-comment">     */</span>    <span class="hljs-meta">@Bean</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> BCryptPasswordEncoder <span class="hljs-title">bCryptPasswordEncoder</span><span class="hljs-params">()</span></span>&#123;        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> BCryptPasswordEncoder();    &#125;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * æ³¨å…¥è‡ªå®šä¹‰PermissionEvaluator</span><span class="hljs-comment">     */</span>    <span class="hljs-meta">@Bean</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> DefaultWebSecurityExpressionHandler <span class="hljs-title">userSecurityExpressionHandler</span><span class="hljs-params">()</span></span>&#123;        DefaultWebSecurityExpressionHandler handler = <span class="hljs-keyword">new</span> DefaultWebSecurityExpressionHandler();        handler.setPermissionEvaluator(<span class="hljs-keyword">new</span> UserPermissionEvaluator());        <span class="hljs-keyword">return</span> handler;    &#125;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * é…ç½®ç™»å½•éªŒè¯é€»è¾‘</span><span class="hljs-comment">     */</span>    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span></span>&#123;        <span class="hljs-comment">//è¿™é‡Œå¯å¯ç”¨æˆ‘ä»¬è‡ªå·±çš„ç™»é™†éªŒè¯é€»è¾‘</span>        auth.authenticationProvider(userAuthenticationProvider);    &#125;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * é…ç½®securityçš„æ§åˆ¶é€»è¾‘</span><span class="hljs-comment">     * <span class="hljs-doctag">@Author</span> Sans</span><span class="hljs-comment">     * <span class="hljs-doctag">@CreateTime</span> 2019/10/1 16:56</span><span class="hljs-comment">     * <span class="hljs-doctag">@Param</span>  http è¯·æ±‚</span><span class="hljs-comment">     */</span>    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        http.authorizeRequests()                <span class="hljs-comment">// ä¸è¿›è¡Œæƒé™éªŒè¯çš„è¯·æ±‚æˆ–èµ„æº(ä»é…ç½®æ–‡ä»¶ä¸­è¯»å–)</span>               .antMatchers(JWTConfig.antMatchers.split(<span class="hljs-string">","</span>)).permitAll()                <span class="hljs-comment">// å…¶ä»–çš„éœ€è¦ç™»é™†åæ‰èƒ½è®¿é—®</span>                .anyRequest().authenticated()                .and()                <span class="hljs-comment">// é…ç½®æœªç™»å½•è‡ªå®šä¹‰å¤„ç†ç±»</span>                .httpBasic().authenticationEntryPoint(userAuthenticationEntryPointHandler)                .and()                <span class="hljs-comment">// é…ç½®ç™»å½•åœ°å€</span>                .formLogin()                .loginProcessingUrl(<span class="hljs-string">"/login/userLogin"</span>)                <span class="hljs-comment">// é…ç½®ç™»å½•æˆåŠŸè‡ªå®šä¹‰å¤„ç†ç±»</span>                .successHandler(userLoginSuccessHandler)                <span class="hljs-comment">// é…ç½®ç™»å½•å¤±è´¥è‡ªå®šä¹‰å¤„ç†ç±»</span>                .failureHandler(userLoginFailureHandler)                .and()                <span class="hljs-comment">// é…ç½®ç™»å‡ºåœ°å€</span>                .logout()                .logoutUrl(<span class="hljs-string">"/login/userLogout"</span>)                <span class="hljs-comment">// é…ç½®ç”¨æˆ·ç™»å‡ºè‡ªå®šä¹‰å¤„ç†ç±»</span>                .logoutSuccessHandler(userLogoutSuccessHandler)                .and()                <span class="hljs-comment">// é…ç½®æ²¡æœ‰æƒé™è‡ªå®šä¹‰å¤„ç†ç±»</span>                .exceptionHandling().accessDeniedHandler(userAuthAccessDeniedHandler)                .and()                <span class="hljs-comment">// å¼€å¯è·¨åŸŸ</span>                .cors()                .and()                <span class="hljs-comment">// å–æ¶ˆè·¨ç«™è¯·æ±‚ä¼ªé€ é˜²æŠ¤</span>                .csrf().disable();        <span class="hljs-comment">// åŸºäºTokenä¸éœ€è¦session</span>        http.sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS);        <span class="hljs-comment">// ç¦ç”¨ç¼“å­˜</span>        http.headers().cacheControl();        <span class="hljs-comment">// æ·»åŠ JWTè¿‡æ»¤å™¨</span>        http.addFilter(<span class="hljs-keyword">new</span> JWTAuthenticationTokenFilter(authenticationManager()));    &#125;&#125;</code></pre></div><h3 id="è§’è‰²å®ä½“ç±»-sysroleentity"><a class="markdownIt-Anchor" href="#è§’è‰²å®ä½“ç±»-sysroleentity"></a> è§’è‰²å®ä½“ç±» SysRoleEntity</h3><div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><span class="hljs-meta">@TableName</span>(<span class="hljs-string">"sys_role"</span>)<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SysRoleEntity</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span> </span>&#123;<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> serialVersionUID = <span class="hljs-number">1L</span>;<span class="hljs-comment">/**</span><span class="hljs-comment"> * è§’è‰²ID</span><span class="hljs-comment"> */</span><span class="hljs-meta">@TableId</span><span class="hljs-keyword">private</span> Long roleId;<span class="hljs-comment">/**</span><span class="hljs-comment"> * è§’è‰²åç§°</span><span class="hljs-comment"> */</span><span class="hljs-keyword">private</span> String roleName;&#125;</code></pre></div><h3 id="è‡ªå®šä¹‰è®¤è¯é€»è¾‘å¤„ç†å™¨-userauthenticationprovider"><a class="markdownIt-Anchor" href="#è‡ªå®šä¹‰è®¤è¯é€»è¾‘å¤„ç†å™¨-userauthenticationprovider"></a> è‡ªå®šä¹‰è®¤è¯é€»è¾‘å¤„ç†å™¨ UserAuthenticationProvider</h3><div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserAuthenticationProvider</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">AuthenticationProvider</span> </span>&#123;    <span class="hljs-meta">@Autowired</span>    <span class="hljs-keyword">private</span> SelfUserDetailsService selfUserDetailsService;    <span class="hljs-meta">@Autowired</span>    <span class="hljs-keyword">private</span> SysUserService sysUserService;    <span class="hljs-comment">//authentication è¿™ä¸ªå‚æ•°æ˜¯å“ªé‡Œæ¥çš„å‘¢ï¼Ÿ</span>    <span class="hljs-comment">//æˆ‘çŒœæµ‹æ˜¯è¿™æ ·çš„ï¼šUsernamePasswordAuthenticationFilter å¤„ç†äº†ä»å‰å°ä¼ å…¥çš„è´¦å·å¯†ç ï¼Œå°è£…æˆä¸€ä¸ªå®ç°äº†Authenticationæ¥å£çš„UsernamePasswordAuthenticationTokenç±»ï¼Œæ­¤æ—¶è¿™ä¸ªè´¦å·å¯†ç å°šæœªè®¤è¯ï¼Œæ‰€ä»¥æ²¡æœ‰æƒé™ã€‚-&gt;è°ƒç”¨ProviderManagerç±»çš„authenticateæ–¹æ³•å¤„ç†Token-&gt;è½®è¯¢åœ¨securityé…ç½®é‡Œé¢æ³¨å†Œå¥½çš„ç™»å½•é€»è¾‘å¤„ç†ç±»ï¼Œæ£€æŸ¥æ˜¯å¦æ”¯æŒå½“å‰tokenï¼Œæ‰¾åˆ°ä¹‹åè¿›è¡Œå¤„ç†ã€‚â€”&gt;äºæ˜¯ï¼Œè¿™ä¸ªtokenå°±ä¼ è¿›æ¥äº†ã€‚</span>    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> Authentication <span class="hljs-title">authenticate</span><span class="hljs-params">(Authentication authentication)</span> <span class="hljs-keyword">throws</span> AuthenticationException </span>&#123;        <span class="hljs-comment">// è·å–è¡¨å•è¾“å…¥ä¸­è¿”å›çš„ç”¨æˆ·å</span>        String userName = (String) authentication.getPrincipal();        <span class="hljs-comment">// è·å–è¡¨å•ä¸­è¾“å…¥çš„å¯†ç </span>        String password = (String) authentication.getCredentials();        <span class="hljs-comment">// æŸ¥è¯¢ç”¨æˆ·æ˜¯å¦å­˜åœ¨</span>        SelfUserEntity userInfo = selfUserDetailsService.loadUserByUsername(userName);        <span class="hljs-keyword">if</span> (userInfo == <span class="hljs-keyword">null</span>) &#123;            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> UsernameNotFoundException(<span class="hljs-string">"ç”¨æˆ·åä¸å­˜åœ¨"</span>);        &#125;        <span class="hljs-comment">// æˆ‘ä»¬è¿˜è¦åˆ¤æ–­å¯†ç æ˜¯å¦æ­£ç¡®ï¼Œè¿™é‡Œæˆ‘ä»¬çš„å¯†ç ä½¿ç”¨BCryptPasswordEncoderè¿›è¡ŒåŠ å¯†çš„</span>        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">new</span> BCryptPasswordEncoder().matches(password, userInfo.getPassword())) &#123;            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BadCredentialsException(<span class="hljs-string">"å¯†ç ä¸æ­£ç¡®"</span>);        &#125;        <span class="hljs-comment">// è¿˜å¯ä»¥åŠ ä¸€äº›å…¶ä»–ä¿¡æ¯çš„åˆ¤æ–­ï¼Œæ¯”å¦‚ç”¨æˆ·è´¦å·å·²åœç”¨ç­‰åˆ¤æ–­</span>        <span class="hljs-keyword">if</span> (userInfo.getStatus().equals(<span class="hljs-string">"PROHIBIT"</span>))&#123;            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> LockedException(<span class="hljs-string">"è¯¥ç”¨æˆ·å·²è¢«å†»ç»“"</span>);        &#125;        <span class="hljs-comment">// è§’è‰²é›†åˆ</span>        Set&lt;GrantedAuthority&gt; authorities = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();        <span class="hljs-comment">// æŸ¥è¯¢ç”¨æˆ·è§’è‰²</span>        <span class="hljs-comment">//ä¸€å¼ è¡¨å‚¨å­˜äº†ç”¨æˆ·idå’Œä»–çš„æ‰€æ‹¥æœ‰çš„æƒé™çš„idï¼Œå¦ä¸€å¼ è¡¨å‚¨å­˜äº†å¯¹åº”æƒé™idçš„æƒé™åã€‚</span>        <span class="hljs-comment">//æ‰€ä»¥æŸ¥å‡ºæ¥æ˜¯ä¸€åˆ—æƒé™å®ä½“ç±»</span>               List&lt;SysRoleEntity&gt; sysRoleEntityList = sysUserService.selectSysRoleByUserId(userInfo.getUserId());        <span class="hljs-keyword">for</span> (SysRoleEntity sysRoleEntity: sysRoleEntityList)&#123;            authorities.add(<span class="hljs-keyword">new</span> SimpleGrantedAuthority(<span class="hljs-string">"ROLE_"</span> + sysRoleEntity.getRoleName()));        &#125;        userInfo.setAuthorities(authorities);        <span class="hljs-comment">// è¿›è¡Œç™»å½•</span>        <span class="hljs-comment">//ä¸Šæ–¹æ‰€è¯´çš„è½®è¯¢å¹¶æ£€æµ‹æ˜¯å¦æˆåŠŸçš„æ ‡å¿—å°±æ˜¯çœ‹è¿”å›çš„æ˜¯ä¸æ˜¯ä¸ºnull,ä¸ä¸ºnullåˆ™è¡¨æ˜è®¤è¯æˆåŠŸã€‚</span>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> UsernamePasswordAuthenticationToken(userInfo, password, authorities);    &#125;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">supports</span><span class="hljs-params">(Class&lt;?&gt; authentication)</span> </span>&#123;        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;    &#125;&#125;</code></pre></div><h3 id="æŸ¥è¯¢ç”¨æˆ·æ˜¯å¦å­˜åœ¨-selfuserdetailsservice"><a class="markdownIt-Anchor" href="#æŸ¥è¯¢ç”¨æˆ·æ˜¯å¦å­˜åœ¨-selfuserdetailsservice"></a> æŸ¥è¯¢ç”¨æˆ·æ˜¯å¦å­˜åœ¨ SelfUserDetailsService</h3><div class="hljs"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SelfUserDetailsService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UserDetailsService</span> </span>&#123;    <span class="hljs-meta">@Autowired</span>    <span class="hljs-keyword">private</span> SysUserService sysUserService;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯</span><span class="hljs-comment">     * <span class="hljs-doctag">@Author</span> Sans</span><span class="hljs-comment">     * <span class="hljs-doctag">@CreateTime</span> 2019/9/13 17:23</span><span class="hljs-comment">     * <span class="hljs-doctag">@Param</span>  username  ç”¨æˆ·å</span><span class="hljs-comment">     * <span class="hljs-doctag">@Return</span> UserDetails SpringSecurityç”¨æˆ·ä¿¡æ¯</span><span class="hljs-comment">     */</span>    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> SelfUserEntity <span class="hljs-title">loadUserByUsername</span><span class="hljs-params">(String username)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException </span>&#123;        <span class="hljs-comment">// æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯</span>        SysUserEntity sysUserEntity =sysUserService.selectUserByName(username);        <span class="hljs-keyword">if</span> (sysUserEntity!=<span class="hljs-keyword">null</span>)&#123;            <span class="hljs-comment">// ç»„è£…å‚æ•°</span>            SelfUserEntity selfUserEntity = <span class="hljs-keyword">new</span> SelfUserEntity();            BeanUtils.copyProperties(sysUserEntity,selfUserEntity);            <span class="hljs-keyword">return</span> selfUserEntity;        &#125;        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;    &#125;&#125;</code></pre></div><h3 id="ç¬¦åˆsecurityæ ‡å‡†çš„ç”¨æˆ·ç±»-selfuserentity"><a class="markdownIt-Anchor" href="#ç¬¦åˆsecurityæ ‡å‡†çš„ç”¨æˆ·ç±»-selfuserentity"></a> ç¬¦åˆSecurityæ ‡å‡†çš„ç”¨æˆ·ç±» SelfUserEntity</h3><div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SelfUserEntity</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span>, <span class="hljs-title">UserDetails</span> </span>&#123;<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> serialVersionUID = <span class="hljs-number">1L</span>;<span class="hljs-comment">/**</span><span class="hljs-comment"> * ç”¨æˆ·ID</span><span class="hljs-comment"> */</span><span class="hljs-keyword">private</span> Long userId;<span class="hljs-comment">/**</span><span class="hljs-comment"> * ç”¨æˆ·å</span><span class="hljs-comment"> */</span><span class="hljs-keyword">private</span> String username;<span class="hljs-comment">/**</span><span class="hljs-comment"> * å¯†ç </span><span class="hljs-comment"> */</span><span class="hljs-keyword">private</span> String password;<span class="hljs-comment">/**</span><span class="hljs-comment"> * çŠ¶æ€:NORMALæ­£å¸¸  PROHIBITç¦ç”¨</span><span class="hljs-comment"> */</span><span class="hljs-keyword">private</span> String status;<span class="hljs-comment">/**</span><span class="hljs-comment"> * ç”¨æˆ·è§’è‰²</span><span class="hljs-comment"> */</span><span class="hljs-keyword">private</span> Collection&lt;GrantedAuthority&gt; authorities;<span class="hljs-comment">/**</span><span class="hljs-comment"> * è´¦æˆ·æ˜¯å¦è¿‡æœŸ</span><span class="hljs-comment"> */</span><span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> isAccountNonExpired = <span class="hljs-keyword">false</span>;<span class="hljs-comment">/**</span><span class="hljs-comment"> * è´¦æˆ·æ˜¯å¦è¢«é”å®š</span><span class="hljs-comment"> */</span><span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> isAccountNonLocked = <span class="hljs-keyword">false</span>;<span class="hljs-comment">/**</span><span class="hljs-comment"> * è¯ä¹¦æ˜¯å¦è¿‡æœŸ</span><span class="hljs-comment"> */</span><span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> isCredentialsNonExpired = <span class="hljs-keyword">false</span>;<span class="hljs-comment">/**</span><span class="hljs-comment"> * è´¦æˆ·æ˜¯å¦æœ‰æ•ˆ</span><span class="hljs-comment"> */</span><span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> isEnabled = <span class="hljs-keyword">true</span>;<span class="hljs-meta">@Override</span><span class="hljs-function"><span class="hljs-keyword">public</span> Collection&lt;GrantedAuthority&gt; <span class="hljs-title">getAuthorities</span><span class="hljs-params">()</span> </span>&#123;<span class="hljs-keyword">return</span> authorities;&#125;<span class="hljs-meta">@Override</span><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isAccountNonExpired</span><span class="hljs-params">()</span> </span>&#123;<span class="hljs-keyword">return</span> isAccountNonExpired;&#125;<span class="hljs-meta">@Override</span><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isAccountNonLocked</span><span class="hljs-params">()</span> </span>&#123;<span class="hljs-keyword">return</span> isAccountNonLocked;&#125;<span class="hljs-meta">@Override</span><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isCredentialsNonExpired</span><span class="hljs-params">()</span> </span>&#123;<span class="hljs-keyword">return</span> isCredentialsNonExpired;&#125;<span class="hljs-meta">@Override</span><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isEnabled</span><span class="hljs-params">()</span> </span>&#123;<span class="hljs-keyword">return</span> isEnabled;&#125;&#125;</code></pre></div><h3 id="ç™»å½•æˆåŠŸå¤„ç†ç±»-userloginsuccesshandler"><a class="markdownIt-Anchor" href="#ç™»å½•æˆåŠŸå¤„ç†ç±»-userloginsuccesshandler"></a> ç™»å½•æˆåŠŸå¤„ç†ç±» UserLoginSuccessHandler</h3><div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Slf</span>4j<span class="hljs-meta">@Component</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserLoginSuccessHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">AuthenticationSuccessHandler</span> </span>&#123;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * ç™»å½•æˆåŠŸè¿”å›ç»“æœ</span><span class="hljs-comment">     * <span class="hljs-doctag">@Author</span> Sans</span><span class="hljs-comment">     * <span class="hljs-doctag">@CreateTime</span> 2019/10/3 9:27</span><span class="hljs-comment">     */</span>    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onAuthenticationSuccess</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span></span>&#123;        <span class="hljs-comment">// ç»„è£…JWT</span>        <span class="hljs-comment">//åœ¨è®¤è¯å¤„ç†å™¨éƒ¨åˆ†ï¼Œå°†userinfoä¼ å…¥ç»™UsernamePasswordAuthenticationTokenä½œä¸ºprincipal</span>        SelfUserEntity selfUserEntity =  (SelfUserEntity) authentication.getPrincipal();        String token = JWTTokenUtil.createAccessToken(selfUserEntity);        log.info(selfUserEntity.toString());        token = JWTConfig.tokenPrefix + token;        <span class="hljs-comment">// å°è£…è¿”å›å‚æ•°</span>        Map&lt;String,Object&gt; resultData = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();        resultData.put(<span class="hljs-string">"code"</span>,<span class="hljs-string">"200"</span>);        resultData.put(<span class="hljs-string">"msg"</span>, <span class="hljs-string">"ç™»å½•æˆåŠŸ"</span>);        resultData.put(<span class="hljs-string">"token"</span>,token);        ResultUtil.responseJson(response,resultData);    &#125;&#125;</code></pre></div><h3 id="ä¸jwtæœ‰å…³çš„å·¥å…·ç±»-jwttokenutil"><a class="markdownIt-Anchor" href="#ä¸jwtæœ‰å…³çš„å·¥å…·ç±»-jwttokenutil"></a> ä¸JWTæœ‰å…³çš„å·¥å…·ç±» JWTTokenUtil</h3><div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Slf</span>4j<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JWTTokenUtil</span> </span>&#123;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * ç§æœ‰åŒ–æ„é€ å™¨</span><span class="hljs-comment">     */</span>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">JWTTokenUtil</span><span class="hljs-params">()</span></span>&#123;&#125;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * ç”ŸæˆToken</span><span class="hljs-comment">     * <span class="hljs-doctag">@Author</span> Sans</span><span class="hljs-comment">     * <span class="hljs-doctag">@CreateTime</span> 2019/10/2 12:16</span><span class="hljs-comment">     * <span class="hljs-doctag">@Param</span>  selfUserEntity ç”¨æˆ·å®‰å…¨å®ä½“</span><span class="hljs-comment">     * <span class="hljs-doctag">@Return</span> Token</span><span class="hljs-comment">     */</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">createAccessToken</span><span class="hljs-params">(SelfUserEntity selfUserEntity)</span></span>&#123;        <span class="hljs-comment">// ç™»é™†æˆåŠŸç”ŸæˆJWT</span>        String token = Jwts.builder()                <span class="hljs-comment">// æ”¾å…¥ç”¨æˆ·åå’Œç”¨æˆ·ID</span>                .setId(selfUserEntity.getUserId()+<span class="hljs-string">""</span>)                <span class="hljs-comment">// ä¸»é¢˜</span>                .setSubject(selfUserEntity.getUsername())                <span class="hljs-comment">// ç­¾å‘æ—¶é—´</span>                .setIssuedAt(<span class="hljs-keyword">new</span> Date())                <span class="hljs-comment">// ç­¾å‘è€…</span>                .setIssuer(<span class="hljs-string">"sans"</span>)                <span class="hljs-comment">// è‡ªå®šä¹‰å±æ€§ æ”¾å…¥ç”¨æˆ·æ‹¥æœ‰æƒé™</span>            <span class="hljs-comment">//é‡ç”³ä¸€éï¼Œå¤šè§’è‰²çš„æ—¶å€™ï¼Œè¿™ä¸ªå±æ€§é•¿[&#123;"authority":"ROLE_USER"&#125;,&#123;"authority":"ROLE_ADMIN"&#125;]è¿™æ ·ï¼Œè¡¨æ˜ä»–æœ‰ä¸¤ä¸ªè§’è‰²</span>                .claim(<span class="hljs-string">"authorities"</span>, JSON.toJSONString(selfUserEntity.getAuthorities()))                <span class="hljs-comment">// å¤±æ•ˆæ—¶é—´</span>                .setExpiration(<span class="hljs-keyword">new</span> Date(System.currentTimeMillis() + JWTConfig.expiration))                <span class="hljs-comment">// ç­¾åç®—æ³•å’Œå¯†é’¥</span>                .signWith(SignatureAlgorithm.HS512, JWTConfig.secret)                .compact();        log.info(JSON.toJSONString(selfUserEntity.getAuthorities()));        <span class="hljs-keyword">return</span> token;    &#125;&#125;</code></pre></div><h2 id="5-jwtæ•°æ®åº“-é‰´æƒéƒ¨åˆ†"><a class="markdownIt-Anchor" href="#5-jwtæ•°æ®åº“-é‰´æƒéƒ¨åˆ†"></a> 5ã€JWT+æ•°æ®åº“ é‰´æƒéƒ¨åˆ†</h2><p>ä¸Šå›¾</p><img src="/img/image-20200629141557755.png" srcset="/img/loading.gif" alt="image-20200629141557755" style="zoom:80%;" /><p>ç”¨åˆ°çš„ç±»</p><h3 id="haspermission-é‰´æƒç±»-userpermissionevaluator"><a class="markdownIt-Anchor" href="#haspermission-é‰´æƒç±»-userpermissionevaluator"></a> hasPermission é‰´æƒç±» UserPermissionEvaluator</h3><div class="hljs"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><span class="hljs-meta">@Slf</span>4j<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserPermissionEvaluator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">PermissionEvaluator</span> </span>&#123;    <span class="hljs-meta">@Autowired</span>    <span class="hljs-keyword">private</span> SysUserService sysUserService;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * hasPermissioné‰´æƒæ–¹æ³•</span><span class="hljs-comment">     * è¿™é‡Œä»…ä»…åˆ¤æ–­PreAuthorizeæ³¨è§£ä¸­çš„æƒé™è¡¨è¾¾å¼</span><span class="hljs-comment">     * å®é™…ä¸­å¯ä»¥æ ¹æ®ä¸šåŠ¡éœ€æ±‚è®¾è®¡æ•°æ®åº“é€šè¿‡targetUrlå’Œpermissionåšæ›´å¤æ‚é‰´æƒ</span><span class="hljs-comment">     * å½“ç„¶targetUrlä¸ä¸€å®šæ˜¯URLå¯ä»¥æ˜¯æ•°æ®Idè¿˜å¯ä»¥æ˜¯ç®¡ç†å‘˜æ ‡è¯†ç­‰,è¿™é‡Œæ ¹æ®éœ€æ±‚è‡ªè¡Œè®¾è®¡</span><span class="hljs-comment">     * <span class="hljs-doctag">@Author</span> Sans</span><span class="hljs-comment">     * <span class="hljs-doctag">@CreateTime</span> 2019/10/6 18:25</span><span class="hljs-comment">     * <span class="hljs-doctag">@Param</span>  authentication  ç”¨æˆ·èº«ä»½(åœ¨ä½¿ç”¨hasPermissionè¡¨è¾¾å¼æ—¶Authenticationå‚æ•°é»˜è®¤ä¼šè‡ªåŠ¨å¸¦ä¸Š)</span><span class="hljs-comment">     * <span class="hljs-doctag">@Param</span>  targetUrl  è¯·æ±‚è·¯å¾„</span><span class="hljs-comment">     * <span class="hljs-doctag">@Param</span>  permission è¯·æ±‚è·¯å¾„æƒé™</span><span class="hljs-comment">     * <span class="hljs-doctag">@Return</span> boolean æ˜¯å¦é€šè¿‡</span><span class="hljs-comment">     */</span>    <span class="hljs-meta">@Override</span>    <span class="hljs-comment">//ä¼ å…¥ç”¨æˆ·å®‰å…¨ä¿¡æ¯ã€ç›®æ ‡urlã€éœ€è¦çš„æƒé™</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">hasPermission</span><span class="hljs-params">(Authentication authentication, Object targetUrl, Object permission)</span> </span>&#123;        <span class="hljs-comment">// è·å–ç”¨æˆ·ä¿¡æ¯</span>        SelfUserEntity selfUserEntity =(SelfUserEntity) authentication.getPrincipal();        Collection&lt;GrantedAuthority&gt; authorities = selfUserEntity.getAuthorities();        <span class="hljs-keyword">for</span> (GrantedAuthority authority : authorities) &#123;            log.info(authority.getAuthority());        &#125;        <span class="hljs-comment">// æŸ¥è¯¢ç”¨æˆ·æƒé™(è¿™é‡Œå¯ä»¥å°†æƒé™æ”¾å…¥ç¼“å­˜ä¸­æå‡æ•ˆç‡)</span>        Set&lt;String&gt; permissions = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();        <span class="hljs-comment">//roleï¼Œæƒé™è¡¨ï¼Œè¡¨ç¤ºæœ‰ä»€ä¹ˆæƒé™</span>        <span class="hljs-comment">//menuï¼ŒåŠŸèƒ½è¡¨ï¼Œè¡¨ç¤ºèƒ½åšä»€ä¹ˆ</span>        <span class="hljs-comment">//role_menuè¡¨ï¼Œè¡¨ç¤ºä»€ä¹ˆæƒé™èƒ½åšä»€ä¹ˆäº‹æƒ…</span>        <span class="hljs-comment">//userï¼Œç”¨æˆ·è¡¨ï¼Œè¡¨ç¤ºä½ æ˜¯è°</span>        <span class="hljs-comment">//user_roleè¡¨ï¼Œè¡¨ç¤ºä½ æœ‰ä»€ä¹ˆæƒé™</span>        <span class="hljs-comment">//          SELECT DISTINCT m.* FROM sys_user_role ur</span>        <span class="hljs-comment">//LEFT JOIN sys_role_menu rm ON ur.role_id = rm.role_id</span>        <span class="hljs-comment">//LEFT JOIN sys_menu m ON rm.menu_id = m.menu_id</span>        <span class="hljs-comment">//    WHERE ur.user_id = #&#123;userId&#125;</span>        <span class="hljs-comment">//é€šè¿‡ç”¨æˆ·çš„idï¼ŒæŸ¥è¯¢ä»–èƒ½å¹²ä»€ä¹ˆã€‚</span>        List&lt;SysMenuEntity&gt; sysMenuEntityList = sysUserService.selectSysMenuByUserId(selfUserEntity.getUserId());        <span class="hljs-keyword">for</span> (SysMenuEntity sysMenuEntity:sysMenuEntityList) &#123;            permissions.add(sysMenuEntity.getPermission());        &#125;        <span class="hljs-comment">// æƒé™å¯¹æ¯”</span>        <span class="hljs-keyword">if</span> (permissions.contains(permission.toString()))&#123;            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;        &#125;        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;    &#125;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">hasPermission</span><span class="hljs-params">(Authentication authentication, Serializable targetId, String targetType, Object permission)</span> </span>&#123;        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;    &#125;&#125;</code></pre></div><p><strong>è¯¦ç»†ä»£ç ä¸æ³¨é‡Š</strong>ï¼š<a href="https://gitee.com/gukkibokou/spring-boot-security-demo" target="_blank" rel="noopener">Gitee</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä¸€ä¸ªæ–°æ‰‹å¯¹äºJWTçš„è®¤è¯†&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="JavaWebå¼€å‘" scheme="http://yoursite.com/tags/JavaWeb%E5%BC%80%E5%8F%91/"/>
    
      <category term="SpringSecurity" scheme="http://yoursite.com/tags/SpringSecurity/"/>
    
      <category term="JWT" scheme="http://yoursite.com/tags/JWT/"/>
    
  </entry>
  
  <entry>
    <title>åšåˆ›4412å¼€å‘æ¿ç§»æ¤æœ€æ–°çš„ssh</title>
    <link href="http://yoursite.com/p/4119c141.html"/>
    <id>http://yoursite.com/p/4119c141.html</id>
    <published>2020-03-26T17:34:44.000Z</published>
    <updated>2020-07-09T18:47:59.392Z</updated>
    
    <content type="html"><![CDATA[<p>å’Œç¼ºå°‘èµ„æ–™çš„å¼€å‘æ¿æ–—æ™ºæ–—å‹‡çš„è¿‡ç¨‹ä¹‹å…¶ä¸‰</p><a id="more"></a><h4 id="å¹³å°"><a class="markdownIt-Anchor" href="#å¹³å°"></a> å¹³å°</h4><ol><li>UP-Tech 4412</li><li>Kubuntu 64ä½</li></ol><h4 id="é—®é¢˜"><a class="markdownIt-Anchor" href="#é—®é¢˜"></a> é—®é¢˜</h4><ol><li>ä¸²å£çš„ç¼ºç‚¹å®åœ¨æ˜¯è®©äººéš¾ä»¥å¿å—</li></ol><h4 id="å·¥å…·å’Œè½¯ä»¶"><a class="markdownIt-Anchor" href="#å·¥å…·å’Œè½¯ä»¶"></a> å·¥å…·å’Œè½¯ä»¶</h4><ol><li>2009q3çš„äº¤å‰ç¼–è¯‘å·¥å…·</li><li><a href="https://www.openssl.org/source/openssl-1.1.1e.tar.gz" target="_blank" rel="noopener">OpenSSL-1.1.1e</a></li><li><a href="ftp://mirror.internode.on.net/pub/OpenBSD/OpenSSH/portable/openssh-8.2p1.tar.gz">OpenSSH-8.2p1</a></li><li><a href="http://www.zlib.net/zlib-1.2.11.tar.gz" target="_blank" rel="noopener">zlib-1.2.11</a></li></ol><h4 id="ç§»æ¤è¿‡ç¨‹"><a class="markdownIt-Anchor" href="#ç§»æ¤è¿‡ç¨‹"></a> ç§»æ¤è¿‡ç¨‹</h4><h5 id="å‰æœŸå‡†å¤‡"><a class="markdownIt-Anchor" href="#å‰æœŸå‡†å¤‡"></a> å‰æœŸå‡†å¤‡</h5><p>â€‹å…ˆä»ä»–ä»¬å„è‡ªçš„å®˜ç½‘ä¸Šä¸‹ä¸‹æ¥æºä»£ç ã€‚ä¸ºäº†ç¡®ä¿å·¥ä½œç›®å½•çš„å¹²å‡€ï¼Œæˆ‘å°†æºç éƒ½ä¿å­˜åœ¨ä¸€ä¸ªå«åš<strong>Source_Code</strong>çš„ç›®å½•ä¸‹ï¼Œå¹¶ä¸”äº‹å…ˆåˆ›å»ºå¥½<strong>Cross</strong>è¿™ä¸ªç›®å½•ï¼Œç”¨äºä¿å­˜ç¼–è¯‘å¥½çš„åº“å’Œæ–‡ä»¶ã€‚</p><h5 id="ç¼–è¯‘zlib"><a class="markdownIt-Anchor" href="#ç¼–è¯‘zlib"></a> ç¼–è¯‘zlib</h5><p>â€‹è¿›å…¥zlibçš„æºä»£ç ç›®å½•ï¼Œæ‰§è¡Œ<code>./configure --prefix=/home/gukki/Cross_Code/Cross/zlib</code>è¿›è¡Œå¯¹<code>install</code>ç›®å½•çš„æŒ‡å®šä»¥åŠ<code>Makefile</code>çš„ç”Ÿæˆã€‚</p><p>â€‹å¯¹<code>Makefile</code>è¿›è¡Œä¿®æ”¹ï¼š</p><blockquote><p>åœ¨å¼€å¤´åŠ å…¥<code>CROSS=arm-none-linux-gnueabi-</code></p><p>å°†<code>CC=gcc</code> ä¿®æ”¹ä¸º<code>CC=$(CROSS)gcc</code></p><p>å°†<code>LDSHARED=gcc -shared -Wl,-soname,libz.so.1,--version-script,zlib.map</code> ä¿®æ”¹ä¸º</p><p><code>$(CROSS)gcc -shared -Wl,-soname,libz.so.1,--version-script,zlib.map</code></p><p>å°†<code>CPP=gcc -E</code> ä¿®æ”¹ä¸º <code>CPP=$(CROSS)gcc -E</code></p><p>å°†<code>AR=ar</code>ä¿®æ”¹ä¸º <code>AR=$(CROSS)ar</code></p></blockquote><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="/../img/image-20200326180038383.png" srcset="/img/loading.gif" alt="image-20200326180038383" /></p><p>ä¿å­˜å¹¶é€€å‡ºä¹‹åæ‰§è¡Œ<code>make &amp;&amp; make install</code>ï¼Œè¿™æ ·çš„è¯å°±å°†ç¼–è¯‘å¥½çš„zlibå®‰è£…åˆ°<strong>Cross</strong>ç›®å½•ä¸‹çš„<strong>zlib</strong>ã€‚</p><h5 id="ç¼–è¯‘openssl"><a class="markdownIt-Anchor" href="#ç¼–è¯‘openssl"></a> ç¼–è¯‘openssl</h5><p>â€‹è¿›å…¥opensslçš„æºä»£ç ç›®å½•ï¼Œæ‰§è¡Œ</p><div class="hljs"><pre><code class="hljs shell">./Configure linux-armv4 no-asm shared --prefix=/home/gukki/Cross_Code CROSS_COMPILE=/home/gukki/baidunetdiskdownload/arm-2009q3/bin/arm-none-linux-gnueabi- CC=gcc</code></pre></div><p>å…¶ä¸­ï¼š</p><p>â€‹<code>linux-armv4</code>æŒ‡å®šäº†ç›®æ ‡å¹³å°</p><p>â€‹<code>no-asm</code>è¡¨æ˜ä¸ç”Ÿæˆæ±‡ç¼–ä»£ç åŠ é€Ÿ</p><p>â€‹<code>shared</code> è¡¨æ˜ç”ŸæˆåŠ¨æ€é“¾æ¥åº“</p><p>â€‹<code>prefix</code>æŒ‡å®šäº†å®‰è£…ç›®å½•</p><p>â€‹<code>CROSS_COMPILE</code>ä½¿ç”¨ç»å¯¹è·¯å¾„åˆ¶å®šäº†äº¤å‰ç¼–è¯‘å™¨çš„ç›®å½•ã€‚</p><p>â€‹<code>CC</code> æŒ‡å®šäº†ä½¿ç”¨gcc</p><p>æ‰§è¡Œ<code>make &amp;&amp; make install</code>ï¼Œå°†ç¼–è¯‘å¥½çš„åº“å®‰è£…åˆ°äº†é¢„å…ˆæŒ‡å®šå¥½çš„ç›®å½•äº†ã€‚</p><h5 id="ç¼–è¯‘openssh"><a class="markdownIt-Anchor" href="#ç¼–è¯‘openssh"></a> ç¼–è¯‘openssh</h5><p>â€‹è¿›å…¥opensshçš„æºä»£ç ç›®å½•ï¼Œæ‰§è¡Œ</p><div class="hljs"><pre><code class="hljs shell">./configure --host=arm-none-linux-gnueabi --with-libs --with-zlib=/home/gukki/Cross_Code/Cross/zlib --with-ssl-dir=/home/gukki/Cross_Code/Cross/openssl1.1.1 --disable-etc-default-login CC=arm-none-linux-gnueabi-gcc AR=arm-none-linux-gnueabi-ar</code></pre></div><p>è¿™ä¸ªå°±ä¸ç”¨å¤šè¯´äº†ï¼Œéƒ½æ˜¯æŒ‡å®šä¹‹å‰ç¼–è¯‘å¥½çš„åº“çš„æ‰€åœ¨åœ°ä»¥åŠäº¤å‰ç¼–è¯‘å™¨ã€‚</p><p>â€‹æ‰§è¡Œ<code>make</code> ï¼Œä¸è¦æ‰§è¡Œ<code>make install</code>ï¼Œå¦åˆ™ä»–ä¼šå°†ä½ ç”Ÿæˆçš„ç¨‹åºå®‰è£…åˆ°ä¸»æœºä¸Šã€‚</p><p>â€‹ç”Ÿæˆç»“æŸä¹‹åï¼Œæˆ‘æ˜¯ç”¨äº†ç½‘ä¸Šçš„ä¸€ä¸ªå¤§ä½¬çš„è„šæœ¬ï¼Œä¸€é”®æ‰“åŒ…å¥½æ‰€æœ‰ä¸œè¥¿ï¼Œç”Ÿæˆ<code>usr.tar.bz2</code>ã€‚</p><div class="hljs"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">!/bin/bash</span>file_a="scp sftp ssh ssh-add ssh-agent ssh-keygen ssh-keyscan" file_b="moduli ssh_config sshd_config" file_c="sftp-server ssh-keysign"key="ssh_host_rsa_key ssh_host_dsa_key ssh_host_ecdsa_key ssh_host_ed25519_key"  mkdir -p usr/local/bin usr/local/etc usr/libexec mkdir usr/sbin/ for i in $file_adoif [ -f $i ];thencp $i usr/local/bin/echo "cp $i ok" elseecho "error:$i not exist "        exit_script  fidone for i in $file_bdoif [ -f $i ];thencp $i usr/local/etc/echo "cp $i ok"elseecho "error:$i not exist"exit_script fidone for i in $file_cdo    if [ -f $i ];then        cp $i usr/libexec        echo "cp $i ok"    else        echo "error:$i not exist"        exit_script    fidone if [ -f "sshd" ];thencp sshd usr/sbin/echo "cp sshd ok"elseecho "error:sshd not exist"exit_scriptfi <span class="hljs-meta">#</span><span class="bash"> ssh_host_rsa_key</span>if [ -f "ssh_host_rsa_key" ];thenecho "ssh_host_rsa_key exist"cp ssh_host_rsa_key usr/local/etc/echo "cp ssh_host_rsa_key ok" elsessh-keygen -t rsa -f ssh_host_rsa_key -N ""cp ssh_host_rsa_key usr/local/etc/echo "cp ssh_host_rsa_key ok" fi <span class="hljs-meta">#</span><span class="bash"> ssh_host_dsa_key</span>if [ -f "ssh_host_dsa_key" ];thenecho "ssh_host_dsa_key exist"cp ssh_host_dsa_key usr/local/etc/echo "cp ssh_host_dsa_key ok" elsessh-keygen -t dsa -f ssh_host_dsa_key -N ""cp ssh_host_dsa_key usr/local/etc/echo "cp ssh_host_dsa_key ok" fi <span class="hljs-meta">#</span><span class="bash"> ssh_host_ecdsa_key</span>if [ -f "ssh_host_ecdsa_key" ];thenecho "ssh_host_ecdsa_key exist"cp ssh_host_ecdsa_key usr/local/etc/echo "cp ssh_host_ecdsa_key ok" elsessh-keygen -t ecdsa -f ssh_host_ecdsa_key -N ""cp ssh_host_ecdsa_key usr/local/etc/echo "cp ssh_host_ecdsa_key ok" fi <span class="hljs-meta">#</span><span class="bash"> ssh_host_ed25519_key</span>if [ -f "ssh_host_ed25519_key" ];thenecho "ssh_host_ed25519_key exist"chmod 600 ssh_host_ed25519_keycp ssh_host_ed25519_key usr/local/etc/echo "cp ssh_host_ed25519_key ok" elsessh-keygen -t dsa -f ssh_host_ed25519_key -N ""chmod 600 ssh_host_ed25519_keycp ssh_host_ed25519_key usr/local/etc/echo "cp ssh_host_ed25519_key ok" fi tar -cjvf usr.tar.bz2 usr/*echo "pack usr to usr.tar.bz2 ok"</code></pre></div><p>ä»¥ä¸Šï¼Œåœ¨å®¿ä¸»æœºä¸Šçš„æ“ä½œç»“æŸäº†ã€‚æ¥ä¸‹æ¥æ˜¯åœ¨å¼€å‘æ¿ä¸Šçš„æ“ä½œã€‚</p><h5 id="å¼€å‘æ¿ä¸Šçš„æ“ä½œ"><a class="markdownIt-Anchor" href="#å¼€å‘æ¿ä¸Šçš„æ“ä½œ"></a> å¼€å‘æ¿ä¸Šçš„æ“ä½œ</h5><p>â€‹å°†æ‰“åŒ…å¥½çš„<code>usr.tar.bz2</code>è§£å‹åˆ°å¼€å‘æ¿çš„æ ¹ç›®å½•ï¼Œå¹¶å°è¯•æ‰§è¡Œ<code>/usr/sbin/sshd</code>æ¥å¯åŠ¨sshæœåŠ¡ï¼Œå¯èƒ½ä¼šå‡ºç°ç¼ºå°‘åŠ¨æ€é“¾æ¥åº“çš„æƒ…å†µï¼Œå¯ä»¥ä»å®¿ä¸»æœºä¸Šå¤åˆ¶è¿‡æ¥ã€‚å…¶ä¸­<code>libcrypto</code>å­˜åœ¨äºopensslçš„æºä»£ç ç›®å½•ä¸‹é¢ï¼Œ<code>libz</code>å­˜åœ¨äºzlibçš„æºä»£ç ç›®å½•ä¸­ã€‚<code>libcrypto</code>å¯ç›´æ¥å¤åˆ¶åˆ°å¼€å‘æ¿çš„<code>/lib</code>ç›®å½•ä¸‹ï¼Œè€Œ<code>libz</code>åˆ™éœ€è¦å»ºç«‹è½¯è¿æ¥ï¼š<code>ln -s /lib/libz.so.1.2.11 /lib/libz.so.1</code></p><p>â€‹ç„¶åè¿›è¡Œå¦‚ä¸‹é…ç½®</p><blockquote><p>sshçš„é…ç½®æ–‡ä»¶è¿›è¡Œä¿®æ”¹ï¼Œä»¥å…è®¸<code>root</code>ç™»å½•ï¼šä¿®æ”¹ <code>/usr/local/etc/ssh_config</code>ï¼Œå°†<code>PermitRootLogin yes</code>å‰é¢çš„æ³¨é‡Šå»æ‰ï¼Œå¦‚æœæ²¡æœ‰è¿™å¥ï¼Œå°±æ‰“è¿›å»å§ã€‚</p><p>ä¿®æ”¹<code>/etc/passwd</code>,å¢åŠ ä»¥ä¸‹ä¸‰å¥</p><blockquote><p>root: x :1000:1000:root:/root:/bin/sh<br />root : x :0:Linux User,:/home/root:/bin/sh</p><p>sshd: x :74:74:Privilege-separated SSH:/var/empty/sshd:/sbin/nologin</p></blockquote><p>xæ—è¾¹çš„ä¸¤ç©ºæ ¼è¦åˆ é™¤æ‰ï¼Œæˆ‘è¿™ä¸ªç¼–è¾‘å™¨ä¼šæŠŠä»–ä»¬æ˜¾ç¤ºä¸ºâŒâ€¦ è¿™ä¸¤å¥è¯æ˜¯ä¸ºäº†ä¿®æ”¹<code>root</code>å¯†ç çš„æ—¶å€™å‡ºç°<code>unknown uid 0</code>çš„æƒ…å†µ</p><p>æ‰§è¡Œ</p><div class="hljs"><pre><code class="hljs shell">mkdir /var/empty/sshd/etc -pcd /var/empty/sshd/etcln -s /etc/localtime localtime</code></pre></div><p>é˜²æ­¢å‡ºç°<code>Missing privilege separation directory: /var/empty/</code>è¿™ä¸ªé”™è¯¯</p></blockquote><p>â€‹å¥½äº†ï¼Œç°åœ¨ä½ å¯ä»¥å¯¹<code>root</code>å¯†ç è¿›è¡Œä¿®æ”¹ï¼Œå¹¶å¯åŠ¨sshäº†ã€‚</p><p>â€‹ä¸ºäº†å¯ä»¥å¼€æœºå¯åŠ¨sshæœåŠ¡ï¼Œéœ€è¦åœ¨<code>/etc/init.d/rcS</code>çš„æœ€åé¢åŠ ä¸Š<code>/usr/sbin/sshd &amp;</code></p><p>â€‹- wan</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å’Œç¼ºå°‘èµ„æ–™çš„å¼€å‘æ¿æ–—æ™ºæ–—å‹‡çš„è¿‡ç¨‹ä¹‹å…¶ä¸‰&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="åµŒå…¥å¼" scheme="http://yoursite.com/tags/%E5%B5%8C%E5%85%A5%E5%BC%8F/"/>
    
      <category term="è½¯ä»¶ç§»æ¤" scheme="http://yoursite.com/tags/%E8%BD%AF%E4%BB%B6%E7%A7%BB%E6%A4%8D/"/>
    
  </entry>
  
  <entry>
    <title>åœ¨Codingå’ŒGithubä¸Šè¿›è¡ŒåŒçº¿è‡ªåŠ¨åŒ–éƒ¨ç½²Hexo</title>
    <link href="http://yoursite.com/p/52f9e600.html"/>
    <id>http://yoursite.com/p/52f9e600.html</id>
    <published>2020-02-21T21:27:07.000Z</published>
    <updated>2020-07-09T18:47:59.392Z</updated>
    
    <content type="html"><![CDATA[<p>å¦‚ä½•åœ¨å›½å†…å’Œå›½å¤–è‡ªåŠ¨åŒ–æ­å»ºé™æ€åšå®¢</p><a id="more"></a><h3 id="èµ·å› "><a class="markdownIt-Anchor" href="#èµ·å› "></a> èµ·å› </h3><p>â€‹æˆ‘å‰å‡ å¤©å¼€å§‹æ­å»ºè¿™ä¸ªåšå®¢ï¼Œç”±äºä¹‹å‰æ­å»ºè¿‡å¾ˆå¤šæ¬¡ï¼Œæ‰€ä»¥æ²¡æœ‰å‡ºç°ä»€ä¹ˆæ„å¤–å°±æ­å»ºå®Œäº†ã€‚ä½†æ˜¯å½“æˆ‘æŠŠåšå®¢åœ°å€ç»™å…¶ä»–äººçš„æ—¶å€™ï¼Œä»–ä»¬æœ‰çš„ååº”æ‰“å¾—å¼€ï¼Œæœ‰çš„ååº”æ‰“ä¸å¼€ã€‚ç»è¿‡ä¸€ç•ªè°·æ­Œä¹‹åæˆ‘å‘ç°åŸå› å¯èƒ½æ˜¯gitpageçš„æœåŠ¡å™¨åœ¨å›½å¤–ï¼Œä¼šå‡ºç°åŠ è½½å¤±è´¥çš„é—®é¢˜ã€‚ä¸æ­¤åŒæ—¶æˆ‘åˆäº†è§£åˆ°å›½å†…ä¹Ÿæœ‰æä¾›ç±»ä¼¼é™æ€é¡µé¢æ‰˜ç®¡æœåŠ¡çš„å‚å®¶ï¼Œæˆ‘å°±æƒ³æŠŠåšå®¢ä¹Ÿä¸€å¹¶éƒ¨ç½²åˆ°å›½å†…çš„æœåŠ¡å™¨ä¸Šã€‚æˆ‘é€‰æ‹©äº†å¯å…è´¹ç»‘å®šåŸŸåçš„Codingï¼ˆéœ€è¦å®åè®¤è¯ï¼‰ã€‚</p><p>â€‹æˆ‘è¿™ç§ç»å¸¸å®¿èˆå®éªŒå®¤ä¸¤å¤´è·‘çš„äººæœ‰åœ¨ä¸åŒç”µè„‘ä¸Šå†™åšå®¢çš„éœ€æ±‚ï¼Œè€Œæˆ‘åˆä¸æƒ³æ¯æ¬¡éƒ½è¦æ‹·ä¸ªæºä»£ç ï¼Œäºæ˜¯ä¾¿èŒç”Ÿäº†å°†åšå®¢æºä»£ç ä¸Šä¼ åˆ°githubå»çš„æƒ³æ³•ã€‚ä½†æ˜¯è¿™æ ·ä¸€æ¥æ¯æ¬¡å†™å®Œä»£ç éƒ½è¦åšgitä¸‰è¿å’Œhexoä¸‰è¿ï¼Œå¾ˆæ˜¯éº»çƒ¦ã€‚ä¸€ç•ªæœç´¢ä¹‹åå‘ç°Appveyorå¯ä»¥å®ç°è‡ªåŠ¨åŒ–éƒ¨ç½²hexoï¼Œåªéœ€è¦æ¨é€åˆ°è¿œç¨‹ä»“åº“ï¼ŒAppveyorå°±å¯ä»¥å¸®æˆ‘è‡ªåŠ¨éƒ¨ç½²äº†ã€‚</p><p>â€‹ä½†æ˜¯å¯¹äºcodingçš„è¯ï¼Œæˆ‘ç”¨Appveyorå°±æ‰¾ä¸åˆ°ä»€ä¹ˆå¥½æ–¹æ³•äº†ã€‚æˆ‘ä»¬å¯ä»¥åˆ©ç”¨githubè‡ªå¸¦çš„Ciæ¥è¿›è¡ŒCodingçš„é™æ€é¡µé¢çš„è‡ªåŠ¨åŒ–éƒ¨ç½²ã€‚å½“ç„¶ä½ ä¹Ÿå¯ä»¥ä¸ç”¨Appveyorï¼Œç›´æ¥åˆ©ç”¨githubçš„Ciè¿›è¡Œéƒ¨ç½²ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚</p><h3 id="è¦æ±‚"><a class="markdownIt-Anchor" href="#è¦æ±‚"></a> è¦æ±‚</h3><div class="hljs"><pre><code>- ä¸€ä¸ªåŸŸå- ä¸€ä¸ªgithubè´¦æˆ·- ä¸€ä¸ªcodingè´¦æˆ·ï¼ˆéœ€è¦å®åè®¤è¯ï¼‰</code></pre></div><h3 id="è¿‡ç¨‹"><a class="markdownIt-Anchor" href="#è¿‡ç¨‹"></a> è¿‡ç¨‹</h3><h4 id="1-æ–°å»ºä»“åº“"><a class="markdownIt-Anchor" href="#1-æ–°å»ºä»“åº“"></a> 1. æ–°å»ºä»“åº“</h4><p>â€‹æˆ‘ä»¬å…ˆæ–°å»ºä¸€ä¸ªå…¬å¼€çš„æºç ä»“åº“ï¼Œç”¨äºä¿å­˜åšå®¢æºä»£ç ã€‚</p><h4 id="2-å»appveyoræ³¨å†Œ"><a class="markdownIt-Anchor" href="#2-å»appveyoræ³¨å†Œ"></a> 2. å»Appveyoræ³¨å†Œ</h4><p>â€‹<a href="https://ci.appveyor.com/signup" target="_blank" rel="noopener">æ³¨å†Œç½‘å€</a>ï¼Œé€‰æ‹©<strong>FREE-for open-source projects</strong> ,å¹¶é€‰æ‹©ä½¿ç”¨githubè´¦æˆ·ç™»å½•ã€‚</p><p><img src="/../img/image-20200223213407364.png" srcset="/img/loading.gif" alt="image-20200223213407364" /></p><h4 id="3-æ–°å»ºå¹¶åŠ å¯†ä¸€ä¸ªaccess_token"><a class="markdownIt-Anchor" href="#3-æ–°å»ºå¹¶åŠ å¯†ä¸€ä¸ªaccess_token"></a> 3. æ–°å»ºå¹¶åŠ å¯†ä¸€ä¸ªAccess_Token</h4><p>â€‹<a href="https://github.com/settings/tokens/new" target="_blank" rel="noopener">ç”³è¯·åœ°å€</a>ï¼Œè¿™æ˜¯ç”¨æ¥ç”³è¯·ä¸€ä¸ªTokenï¼ŒAppveyorå°±æ˜¯åˆ©ç”¨è¿™ä¸ªæ¥è®¿é—®ä½ çš„Githubä»“åº“çš„ï¼Œæˆ‘æŠŠæƒé™å…¨éƒ¨ç»™äº†ã€‚åœ¨æœ€ä¸Šé¢çš„Noteä¸€æ é‡Œé¢å¡«å…¥è¿™ä¸ªTokençš„åå­—ï¼Œéšæ„ã€‚</p><p>â€‹<img src="/../img/image-20200223213834567.png" srcset="/img/loading.gif" alt="image-20200223213834567" /></p><p>â€‹ç„¶åç‚¹å‡»æœ€ä¸‹é¢çš„Generate tokenã€‚å¤åˆ¶å¥½ä»–ç»™å‡ºçš„Tokenï¼Œå®ƒåªä¼šå‡ºç°ä¸€æ¬¡ï¼Œå¦‚æœä½ å¿˜è®°äº†çš„è¯ï¼Œåªèƒ½åˆ æ‰é‡æ–°ç”Ÿæˆä¸€ä¸ªäº†ã€‚</p><p><img src="/../img/image-20200223213922721.png" srcset="/img/loading.gif" alt="image-20200223213922721" /></p><p>â€‹å› ä¸ºè¿™ä¸ªä»“åº“æ˜¯å…¬å¼€çš„ï¼Œè€Œä¸”è¿™ä¸ªTokenæ˜¯è¦æ”¾åœ¨è¿™ä¸ªä»“åº“é‡Œé¢çš„ï¼Œä¸ºäº†å®‰å…¨ï¼Œæˆ‘ä»¬éœ€è¦å¯¹å®ƒè¿›è¡ŒåŠ å¯†ã€‚æ¥åˆ°<a href="https://ci.appveyor.com/tools/encrypt" target="_blank" rel="noopener">Appveyoræä¾›çš„åŠ å¯†é¡µé¢</a>ï¼Œè¾“å…¥åˆšæ‰æ–°å»ºçš„Tokenï¼Œç‚¹å‡»Encyptï¼Œå³å¯ç”ŸæˆåŠ å¯†åçš„Tokenã€‚</p><h4 id="4-æ–°å»ºappveyorçš„é…ç½®æ–‡ä»¶"><a class="markdownIt-Anchor" href="#4-æ–°å»ºappveyorçš„é…ç½®æ–‡ä»¶"></a> 4. æ–°å»ºAppveyorçš„é…ç½®æ–‡ä»¶</h4><p>â€‹åœ¨åšå®¢æºä»£ç ç›®å½•ä¸­æ–°å»ºä¸€ä¸ª<code>appveyor.yml</code>ï¼Œä½ å¯ä»¥æ ¹æ®å®˜æ–¹æ–‡æ¡£è‡ªè¡Œå¡«å†™ï¼Œä¹Ÿå¯ä»¿ç…§æˆ‘çš„ï¼š</p><div class="hljs"><pre><code class="hljs yaml"><span class="hljs-attr">clone_depth:</span> <span class="hljs-number">5</span><span class="hljs-attr">environment:</span>  <span class="hljs-attr">access_token:</span>    <span class="hljs-attr">secure:</span> <span class="hljs-string">å¡«å†™ä½ çš„åŠ å¯†åçš„Token</span><span class="hljs-attr">install:</span>  <span class="hljs-bullet">-</span> <span class="hljs-string">node</span> <span class="hljs-string">--version</span>  <span class="hljs-bullet">-</span> <span class="hljs-string">npm</span> <span class="hljs-string">--version</span>  <span class="hljs-bullet">-</span> <span class="hljs-string">npm</span> <span class="hljs-string">install</span>  <span class="hljs-bullet">-</span> <span class="hljs-string">npm</span> <span class="hljs-string">install</span> <span class="hljs-string">hexo-cli</span> <span class="hljs-string">-g</span><span class="hljs-attr">build_script:</span>  <span class="hljs-bullet">-</span> <span class="hljs-string">hexo</span> <span class="hljs-string">generate</span><span class="hljs-attr">artifacts:</span>  <span class="hljs-bullet">-</span> <span class="hljs-attr">path:</span> <span class="hljs-string">public</span><span class="hljs-attr">on_success:</span>  <span class="hljs-bullet">-</span> <span class="hljs-string">git</span> <span class="hljs-string">config</span> <span class="hljs-string">--global</span> <span class="hljs-string">credential.helper</span> <span class="hljs-string">store</span>  <span class="hljs-bullet">-</span> <span class="hljs-attr">ps:</span> <span class="hljs-string">Add-Content</span> <span class="hljs-string">"$env:USERPROFILE\.git-credentials"</span> <span class="hljs-string">"https://$($env:access_token):x-oauth-basic@github.com`n"</span>  <span class="hljs-bullet">-</span> <span class="hljs-string">git</span> <span class="hljs-string">config</span> <span class="hljs-string">--global</span> <span class="hljs-string">user.email</span> <span class="hljs-string">"%GIT_USER_EMAIL%"</span>  <span class="hljs-bullet">-</span> <span class="hljs-string">git</span> <span class="hljs-string">config</span> <span class="hljs-string">--global</span> <span class="hljs-string">user.name</span> <span class="hljs-string">"%GIT_USER_NAME%"</span>  <span class="hljs-bullet">-</span> <span class="hljs-string">git</span> <span class="hljs-string">clone</span> <span class="hljs-string">--depth</span> <span class="hljs-number">5</span> <span class="hljs-string">-q</span> <span class="hljs-string">--branch=%TARGET_BRANCH%</span> <span class="hljs-string">%STATIC_SITE_REPO%</span> <span class="hljs-string">%TEMP%\static-site</span>  <span class="hljs-bullet">-</span> <span class="hljs-string">cd</span> <span class="hljs-string">%TEMP%\static-site</span>  <span class="hljs-bullet">-</span> <span class="hljs-string">del</span> <span class="hljs-string">*</span> <span class="hljs-string">/f</span> <span class="hljs-string">/q</span>  <span class="hljs-bullet">-</span> <span class="hljs-string">for</span> <span class="hljs-string">/d</span> <span class="hljs-string">%%p</span> <span class="hljs-string">IN</span> <span class="hljs-string">(*)</span> <span class="hljs-string">do</span> <span class="hljs-string">rmdir</span> <span class="hljs-string">"%%p"</span> <span class="hljs-string">/s</span> <span class="hljs-string">/q</span>  <span class="hljs-bullet">-</span> <span class="hljs-string">SETLOCAL</span> <span class="hljs-string">EnableDelayedExpansion</span> <span class="hljs-string">&amp;</span> <span class="hljs-string">robocopy</span> <span class="hljs-string">"%APPVEYOR_BUILD_FOLDER%\public"</span> <span class="hljs-string">"%TEMP%\static-site"</span> <span class="hljs-string">/e</span> <span class="hljs-string">&amp;</span> <span class="hljs-string">IF</span> <span class="hljs-type">!ERRORLEVEL</span><span class="hljs-string">!</span> <span class="hljs-string">EQU</span> <span class="hljs-number">1</span> <span class="hljs-string">(exit</span> <span class="hljs-number">0</span><span class="hljs-string">)</span> <span class="hljs-string">ELSE</span> <span class="hljs-string">(IF</span> <span class="hljs-type">!ERRORLEVEL</span><span class="hljs-string">!</span> <span class="hljs-string">EQU</span> <span class="hljs-number">3</span> <span class="hljs-string">(exit</span> <span class="hljs-number">0</span><span class="hljs-string">)</span> <span class="hljs-string">ELSE</span> <span class="hljs-string">(exit</span> <span class="hljs-number">1</span><span class="hljs-string">))</span>  <span class="hljs-bullet">-</span> <span class="hljs-string">git</span> <span class="hljs-string">add</span> <span class="hljs-string">-A</span>  <span class="hljs-bullet">-</span> <span class="hljs-string">if</span> <span class="hljs-string">"%APPVEYOR_REPO_BRANCH%"</span><span class="hljs-string">=="master"</span> <span class="hljs-string">if</span> <span class="hljs-string">not</span> <span class="hljs-string">defined</span> <span class="hljs-string">APPVEYOR_PULL_REQUEST_NUMBER</span> <span class="hljs-string">(git</span> <span class="hljs-string">diff</span> <span class="hljs-string">--quiet</span> <span class="hljs-string">--exit-code</span> <span class="hljs-string">--cached</span> <span class="hljs-string">||</span> <span class="hljs-string">git</span> <span class="hljs-string">commit</span> <span class="hljs-string">-m</span> <span class="hljs-string">"Update Static Site"</span> <span class="hljs-string">&amp;&amp;</span> <span class="hljs-string">git</span> <span class="hljs-string">push</span> <span class="hljs-string">origin</span> <span class="hljs-string">%TARGET_BRANCH%</span> <span class="hljs-string">&amp;&amp;</span> <span class="hljs-string">appveyor</span> <span class="hljs-string">AddMessage</span> <span class="hljs-string">"Static Site Updated"</span><span class="hljs-string">)</span></code></pre></div><p>â€‹å…¶ä¸­<code>GIT_USER_EMAIL</code>,<code>GIT_USER_NAME</code>,<code>TARGET_BRANCH</code>,<code>STATIC_SITE_REPO</code>ï¼Œä»–ä»¬åˆ†åˆ«æ˜¯gitçš„ç”¨é‚®ç®±ã€ç”¨æˆ·åã€å¾…éƒ¨ç½²ä»“åº“çš„ç›®æ ‡åˆ†æ”¯ï¼Œå¾…éƒ¨ç½²çš„ç›®æ ‡ä»“åº“ï¼ˆä½ çš„é™æ€é¡µé¢çš„githubåœ°å€ï¼‰ã€‚è¿™å‡ ä¸ªéƒ½æ˜¯è¦æˆ‘ä»¬å»Appveyoré‡Œé¢è®¾ç½®çš„ç¯å¢ƒå˜é‡ã€‚</p><h4 id="5-appveyorçš„é…ç½®"><a class="markdownIt-Anchor" href="#5-appveyorçš„é…ç½®"></a> 5. Appveyorçš„é…ç½®</h4><p>â€‹å›åˆ°Appveyorï¼Œç‚¹å‡»New Project</p><p><img src="/../img/image-20200223214015897.png" srcset="/img/loading.gif" alt="image-20200223214015897" /></p><p>â€‹é€‰æ‹©githubé‡Œé¢ä½ çš„åšå®¢æºä»£ç ç›®å½•ï¼Œç‚¹å‡»å³ä¾§çš„Addï¼Œåœ¨æ–°é¡µé¢é€‰æ‹©setting</p><p><img src="/../img/image-20200223214102188.png" srcset="/img/loading.gif" alt="image-20200223214102188" /></p><p>â€‹é€‰æ‹©Environmentï¼Œæ·»åŠ ç¬¬å››ç‚¹æ‰€è¯´çš„çš„ç¯å¢ƒå˜é‡</p><p>â€‹<img src="/../img/image-20200223215652016.png" srcset="/img/loading.gif" alt="image-20200223215652016" /></p><p>â€‹ç‚¹å‡»Saveä¿å­˜å¥½é…ç½®ã€‚</p><p>â€‹ä¹‹åï¼Œä½ åªè¦æŠŠä½ çš„åšå®¢æºä»£ç æ¨é€åˆ°è¿œç¨‹ä»“åº“ä¹‹åï¼ŒAppveyorä¼šè‡ªåŠ¨æ£€æµ‹åˆ°ä½ çš„æ¨é€å¹¶è¿›è¡Œè‡ªåŠ¨åŒ–éƒ¨ç½²ã€‚ç±»ä¼¼è¿™æ ·ï¼š</p><p>â€‹<img src="/../img/image-20200223220116830.png" srcset="/img/loading.gif" alt="image-20200223220116830" /></p><p>â€‹å¹¶ä¸”å¯ä»¥å†ä½ çš„æºä»£ç ä»“åº“é‡Œé¢æŸ¥çœ‹æ˜¯å¦éƒ¨ç½²æˆåŠŸï¼š</p><p><img src="/../img/image-20200223220259404.png" srcset="/img/loading.gif" alt="image-20200223220259404" /></p><p>â€‹</p><h4 id="6-å¯¹codingè¿›è¡Œè‡ªåŠ¨éƒ¨ç½²"><a class="markdownIt-Anchor" href="#6-å¯¹codingè¿›è¡Œè‡ªåŠ¨éƒ¨ç½²"></a> 6. å¯¹Codingè¿›è¡Œè‡ªåŠ¨éƒ¨ç½²</h4><p>â€‹æ¥åˆ°Codingçš„<a href="https://coding.net/" target="_blank" rel="noopener">å®˜ç½‘</a>ï¼Œç‚¹å‡»ä¸ªäººç‰ˆç™»å½•ï¼Œæ–°å»ºä¸€ä¸ªDevOpsé¡¹ç›®ï¼Œå»ºè®®é¡¹ç›®åç§°è·Ÿä½ çš„ç”¨æˆ·åä¸€è‡´ã€‚åœ¨å³ä¾§çš„â€œæ„å»ºä¸éƒ¨ç½²â€å¤„é€‰æ‹©é™æ€ç½‘ç«™ï¼Œé€‰æ‹©ç«‹å³å‘å¸ƒé™æ€ç½‘ç«™ï¼Œç½‘ç«™åç§°éšæ„ã€‚</p><p>â€‹ç„¶åè¿›å…¥åˆ°ä¸ªäººè®¾ç½®ï¼Œç‚¹å‡»è®¿é—®ä»¤ç‰Œ</p><p><img src="/../img/image-20200223221358546.png" srcset="/img/loading.gif" alt="image-20200223221358546" /></p><p>â€‹è¿™ä¸ªç±»ä¼¼äºgithubçš„Access_Token,åœ¨è¿™é‡Œæˆ‘ä¹Ÿæ˜¯æŠŠæƒé™å…¨ç»™äº†ã€‚</p><p>â€‹åˆ›å»ºå®Œæˆåè®°ä½ä»¤ç‰Œå’Œä»¤ç‰Œç”¨æˆ·åã€‚å›åˆ°githubçš„åšå®¢æºä»£ç ä»“åº“ï¼Œé€‰æ‹©ä¸Šæ–¹çš„Actionsï¼Œè¿™ä¸ªä¹Ÿå°±æ˜¯githubçš„Ciï¼Œé€‰æ‹©<strong>Set up a workflow yourself</strong></p><p><img src="/../img/image-20200223221848554.png" srcset="/img/loading.gif" alt="image-20200223221848554" /></p><p>â€‹åœ¨å‡ºç°çš„ç¼–è¾‘çª—å£é‡Œé¢ï¼Œç”¨ä¸‹é¢çš„æ–‡æœ¬æ›¿æ¢æ‰é‡Œé¢çš„å†…å®¹ï¼ˆçŸ¥ä¹ä¸Šçš„ä¸€ä¸ªå¤§ä½¬çš„é…ç½®ï¼‰</p><div class="hljs"><pre><code class="hljs yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">è‡ªåŠ¨éƒ¨ç½²</span> <span class="hljs-string">Hexo</span><span class="hljs-attr">on:</span>  <span class="hljs-attr">push:</span>    <span class="hljs-attr">branches:</span>      <span class="hljs-bullet">-</span> <span class="hljs-string">master</span><span class="hljs-attr">jobs:</span>  <span class="hljs-attr">build:</span>    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>    <span class="hljs-attr">strategy:</span>      <span class="hljs-attr">matrix:</span>        <span class="hljs-attr">node-version:</span> <span class="hljs-string">[10.x]</span>    <span class="hljs-attr">steps:</span>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">å¼€å§‹è¿è¡Œ</span>        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v1</span>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">è®¾ç½®</span> <span class="hljs-string">Node.js</span> <span class="hljs-string">$&#123;&#123;</span> <span class="hljs-string">matrix.node-version</span> <span class="hljs-string">&#125;&#125;</span>        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/setup-node@v1</span>        <span class="hljs-attr">with:</span>          <span class="hljs-attr">node-version:</span> <span class="hljs-string">$&#123;&#123;</span> <span class="hljs-string">matrix.node-version</span> <span class="hljs-string">&#125;&#125;</span>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">å®‰è£…</span> <span class="hljs-string">Hexo</span> <span class="hljs-string">CI</span>        <span class="hljs-attr">run:</span> <span class="hljs-string">|</span>          <span class="hljs-string">export</span> <span class="hljs-string">TZ='Asia/Shanghai'</span>          <span class="hljs-string">npm</span> <span class="hljs-string">install</span> <span class="hljs-string">hexo-cli</span> <span class="hljs-string">-g</span>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">ç¼“å­˜</span>        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/cache@v1</span>        <span class="hljs-attr">id:</span> <span class="hljs-string">cache-dependencies</span>        <span class="hljs-attr">with:</span>          <span class="hljs-attr">path:</span> <span class="hljs-string">node_modules</span>          <span class="hljs-attr">key:</span> <span class="hljs-string">$&#123;&#123;runner.OS&#125;&#125;-$&#123;&#123;hashFiles('**/package-lock.json')&#125;&#125;</span>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">å®‰è£…æ’ä»¶</span>        <span class="hljs-attr">if:</span> <span class="hljs-string">steps.cache-dependencies.outputs.cache-hit</span> <span class="hljs-string">!=</span> <span class="hljs-string">'true'</span>        <span class="hljs-attr">run:</span> <span class="hljs-string">|</span>          <span class="hljs-string">npm</span> <span class="hljs-string">install</span>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">éƒ¨ç½²åšå®¢</span>        <span class="hljs-attr">run:</span> <span class="hljs-string">|</span>          <span class="hljs-string">hexo</span> <span class="hljs-string">clean</span> <span class="hljs-string">&amp;&amp;</span> <span class="hljs-string">hexo</span> <span class="hljs-string">g</span>          <span class="hljs-string">cd</span> <span class="hljs-string">./public</span>          <span class="hljs-string">git</span> <span class="hljs-string">init</span>          <span class="hljs-string">git</span> <span class="hljs-string">config</span> <span class="hljs-string">user.name</span> <span class="hljs-string">"$<span class="hljs-template-variable">&#123;&#123;secrets.GIT_NAME&#125;&#125;</span>"</span>          <span class="hljs-string">git</span> <span class="hljs-string">config</span> <span class="hljs-string">user.email</span> <span class="hljs-string">"$<span class="hljs-template-variable">&#123;&#123;secrets.GIT_EMAIL&#125;&#125;</span>"</span>          <span class="hljs-string">git</span> <span class="hljs-string">add</span> <span class="hljs-string">.</span>          <span class="hljs-string">git</span> <span class="hljs-string">commit</span> <span class="hljs-string">-m</span> <span class="hljs-string">"Update"</span>          <span class="hljs-string">git</span> <span class="hljs-string">push</span> <span class="hljs-string">--force</span> <span class="hljs-string">--quiet</span> <span class="hljs-string">"https://$<span class="hljs-template-variable">&#123;&#123;secrets.CD_TOKEN&#125;&#125;</span>@$<span class="hljs-template-variable">&#123;&#123;secrets.CD_REF&#125;&#125;</span>"</span> <span class="hljs-string">master:master</span></code></pre></div><p>â€‹å…¶ä¸­ï¼Œä»¥<code>secrets.</code>å¼€å¤´çš„å››ä¸ªå˜é‡æ˜¯éœ€è¦æˆ‘ä»¬å»è®¾ç½®çš„ç¯å¢ƒå˜é‡ã€‚ ç‚¹å‡»å³è¾¹çš„Start commitä¿å­˜ã€‚</p><p>â€‹æˆ‘ä»¬è¿›å…¥æºç ä»“åº“çš„ç¯å¢ƒå˜é‡è®¾ç½®ï¼Œå…¶ä½ç½®å¦‚ä¸‹ï¼š</p><p>â€‹<img src="/../img/image-20200223222546211.png" srcset="/img/loading.gif" alt="image-20200223222546211" /></p><p>â€‹è¿™å››ä¸ªå˜é‡çš„æ„æ€åˆ†åˆ«å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š</p><table><thead><tr><th style="text-align:center">å˜é‡</th><th style="text-align:center">æ„æ€</th></tr></thead><tbody><tr><td style="text-align:center">GIT_NAME</td><td style="text-align:center">gitçš„ç”¨æˆ·å</td></tr><tr><td style="text-align:center">GIT_EMAIL</td><td style="text-align:center">gitçš„é‚®ç®±</td></tr><tr><td style="text-align:center">CD_REF</td><td style="text-align:center">codingçš„é™æ€é¡µé¢çš„ä»“åº“åœ°å€</td></tr><tr><td style="text-align:center">CD_TOKEN</td><td style="text-align:center">codingçš„ä»¤ç‰Œç”¨æˆ·å:codingçš„ä»¤ç‰Œ</td></tr></tbody></table><p>å…¶ä¸­CD_REFåœ¨ä½ çš„Codingçš„å³ä¸Šæ–¹å¯ä»¥çœ‹åˆ°ï¼Œæ”¹æˆsshä¹‹å@åé¢çš„å°±æ˜¯CD_REFäº†ã€‚</p><p><img src="/../img/image-20200223223844299.png" srcset="/img/loading.gif" alt="image-20200223223844299" /></p><p>ä»¥åæˆ‘ä»¬æ¯æ¬¡å†™å®Œæ–‡ç« ï¼Œç›´æ¥gitä¸‰è¿å°±å¯ä»¥è‡ªåŠ¨åŒ–éƒ¨ç½²åˆ°ä¸¤ä¸ªé™æ€é¡µé¢æ‰˜ç®¡ä»“åº“äº†ã€‚</p><h4 id="7-åŸŸåç»‘å®š"><a class="markdownIt-Anchor" href="#7-åŸŸåç»‘å®š"></a> 7. åŸŸåç»‘å®š</h4><p>â€‹æˆ‘ä»¬å¯ä»¥å¯¹åŸŸåçš„dnsè§£æè®°å½•è¿›è¡Œä¿®æ”¹ï¼Œå®ç°å›½å†…ç”¨æˆ·è®¿é—®çš„æ˜¯codingä¸Šçš„é¡µé¢ï¼Œå›½å¤–ç”¨æˆ·è®¿é—®githubä¸Šçš„é¡µé¢ã€‚</p><p>â€‹ä¸€å›¾æµï¼š</p><p>â€‹<img src="/../img/image-20200223225143011.png" srcset="/img/loading.gif" alt="image-20200223225143011" /></p><p>â€‹å¦‚æœä½ çš„codingç«™ç‚¹æ— æ³•ç”³è¯·åˆ°è¯ä¹¦ï¼Œè¯·æš‚åœä¸‹å¢ƒå¤–çš„è§£æã€‚</p><p>â€‹-å®Œ</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å¦‚ä½•åœ¨å›½å†…å’Œå›½å¤–è‡ªåŠ¨åŒ–æ­å»ºé™æ€åšå®¢&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="Hexo" scheme="http://yoursite.com/tags/Hexo/"/>
    
      <category term="æ²¡æœ‰ç”¨çš„çŸ¥è¯†" scheme="http://yoursite.com/tags/%E6%B2%A1%E6%9C%89%E7%94%A8%E7%9A%84%E7%9F%A5%E8%AF%86/"/>
    
      <category term="è‡ªåŠ¨åŒ–éƒ¨ç½²" scheme="http://yoursite.com/tags/%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2/"/>
    
  </entry>
  
  <entry>
    <title>åŸºäº4412çš„opencvçš„ç§»æ¤(é™„å¸¦contrib)</title>
    <link href="http://yoursite.com/p/42ae8816.html"/>
    <id>http://yoursite.com/p/42ae8816.html</id>
    <published>2020-02-20T19:55:33.000Z</published>
    <updated>2020-07-09T18:47:59.392Z</updated>
    
    <content type="html"><![CDATA[<p>å’Œç¼ºå°‘èµ„æ–™çš„å¼€å‘æ¿æ–—æ™ºæ–—å‹‡çš„è¿‡ç¨‹ä¹‹å…¶ä¸€</p><a id="more"></a><h4 id="å¹³å°"><a class="markdownIt-Anchor" href="#å¹³å°"></a> å¹³å°</h4><ol><li>UP-Tech 4412</li><li>Kubuntu 18.04LTS 64ä½</li></ol><h4 id="ä½¿ç”¨çš„å·¥å…·"><a class="markdownIt-Anchor" href="#ä½¿ç”¨çš„å·¥å…·"></a> ä½¿ç”¨çš„å·¥å…·</h4><ol><li>2013ç‰ˆçš„äº¤å‰ç¼–è¯‘å·¥å…·(arm-2013.05-24-arm-none-linux-gnueabi)</li><li>opencv_3.4.9</li><li>opencv_contrib_3.4.9</li><li>cmake-gui</li></ol><h4 id="èµ·å› "><a class="markdownIt-Anchor" href="#èµ·å› "></a> èµ·å› </h4><ol><li>æ”¾å‡ä¹‹å‰ç”¨çš„è™šæ‹Ÿæœºè¢«æˆ‘åˆ é™¤äº†ï¼Œé‡Œé¢çš„æ–‡ä»¶éƒ½æ²¡äº†ã€‚</li><li>å¼€å‘æ¿çš„æ–‡ä»¶ç³»ç»Ÿè¢«æˆ‘æŠ˜è…¾åäº†</li><li>éœ€è¦é‡æ–°ç§»æ¤opencv</li></ol><h4 id="è¿‡ç¨‹"><a class="markdownIt-Anchor" href="#è¿‡ç¨‹"></a> è¿‡ç¨‹ï¼š</h4><h5 id="1-ä¸‹è½½æ‰€éœ€è½¯ä»¶ä»¥åŠæºä»£ç "><a class="markdownIt-Anchor" href="#1-ä¸‹è½½æ‰€éœ€è½¯ä»¶ä»¥åŠæºä»£ç "></a> 1. ä¸‹è½½æ‰€éœ€è½¯ä»¶ä»¥åŠæºä»£ç </h5><p>â€‹é¦–å…ˆä¸‹è½½å¥½æˆ‘ä»¬éœ€è¦ä½¿ç”¨åˆ°çš„å„ä¸ªæ–‡ä»¶ï¼Œä»–ä»¬çš„ä¸‹è½½é“¾æ¥å¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class="hljs"><pre><code class="hljs perl">arm-<span class="hljs-number">2013.05</span>-<span class="hljs-number">24</span>-arm-none-linux-gnueabié“¾æ¥ï¼šhttp:<span class="hljs-regexp">//pan</span>.baidu.com/<span class="hljs-keyword">s</span>/<span class="hljs-number">1</span>i3gNttFopencv_3.<span class="hljs-number">4.9</span>é“¾æ¥ï¼šhttps:<span class="hljs-regexp">//github</span>.com/opencv/opencv/archive/<span class="hljs-number">3.4</span>.<span class="hljs-number">9</span>.tar.gzopencv_contrib_3.<span class="hljs-number">4.9</span> é“¾æ¥ï¼šhttps:<span class="hljs-regexp">//github</span>.com/opencv/opencv_contrib/archive/<span class="hljs-number">3.4</span>.<span class="hljs-number">9</span>.tar.gz</code></pre></div><p>è‡³äºcmake-guiçš„è¯ï¼Œå¦‚æœä½ ä½¿ç”¨çš„æ˜¯ububtuï¼Œç›´æ¥åœ¨ç»ˆç«¯è¾“å…¥<code>sudo apt install cmake-gui</code>å³å¯ã€‚</p><p>å°†äº¤å‰ç¼–è¯‘å™¨è§£å‹å¥½ï¼Œè¿™é‡Œæˆ‘çš„æ˜¯<code>/home/gukki/baidunetdiskdownload/arm-2013.05/</code></p><p>å°†ä¸‹è½½å¹¶è§£å‹å¥½çš„ä¸¤ä»½æºä»£ç æ”¾åœ¨åŒä¸€ä¸ªç›®å½•ã€‚</p><h5 id="2-ä½¿ç”¨cmake-guiè¿›è¡Œäº¤å‰ç¼–è¯‘"><a class="markdownIt-Anchor" href="#2-ä½¿ç”¨cmake-guiè¿›è¡Œäº¤å‰ç¼–è¯‘"></a> 2. ä½¿ç”¨cmake-guiè¿›è¡Œäº¤å‰ç¼–è¯‘</h5><p>â€‹æ‰“å¼€cmakeï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼šï¼ˆåªæˆªå–äº†ä¸ŠåŠéƒ¨åˆ†ï¼‰</p><p><img src="/../img/image-20200220202805847.png" srcset="/img/loading.gif" alt="image-20200220202805847" /></p><p>â€‹ç¬¬ä¸€è¡Œæ˜¯è¦æ±‚ä½ è¾“å…¥ä½ çš„opencvçš„æºä»£ç çš„ç»å¯¹è·¯å¾„ï¼Œåœ¨è¿™é‡Œæˆ‘çš„è·¯å¾„æ˜¯<code>/home/gukki/OpenCv/Source_Code/opencv-3.4.9</code>ï¼Œç¬¬äºŒè¡Œè¦æ±‚ä½ å¡«å†™é…ç½®å¥½çš„æºä»£ç çš„ä¿å­˜è·¯å¾„ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘çš„æ˜¯<code>/home/gukki/OpenCv/Process_Code</code>ã€‚</p><p>â€‹å¡«å†™å®Œæ¯•ä¹‹åç‚¹å‡»<code>Configure</code>ï¼Œcmakeè¦æ±‚ä½ é€‰æ‹©ç¼–è¯‘å·¥å…·ï¼Œç”±äºæˆ‘ä»¬æ˜¯äº¤å‰ç¼–è¯‘ï¼Œæˆ‘ä»¬é€‰æ‹©æœ€åä¸€é¡¹ã€‚ç‚¹å‡»ä¸‹ä¸€æ­¥ä¹‹åå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="/../img/image-20200220203339941.png" srcset="/img/loading.gif" alt="image-20200220203339941" /></p><p>â€‹å…¶ä¸­<code>Operating System</code>é¡¾åæ€ä¹‰ï¼Œæ“ä½œç³»ç»Ÿï¼Œæˆ‘ä»¬çš„å¼€å‘æ¿ä¸Šç”¨çš„æ˜¯Linuxï¼Œå°±å†™ä¸Šå§ã€‚</p><p><code>C</code>è¦æ±‚ä½ æŒ‡å®šå¥½äº¤å‰ç¼–è¯‘å™¨çš„Cç¼–è¯‘å™¨ï¼Œä¹Ÿå°±æ˜¯arm-gccçš„æ‰€åœ¨åœ°ã€‚</p><p><code>C++</code>åŒç†ï¼Œä¹Ÿæ˜¯è¦æ±‚ä½ å¡«ä¸Šarm-g++çš„æ‰€åœ¨åœ°ï¼Œè€Œ<code>Target Root</code>å¡«å†™ä¸Šä½ äº¤å‰ç¼–è¯‘å™¨çš„ç›®å½•ã€‚</p><p>â€‹å¡«å†™å®Œæˆä¹‹åç‚¹å‡»å®Œæˆã€‚</p><p>â€‹é…ç½®å®Œæˆä¹‹ååº”è¯¥ä¼šæ˜¯ä¸€ç‰‡çº¢è‰²ï¼Œå¹¶ä¸”å·¦ä¸‹è§’çš„æ–‡æœ¬æ˜¾ç¤ºåŒºåŸŸæœ‰ä¸€å¥<code>Configuring done</code>ã€‚</p><p>æˆ‘ä»¬å¯¹æˆ‘ä»¬çš„éœ€æ±‚è¿›è¡Œå¯¹opencvçš„è£å‰ªï¼š</p><blockquote><p>åœ¨æœç´¢æ åŒºåŸŸè¾“å…¥JPEG,å‹¾é€‰ä¸Š<code>BUILD_JPEG</code></p><p>è¾“å…¥PNG,å‹¾é€‰ä¸Š<code>BULID_PNG</code></p><p>è¾“å…¥nonfreeï¼Œå‹¾é€‰ä¸Š</p><p>è¾“å…¥gtkï¼Œå–æ¶ˆå‹¾é€‰ï¼Œå› ä¸ºæˆ‘ä»¬ç”¨ä¸ä¸Šå›¾å½¢ç•Œé¢</p><p>è¾“å…¥zlibï¼Œå‹¾é€‰ä¸Š</p><p>è¾“å…¥extraï¼Œåœ¨<code>Value</code>ä¸€æ ä¸Šç‚¹å‡»å³è¾¹çš„ä¸‰ä¸ªç‚¹ï¼Œå®šä½å¥½ä½ çš„<code>opencv_contrib</code>çš„<code>moudules</code>æ–‡ä»¶å¤¹ã€‚</p><p>è¾“å…¥prefixï¼Œè¾“å…¥ä½ æƒ³å®‰è£…åˆ°çš„æ–‡ä»¶å¤¹è·¯å¾„ã€‚ç­‰ä¼š<code>make install</code>æ—¶ä¼šå®‰è£…åˆ°è¿™é‡Œã€‚</p></blockquote><p>â€‹é…ç½®å®Œæˆä¹‹åç‚¹å‡»<code>Configure</code>ï¼Œæ­¤æ—¶ä½ åº”è¯¥è¦ä¸‹è½½ä¸€äº›æœ‰å…³é™„åŠ æ¨¡å—çš„ä¸€äº›æ–‡ä»¶ï¼Œå¯èƒ½éœ€è¦å¾ˆä¹…ï¼Œç­‰ä¸åŠçš„å°±ä¸å»é…ç½®extraã€‚ä¸‹è½½å®Œæˆä¹‹åï¼Œå¯ä»¥å†æ¬¡å¯¹é¢å¤–æ¨¡å—è¿›è¡Œè£å‰ªï¼Œæ ¹æ®ä½ çš„éœ€æ±‚æ¥å®šã€‚è£å‰ªå®Œæˆä¹‹åï¼Œå†æ¬¡ç‚¹å‡»<code>Configure</code>ï¼Œåº”è¯¥ä¸ä¼šå‡ºç°çº¢è‰²äº†ã€‚</p><p>ç‚¹å‡»<code>Generate</code>ç”Ÿæˆå·¥ç¨‹æ–‡ä»¶ã€‚</p><h5 id="3ç¼–è¯‘æ–‡ä»¶"><a class="markdownIt-Anchor" href="#3ç¼–è¯‘æ–‡ä»¶"></a> 3.ç¼–è¯‘æ–‡ä»¶</h5><p>â€‹è¿›å…¥ä½ çš„é…ç½®å¥½çš„æºä»£ç çš„æ–‡ä»¶å¤¹ï¼Œåœ¨æ­¤å¤„æ‰“å¼€ç»ˆç«¯ï¼Œè¾“å…¥<code>make</code>å¼€å§‹ç¼–è¯‘ï¼Œæ ¹æ®è‡ªèº«è™šæ‹Ÿæœºé…ç½®æƒ…å†µï¼Œå¯åœ¨åé¢åŠ ä¸Š<code>-j çº¿ç¨‹æ•°</code>è¿™ä¸ªå‚æ•°ï¼Œæˆ‘ç»™è™šæ‹Ÿæœºåˆ†é…äº†8ä¸ªæ ¸å¿ƒï¼Œæ‰€ä»¥æˆ‘ç¼–è¯‘é€Ÿåº¦æ¯”è¾ƒå¿«ï¼Œåªç”¨äº†5åˆ†é’Ÿå·¦å³ã€‚å¦‚æœä½ ä»€ä¹ˆéƒ½æ²¡åŠ ï¼Œé¢„è®¡æ—¶é—´å¯èƒ½æ˜¯åŠå°æ—¶åˆ°ä¸€å°æ—¶å·¦å³ã€‚ä¸­é—´å¯èƒ½æœ‰äº›è­¦å‘Šï¼Œæ— é¡»ç†ä¼šã€‚åªè¦æ²¡åœä¸‹æ¥å°±å¥½ã€‚</p><p><img src="/../img/image-20200220210124846.png" srcset="/img/loading.gif" alt="image-20200220210124846" /></p><p>å¯ä»¥çœ‹åˆ°å¤„ç†å™¨æ˜¯è¢«åƒæ»¡çš„ã€‚</p><p>â€‹ç¼–è¯‘å®Œæˆåè¾“å…¥<code>make install</code>ï¼Œå¯èƒ½éœ€è¦ä½ åŠ ä¸ª<code>sudo</code>ä»€ä¹ˆçš„â€¦</p><p>â€‹å®‰è£…å®Œæˆä¹‹åå¯ä»¥å»è®¾å®šçš„<code>prefix</code>æ–‡ä»¶å¤¹å»çœ‹çœ‹ã€‚åº”è¯¥é•¿è¿™æ ·ï¼š</p><p><img src="/../img/image-20200220210712344.png" srcset="/img/loading.gif" alt="image-20200220210712344" /></p><p>â€‹å…¶ä¸­<code>lib</code>é‡Œé¢æ˜¯æˆ‘ä»¬ç¼–è¯‘å¥½çš„åº“æ–‡ä»¶ï¼Œä½¿ç”¨<code>file</code>å‘½ä»¤æŸ¥çœ‹ç±»å‹ï¼š</p><p><img src="/../img/image-20200220210841342.png" srcset="/img/loading.gif" alt="image-20200220210841342" /></p><p>â€‹æˆåŠŸäº†å¤§åŠäº†ï¼</p><h5 id="4-ç§»æ¤åˆ°å¼€å‘æ¿ä¸Š"><a class="markdownIt-Anchor" href="#4-ç§»æ¤åˆ°å¼€å‘æ¿ä¸Š"></a> 4. ç§»æ¤åˆ°å¼€å‘æ¿ä¸Š</h5><p>â€‹å°†<code>lib</code>æ–‡ä»¶å¤¹é‡Œé¢çš„æ‰€æœ‰æ–‡ä»¶å…¨éƒ¨ä¼ åˆ°å¼€å‘æ¿çš„<code>/lib</code>ï¼Œç›®å½•ä¸‹é¢ï¼Œä½¿ç”¨<code>nfs</code>é€Ÿåº¦ä¼šå¿«å¾ˆå¤šã€‚</p><p>â€‹ç”±äºæˆ‘ä»¬ä½¿ç”¨äº†è¾ƒæ–°ç‰ˆæœ¬çš„<code>arm_gcc</code>ç¼–è¯‘å·¥å…·é“¾ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æŠŠäº¤å‰ç¼–è¯‘å·¥å…·é“¾é‡Œé¢çš„<code>libstdc++.so,libstdc++.so.6,libstdc++6.0.17</code>ä¸€èµ·å¤åˆ¶è¿‡å»å¹¶è¦†ç›–ã€‚ä»–ä»¬ä½äº<code>arm-2013.05/arm-none-linux-gnueabi/libc/usr/lib/</code>è¿™ä¸ªåœ°æ–¹ã€‚</p><h5 id="5-è™šæ‹Ÿæœºç¼–è¯‘è®¾ç½®"><a class="markdownIt-Anchor" href="#5-è™šæ‹Ÿæœºç¼–è¯‘è®¾ç½®"></a> 5. è™šæ‹Ÿæœºç¼–è¯‘è®¾ç½®</h5><p>â€‹ä¸ºäº†è®©è™šæ‹ŸæœºçŸ¥é“opecvçš„å¤´æ–‡ä»¶å’Œåº“æ–‡ä»¶çš„ä½ç½®ï¼Œæˆ‘ä»¬éœ€è¦å€ŸåŠ©ä¸€ä¸ªå«åš<code>pkg-config</code> çš„è½¯ä»¶ï¼Œ å®‰è£…ä¹Ÿæ˜¯å¯ä»¥ç”¨<code>apt</code>æ¥å®‰è£…çš„ã€‚æˆ‘ä»¬æ‰¾åˆ°opencvåº“æ–‡ä»¶å¤¹é‡Œé¢çš„pkgconfigæ–‡ä»¶å¤¹ï¼Œæ‰“å¼€ä½ çš„shellçš„é…ç½®æ–‡ä»¶ï¼Œæˆ‘ä½¿ç”¨çš„æ˜¯<code>zsh</code>æ‰€ä»¥æ‰“å¼€<code>.zshrc</code>åŠ å…¥ä»¥ä¸‹çš„ä¸¤å¥è¯å¥è¯ï¼š</p><div class="hljs"><pre><code class="hljs crystal">PKG_CONFIG_PATH=<span class="hljs-regexp">/home/gukki</span><span class="hljs-regexp">/OpenCv/</span>_Install/<span class="hljs-class"><span class="hljs-keyword">lib</span>/<span class="hljs-title">pkgconfig</span>/:$<span class="hljs-title">PKG_CONFIG_PATH</span></span>export PKG_CONFIG_PATH</code></pre></div><p>â€‹è‡ªè¡Œæ›¿æ¢ä½ çš„pkgconfigæ–‡ä»¶å¤¹ä½ç½®ã€‚</p><p>â€‹ä½¿ç”¨<code>source</code>å‘½ä»¤è®©æ›´æ”¹ç”Ÿæ•ˆï¼Œè¾“å…¥<code>pkg-config --cflags --libs opencv</code>ï¼Œåº”è¯¥ä¼šå‡ºç°ä¸€å¤§å¨ä¸œè¥¿ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="/../img/image-20200220212101215.png" srcset="/img/loading.gif" alt="image-20200220212101215" /></p><h5 id="6-æµ‹è¯•ä¸ç®€åŒ–"><a class="markdownIt-Anchor" href="#6-æµ‹è¯•ä¸ç®€åŒ–"></a> 6. æµ‹è¯•ä¸ç®€åŒ–</h5><p>â€‹å†™ä¸€ä¸ªéå¸¸ç®€å•çš„ç¨‹åºï¼Œæ¥æµ‹è¯•ä¸‹å§ï¼š</p><div class="hljs"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;opencv2/opencv.hpp&gt;</span></span><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> cv;<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span><span class="hljs-function"></span>&#123;  Mat m;  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;&#125;</code></pre></div><p>â€‹ä¿å­˜ä¸º<code>T.cpp</code>ï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è¿›è¡Œç¼–è¯‘ï¼š</p><div class="hljs"><pre><code class="hljs shell">arm-none-linux-gnueabi-g++ `pkg-config --cflags --libs opencv` T.cpp -lpthread -lrt -ldl</code></pre></div><p>â€‹åº”è¯¥åªæœ‰ä¸€ä¸ªè­¦å‘Šï¼Œä¸éœ€è¦ç†ä¼šã€‚</p><p>â€‹ç”Ÿæˆçš„<code>a.out</code>æ–‡ä»¶æ‹·è´åˆ°å¼€å‘æ¿ï¼Œç»™äºˆæƒé™ã€‚è¿è¡Œä¹‹ååº”è¯¥ä»€ä¹ˆæ•ˆæœéƒ½æ²¡æœ‰ï¼Œä¹Ÿæ²¡æœ‰ä»»ä½•æŠ¥é”™ã€‚é‚£å°±æ˜¯è¡Œäº†ã€‚ä½ å¯ä»¥è¯•è¯•æ›´åŠ å¤æ‚çš„ç¨‹åºäº†ã€‚ä½†æ˜¯ä¸èƒ½æœ‰ä»»ä½•è·Ÿç•Œé¢æœ‰å…³çš„å‡½æ•°å‡ºç°æ¯”å¦‚<code>imshow</code>ï¼Œ<code>waitkey</code>ç­‰ç­‰ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚ï¼ˆå› ä¸ºæˆ‘è£å‰ªæ‰äº†ï¼‰ä½ ä¹Ÿå¯ä»¥è‡ªè¡Œå°è¯•å¦‚ä½•è®©ä»–ä»¬ä½¿ç”¨ï¼Œæœ‰æ›´å¥½çš„æƒ³æ³•å¯ä»¥å‘Šè¯‰æˆ‘ï¼</p><p>â€‹æ¯æ¬¡ç¼–è¯‘éƒ½è¦æ‰“é‚£ä¹ˆé•¿çš„ä»£ç ï¼Œæœ‰æ²¡æœ‰æ–¹æ³•å¯ä»¥ç®€åŒ–ï¼Ÿ</p><p>â€‹å¯ä»¥ä½¿ç”¨<code>alias</code>å‘½ä»¤æ¥è¿›è¡Œç®€åŒ–ï¼Œæˆ‘çš„å°±æ˜¯ï¼š</p><div class="hljs"><pre><code class="hljs shell">alias armcv="arm-none-linux-gnueabi-g++ `pkg-config --cflags --libs opencv` -lpthread -ldl -lrt"</code></pre></div><p>â€‹åŒæ ·çš„ï¼Œå†™åˆ°ä½ è‡ªå·±çš„shellçš„é…ç½®æ–‡ä»¶é‡Œé¢ã€‚</p><p>â€‹å®Œ-</p><p>â€‹</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å’Œç¼ºå°‘èµ„æ–™çš„å¼€å‘æ¿æ–—æ™ºæ–—å‹‡çš„è¿‡ç¨‹ä¹‹å…¶ä¸€&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="åµŒå…¥å¼" scheme="http://yoursite.com/tags/%E5%B5%8C%E5%85%A5%E5%BC%8F/"/>
    
      <category term="è½¯ä»¶ç§»æ¤" scheme="http://yoursite.com/tags/%E8%BD%AF%E4%BB%B6%E7%A7%BB%E6%A4%8D/"/>
    
  </entry>
  
  <entry>
    <title>4412çš„wifié©±åŠ¨ä»¥åŠç®¡ç†è½¯ä»¶çš„ç§»æ¤</title>
    <link href="http://yoursite.com/p/15bec6d.html"/>
    <id>http://yoursite.com/p/15bec6d.html</id>
    <published>2020-02-20T02:16:30.000Z</published>
    <updated>2020-07-09T18:47:59.392Z</updated>
    
    <content type="html"><![CDATA[<p>å’Œèµ„æ–™é”™è¯¯çš„å¼€å‘æ¿æ–—æ™ºæ–—å‹‡çš„è¿‡ç¨‹ä¹‹å…¶äºŒ</p><a id="more"></a><h4 id="å¹³å°"><a class="markdownIt-Anchor" href="#å¹³å°"></a> å¹³å°</h4><ol><li>UP-Tech 4412</li><li>Kubuntu 64ä½</li></ol><h4 id="é—®é¢˜"><a class="markdownIt-Anchor" href="#é—®é¢˜"></a> é—®é¢˜</h4><ol><li><p>ç»™çš„pdfä¸Šé¢çš„wifiæ¨¡å—çš„å‹å·ä¸å¯¹</p><blockquote><p>å®ƒç»™æˆ‘çš„æ˜¯<strong>rt8723bu</strong>è¿™ä¸ªå‹å·çš„é©±åŠ¨ï¼Œå®é™…ä¸Šå¼€å‘æ¿ä¸Šæ­è½½çš„æ˜¯<img src="/../img/image-20200219235946818.png" srcset="/img/loading.gif" alt="image-20200219235946818" /></p><p>è¿™ä¸ªå‹å·çš„é©±åŠ¨</p></blockquote></li><li><p>ç”±äºç¼ºå°‘<code>wpa_supplicant</code>è¿™ä¸ªç®¡ç†è½¯ä»¶ï¼Œwifiæ— æ³•è¿æ¥åˆ°åŠ å¯†çš„ç½‘ç»œ</p></li></ol><h4 id="è§£å†³è¿‡ç¨‹"><a class="markdownIt-Anchor" href="#è§£å†³è¿‡ç¨‹"></a> è§£å†³è¿‡ç¨‹</h4><p>â€‹æˆ‘ä»”ç»†åœ°æŸ¥çœ‹å¼€å‘æ¿ï¼Œå‘ç°å¼€å‘æ¿æ­è½½çš„æ˜¯<code>rtl8188eus</code>è¿™ä¸ªå‹å·çš„æ— çº¿æ¨¡å—ã€‚çŸ¥é“æ˜¯ä»€ä¹ˆå‹å·çš„å°±å¥½åŠäº†ï¼Œç›´æ¥å¼€å§‹ç§»æ¤å§ã€‚</p><p>â€‹æˆ‘å…ˆä»googleä¸Šæ‰¾åˆ°äº†é©±åŠ¨æºä»£ç çš„<a href="https://github.com/quickreflex/rtl8188eus" target="_blank" rel="noopener">github</a>ï¼Œcloneä¸‹è½½ä¹‹åï¼Œå…ˆå¯¹<code>Makefile</code>è¿›è¡Œä¿®æ”¹ï¼Œç”±äºå®ƒé»˜è®¤æ˜¯i386å¹³å°ï¼Œæˆ‘ä»¬éœ€è¦å…ˆå¯¹å®ƒè¿›è¡Œå±è”½ï¼Œå¹¶åŠ å…¥æˆ‘ä»¬çš„è®¾å¤‡ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="/../img/image-20200220001655792.png" srcset="/img/loading.gif" alt="image-20200220001655792" /></p><p><img src="/../img/image-20200220001636696.png" srcset="/img/loading.gif" alt="image-20200220001636696" /></p><p>å…¶ä¸­<code>CONFIG_PLATFORM_ARM_Exynos4412=y</code>æ˜¯æˆ‘ä»¬æ–°æ·»åŠ çš„è®¾å¤‡ã€‚</p><p>â€‹åœ¨1690è¡Œé™„è¿‘åŠ å…¥ä¸€æ®µåˆ¤æ–­è¯­å¥ï¼š</p><div class="hljs"><pre><code class="hljs shell">ifeq ($(CONFIG_PLATFORM_ARM_Exynos4412), y)                                   EXTRA_CFLAGS += -DCONFIG_LITTLE_ENDIAN                                   ARCH := arm                                                 CROSS_COMPILE := arm-none-linux-gnueabi-                                  KVER:=3.5.0                                                 KSRC :=/home/gukki/HostFiles/A9/SRC/kernel/linux-3.5.0-rc6/                         MODULE_NAME :=wlan                                             endif</code></pre></div><p>â€‹æ³¨æ„<code>KVER</code>æ˜¯ä½ çš„å†…æ ¸ç‰ˆæœ¬å·ï¼Œ<code>KSRC</code>æ˜¯ä½ çš„äº¤å‰ç¼–è¯‘å¥½çš„å†…æ ¸ç›®å½•ã€‚</p><p>â€‹ä¿å­˜é€€å‡ºä¹‹åï¼Œç›´æ¥<code>make</code>å³å¯ã€‚ç”Ÿæˆçš„<code>wlan.ko</code>å¯é€šè¿‡minicomè¿›è¡Œä¼ è¾“åˆ°å¼€å‘æ¿ä¸Šï¼Œå¼€å‘æ¿ä¸Šä½¿ç”¨<code>insmod wlan.ko</code>æ¥å®‰è£…é©±åŠ¨ã€‚</p><p>â€‹é©±åŠ¨å®‰è£…å®Œæˆä¹‹åä½¿ç”¨<code>ifconfig -a</code>æ¥è¿›è¡ŒæŸ¥çœ‹è‡ªå·±çš„æ— çº¿ç½‘å¡çš„åå­—ï¼Œå¹¶ä¸”ä½¿ç”¨<code>ifconfig æ— çº¿ç½‘å¡åå­— up</code>æ¥è¿›è¡Œå¯ç”¨ç½‘å¡ã€‚</p><p>â€‹é©±åŠ¨å®Œæˆå®‰è£…ä¹‹åï¼Œè¿è¡Œ<code>iwconfig</code>åº”è¯¥å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="/../img/image-20200220011149442.png" srcset="/img/loading.gif" alt="image-20200220011149442" /></p><hr /><p>â€‹é©±åŠ¨å®‰è£…å®Œæˆä¹‹åï¼Œæˆ‘å‘ç°è¿™æ¨¡å—åªèƒ½è¿æ¥å¼€æ”¾çš„wifiï¼Œè¿›è¿‡ä¸€ç•ªgoogleä¹‹åå‘ç°ï¼Œæˆ‘è¿˜éœ€è¦ç§»æ¤ä¸€ä¸ªåä¸º<a href="https://w1.fi/releases/wpa_supplicant-0.7.2.tar.gz" target="_blank" rel="noopener"><strong>wpa_supplicant</strong></a>   çš„è½¯ä»¶æ¥è¿›è¡Œç®¡ç†ã€‚è€Œè¿™ä¸ªè½¯ä»¶åˆä¾èµ–äº<a href="https://ftp.openssl.org/source/old/0.9.x/openssl-0.9.8e.tar.gz" target="_blank" rel="noopener"><strong>openssl</strong></a>è¿™ä¸ªåº“ï¼Œç´¢æ€§ä¸€æ¬¡å…¨éƒ¨æå®šå§ã€‚</p><p>â€‹è¿™é‡Œæˆ‘çš„wpaç‰ˆæœ¬æ˜¯0.7.2,sslç‰ˆæœ¬æ˜¯0.9.8.eã€‚å…ˆä»ç½‘ä¸ŠæŠŠä»–ä»¬ä¸‹è½½ä¸‹æ¥ã€‚æˆ‘å°†ä»–ä»¬éƒ½è§£å‹åˆ°ä¸€ä¸ªæ–‡ä»¶å¤¹é‡Œã€‚opensslçš„ç§»æ¤éœ€è¦wpaæä¾›çš„è¡¥ä¸æ–‡ä»¶ã€‚</p><p>â€‹æ‰§è¡Œå‘½ä»¤:</p><p>â€‹<code>cp wpa_supplicant-0.7.2/patches/openssl-0.9.8e-tls-extensions.patch ./openssl-0.9.8e</code></p><p>â€‹<code>cd openssl-0.9.8e</code></p><p>â€‹<code>patch -p1 &lt; openssl-0.9.8e-tls-extensions.patch</code></p><p>â€‹åˆ›å»ºä¸€ä¸ªå¹²å‡€çš„æ–‡ä»¶å¤¹ï¼Œæˆ‘çš„è·¯å¾„æ˜¯<code>/home/gukki/Cross_Code/Cross/openssl/</code>ï¼Œåœ¨openssl-0.9.8ç›®å½•é‡Œé¢è¿è¡Œ<code>Configure</code>è„šæœ¬æ¥è¿›è¡Œé…ç½®<code>Makefile</code>ï¼š</p><div class="hljs"><pre><code class="hljs shell">./Configure linux-elf-arm -DL_EDNIAN linux:'arm-none-linux-gnueabi-gcc' shared --prefix=/home/gukki/Cross_Code/Cross/openssl/ -lcrypto</code></pre></div><p>â€‹é…ç½®å®Œæˆä¹‹åå°±å¯ä»¥<code>make &amp;&amp; make install</code>äº†ã€‚ç”Ÿæˆçš„åŠ¨æ€åº“æ–‡ä»¶åœ¨openssl/libé‡Œé¢ã€‚</p><p>â€‹æ¥ä¸‹æ¥è¿›è¡Œwpaçš„ç§»æ¤ã€‚</p><p>â€‹è¿›å…¥wpaçš„æºä»£ç ç›®å½•ï¼Œä¿®æ”¹<code>Makefile</code>æ–‡ä»¶ï¼Œæ³¨é‡Šæ‰ç¬¬ä¸€å’Œç¬¬ä¸‰è¡Œï¼Œå¹¶å°†CCæ”¹ä¸ºä½ çš„äº¤å‰ç¼–è¯‘å™¨ï¼Œ</p><p>åœ¨<br /><code>CFLAGS += -I../src</code><br /><code>CFLAGS += -I../src/utils</code><br />ä¸‹æ·»åŠ ï¼š<br /><code>CFLAGS += -I/home/gukki/Cross_Code/Cross/openssl/include/</code></p><p>ä¿®æ”¹<br /><code>LIBS += -lssl</code><br />ä¸º<br /><code>LIBS += -lssl -L/home/gukki/Cross_Code/Cross/openssl/lib/</code></p><p>ä¿®æ”¹<br /><code>LIBS_p += -lcrypto</code><br />ä¸º<br /><code>LIBS_p += -lcrypto -L/home/gukki/Cross_Code/Cross/openssl/lib/</code></p><p>â€‹ä¿å­˜å¹¶é€€å‡ºï¼Œå°†ç›®å½•ä¸‹é¢çš„<code>defconfig</code>å¤åˆ¶ä¸º<code>.config</code>å¹¶æ‰§è¡Œ<code>make</code></p><p>â€‹ç¼–è¯‘å®Œæˆä¹‹åï¼Œå°†ç›®å½•ä¸‹é¢çš„<code>wpa_supplicant</code>å’Œ<code>wpa_cli</code>æ–‡ä»¶æ‹·è´åˆ°å¼€å‘æ¿çš„<code>/bin</code>ç›®å½•ä¸‹é¢ã€‚</p><hr /><p>â€‹ä¸ºäº†è¿æ¥ä¸ŠåŠ å¯†çš„wifiï¼Œè¿˜éœ€è¦åœ¨å¼€å‘æ¿çš„<code>/etc</code>ç›®å½•ä¸‹é¢æ·»åŠ wpa-psk-tkip.confè¿™ä¸€é…ç½®æ–‡ä»¶ã€‚</p><p>æˆ‘çš„é…ç½®æ–‡ä»¶å¦‚ä¸‹æ‰€ç¤ºï¼š</p><div class="hljs"><pre><code class="hljs routeros">WPA-PSK/TKIP       <span class="hljs-attribute">ctrl_interface</span>=/var/run/wpa_supplicant       network=&#123;       <span class="hljs-attribute">ssid</span>=<span class="hljs-string">"****"</span>       <span class="hljs-attribute">key_mgmt</span>=WPA-PSK       <span class="hljs-attribute">proto</span>=WPA RSN       <span class="hljs-attribute">pairwise</span>=CCMP       <span class="hljs-attribute">group</span>=CCMP       <span class="hljs-attribute">psk</span>=<span class="hljs-string">"***"</span>       &#125;</code></pre></div><p>â€‹å…¶ä¸­ssidæ˜¯ä½ çš„wifiåå­—ï¼Œpskæ˜¯ä½ çš„å¯†ç ã€‚</p><p>â€‹åœ¨å¼€å‘æ¿å†…åˆ›å»ºwpaç¨‹åºçš„è¿è¡Œç›®å½•ï¼š<code>mkdir /var/run/wpa_supplicant -p</code></p><p>â€‹å¹³æ—¶ä½¿ç”¨<code>wpa_supplicant -B -i wlan0 -c /etc/wpa-psk-tkip.conf</code>å³å¯è¿æ¥åˆ°wifiã€‚</p><p>â€‹è¿æ¥åˆ°ä¹‹åéœ€è¦è‡ªå·±æ›´æ”¹ipåœ°å€å’Œé»˜è®¤ç½‘å…³ã€‚å…·ä½“æ“ä½œè¯·è‡ªè¡Œæœç´¢ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å’Œèµ„æ–™é”™è¯¯çš„å¼€å‘æ¿æ–—æ™ºæ–—å‹‡çš„è¿‡ç¨‹ä¹‹å…¶äºŒ&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="åµŒå…¥å¼" scheme="http://yoursite.com/tags/%E5%B5%8C%E5%85%A5%E5%BC%8F/"/>
    
      <category term="é©±åŠ¨ç§»æ¤" scheme="http://yoursite.com/tags/%E9%A9%B1%E5%8A%A8%E7%A7%BB%E6%A4%8D/"/>
    
      <category term="è½¯ä»¶ç§»æ¤" scheme="http://yoursite.com/tags/%E8%BD%AF%E4%BB%B6%E7%A7%BB%E6%A4%8D/"/>
    
  </entry>
  
</feed>
