<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="C/C++/C#">
    <meta name="keyword" content>
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        JWT学习 - FouRod
        
    </title>

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/aircloud.css">

    
<link rel="stylesheet" href="/css/gitment.css">

    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_pl6z7sid89qkt9.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
<meta name="generator" content="Hexo 4.2.0"></head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i> doRuoF </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar ">
            <img src="/img/avatar.jpg">
        </div>
        <div class="name">
            <i>AaJal</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li>
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>主页</span>
                </a>
            </li>
            <li>
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>标签</span>
                </a>
            </li>
            <li>
                <a href="/archives">
                    <i class="iconfont icon-guidang2"></i>
                    <span>存档</span>
                </a>
            </li>
            <li>
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>关于</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>搜索</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#JWT-学习"><span class="toc-text">JWT 学习</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1、概念"><span class="toc-text">1、概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2、小试牛刀"><span class="toc-text">2、小试牛刀</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3、使用ajax发送用户信息并进行登录认证的JWT应用"><span class="toc-text">3、使用ajax发送用户信息并进行登录认证的JWT应用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4、-JWT-数据库-授权部分"><span class="toc-text">4、 JWT+数据库 授权部分</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#拦截器类-JWTAuthenticationTokenFilter"><span class="toc-text">拦截器类 JWTAuthenticationTokenFilter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Security配置类-SecurityConfig"><span class="toc-text">Security配置类 SecurityConfig</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#角色实体类-SysRoleEntity"><span class="toc-text">角色实体类 SysRoleEntity</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#自定义认证逻辑处理器-UserAuthenticationProvider"><span class="toc-text">自定义认证逻辑处理器 UserAuthenticationProvider</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查询用户是否存在-SelfUserDetailsService"><span class="toc-text">查询用户是否存在 SelfUserDetailsService</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#符合Security标准的用户类-SelfUserEntity"><span class="toc-text">符合Security标准的用户类 SelfUserEntity</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#登录成功处理类-UserLoginSuccessHandler"><span class="toc-text">登录成功处理类 UserLoginSuccessHandler</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#与JWT有关的工具类-JWTTokenUtil"><span class="toc-text">与JWT有关的工具类 JWTTokenUtil</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5、JWT-数据库-鉴权部分"><span class="toc-text">5、JWT+数据库 鉴权部分</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#hasPermission-鉴权类-UserPermissionEvaluator"><span class="toc-text">hasPermission 鉴权类 UserPermissionEvaluator</span></a></li></ol></li></ol></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input">
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>

        <div class="index-about-mobile">
            <i> doRuoF </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        JWT学习
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2020-06-29 14:39:37</span></span>
        
        <span class="attr">标签：/
        
        <a class="tag" href="/tags/#JavaWeb开发" title="JavaWeb开发">JavaWeb开发</a>
        <span>/</span>
        
        <a class="tag" href="/tags/#SpringSecurity" title="SpringSecurity">SpringSecurity</a>
        <span>/</span>
        
        <a class="tag" href="/tags/#JWT" title="JWT">JWT</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
</span>

    </div>
    <div class="post-content ">
        <h1 id="JWT-学习"><a href="#JWT-学习" class="headerlink" title="JWT 学习"></a>JWT 学习</h1><h2 id="1、概念"><a href="#1、概念" class="headerlink" title="1、概念"></a>1、概念</h2><p>​     JWT(Jason Web Token)按照我个人理解，是一串服务端按照特定的加密算法生成的字符串。</p>
<p>​    在用户登录成功之后，服务器将用户的个人信息加密并签名成一串字符串发送回用户浏览器，在每次访问受权限控制的网页的时候将这串字符串发回给服务器，用于证明“你还是你”。然后服务端可以解密这串字符串，从里面拿到用户的相关信息，并判断用户有无权限访问此页面。</p>
<p>​    绿小萝的开发中，我们采用了传统的session来记录用户信息，这样在本地或者说单机开发是没有什么问题。但是一旦出现前后端分别处于不同的服务器里，产生了跨域的问题，这样的话session就比较难处理了。</p>
<p>​    采用JWT的话，服务器不保存用户的session，只凭JWT里面的信息来鉴别用户，这样的话，跨域就变得很简单了。</p>
<p>​    JWT这个字符串由三个结构组成</p>
<blockquote>
<ul>
<li>头部(Header)</li>
<li>“alg” 加密类型</li>
<li>“typ” 这串token的类型，自然是JWT</li>
<li>载荷(PayLoad)</li>
<li>可自定义，采用键值对的方式</li>
<li>签名</li>
<li>与服务端指定的密匙有关</li>
</ul>
</blockquote>
<p>​    附：我们使用的session认证流程：</p>
<blockquote>
<ol>
<li>用户登录，发送用户名和密码到后台</li>
<li>后台验证通过之后，将从数据库取出来的用户信息保存到session里</li>
<li>后台向用户浏览器返回一个session_id，写入浏览器的cookie里。</li>
<li>之后的每一个请求，都会将cookie里面的session_id发送回后台</li>
<li>后台通过前台传来的session_id，找到保存起来的session，并从里面取得用户信息。</li>
</ol>
</blockquote>
<h2 id="2、小试牛刀"><a href="#2、小试牛刀" class="headerlink" title="2、小试牛刀"></a>2、小试牛刀</h2><p>​    网上找了个教程，讲的很好，我模仿他的例子，加上了自己理解的注释：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">contextLoads</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String s = genToken();</span><br><span class="line">        verifyToken(s);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//生成JWT</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">genToken</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//先生成token，预设好一个Key</span></span><br><span class="line">        String secret = <span class="string">"imkey"</span>;</span><br><span class="line">        <span class="comment">//加密</span></span><br><span class="line">        Algorithm algorithm = Algorithm.HMAC256(secret);</span><br><span class="line">        <span class="comment">//设置头部信息</span></span><br><span class="line">        <span class="comment">//也就是加密算法类型以及token类型</span></span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">"alg"</span>, <span class="string">"HS256"</span>);</span><br><span class="line">        map.put(<span class="string">"typ"</span>, <span class="string">"JWT"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置载荷（payload）</span></span><br><span class="line">        String token = JWT.create()</span><br><span class="line">                <span class="comment">//定义头部</span></span><br><span class="line">                .withHeader(map)</span><br><span class="line">                <span class="comment">//自定义载荷</span></span><br><span class="line">                .withClaim(<span class="string">"name"</span>, <span class="string">"李一"</span>)</span><br><span class="line">                <span class="comment">//定义主题</span></span><br><span class="line">                .withSubject(<span class="string">"一个token"</span>)</span><br><span class="line">                <span class="comment">//签名头部</span></span><br><span class="line">                .sign(algorithm);</span><br><span class="line">        <span class="keyword">return</span> token;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//校验JWT</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">verifyToken</span><span class="params">(String token)</span></span>&#123;</span><br><span class="line">        <span class="comment">//定义加密类型</span></span><br><span class="line">        Algorithm algorithm = Algorithm.HMAC256(<span class="string">"imkey"</span>);</span><br><span class="line">        <span class="comment">//获取这种算法的对应的解密（校验）对象</span></span><br><span class="line">        JWTVerifier require = JWT.require(algorithm)</span><br><span class="line">                .build();</span><br><span class="line">        System.out.println(require);</span><br><span class="line">        <span class="comment">//解密</span></span><br><span class="line">        DecodedJWT decodedJWT = require.verify(token);</span><br><span class="line">        <span class="comment">//获取载荷里面的值</span></span><br><span class="line">        Claim claim = decodedJWT.getClaim(<span class="string">"name"</span>);</span><br><span class="line">        System.out.println(claim);</span><br><span class="line">        <span class="comment">//输出载荷的值</span></span><br><span class="line">        System.out.println(claim.asString());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>运行结果如下：</p>
<p><img src="/img/image-20200626083111707-1593413542002.png" alt="image-20200626083111707"></p>
<p>是没有问题的。</p>
<h2 id="3、使用ajax发送用户信息并进行登录认证的JWT应用"><a href="#3、使用ajax发送用户信息并进行登录认证的JWT应用" class="headerlink" title="3、使用ajax发送用户信息并进行登录认证的JWT应用"></a>3、使用ajax发送用户信息并进行登录认证的JWT应用</h2><p>​        项目结构如下所示</p>
<p><img src="/img/image-20200626122914327.png" alt="image-20200626122914327"></p>
<p>流程图（<a href="https://www.cnblogs.com/fishpro/p/spring-boot-study-securing-jwt.html" target="_blank" rel="external nofollow noopener noreferrer">引用了一个大佬的图</a>，详情请见本章末尾）</p>
<p><img src="/img/o_jwt2.jpg" alt="o_jwt2"></p>
<p><img src="/img/o_jwt3.jpg" alt="o_jwt3"></p>
<p><img src="/img/o_jwt4.jpg" alt="o_jwt4"></p>
<p><strong>JwtAuthenticationController</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用于验证 jwt 返回客户端 jwt（json web token）</span></span><br><span class="line"><span class="comment"> * */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@CrossOrigin</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtAuthenticationController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AuthenticationManager authenticationManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtTokenUtil jwtTokenUtil;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtUserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取 客户端来的 username password 使用秘钥加密成 json web token</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/authenticate"</span>, method = RequestMethod.POST)</span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;?&gt; createAuthenticationToken(<span class="meta">@RequestBody</span> JwtRequest authenticationRequest) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//获取前台传来的明文账号密码并进行认证</span></span><br><span class="line">        authenticate(authenticationRequest.getUsername(), authenticationRequest.getPassword());</span><br><span class="line">        <span class="comment">//认证操作成功后，以下的语句才会执行</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取用户信息</span></span><br><span class="line">        <span class="keyword">final</span> UserDetails userDetails = userDetailsService</span><br><span class="line">                .loadUserByUsername(authenticationRequest.getUsername());</span><br><span class="line">        <span class="comment">//生成token</span></span><br><span class="line">        <span class="keyword">final</span> String token = jwtTokenUtil.generateToken(userDetails);</span><br><span class="line">        <span class="comment">//向前台返回序列化后的token</span></span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(<span class="keyword">new</span> JwtResponse(token));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  获取 客户端来的 username password 使用秘钥加密成 json web token</span></span><br><span class="line"><span class="comment">     * */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">authenticate</span><span class="params">(String username, String password)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//创建一个没有认证的token实例，此时“是否身份认证过”属性为false</span></span><br><span class="line">            <span class="comment">//由于此时未进行身份认证，所以他的权限未知</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//认证信息管理（authenticationManager），从指定的用户数据源加载用户信息</span></span><br><span class="line">            <span class="comment">//然后使用约定好的加密方式，进行认证。</span></span><br><span class="line">            <span class="comment">//认证失败之后，直接返回给前台401</span></span><br><span class="line">            authenticationManager.authenticate(<span class="keyword">new</span> UsernamePasswordAuthenticationToken(username, password));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (DisabledException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"USER_DISABLED"</span>, e);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (BadCredentialsException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"INVALID_CREDENTIALS"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>JwtAuthenticationEntryPoint</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * AuthenticationEntryPoint 用来解决匿名用户访问无权限资源时的异常</span></span><br><span class="line"><span class="comment"> * AccessDeineHandler 用来解决认证过的用户访问无权限资源时的异常</span></span><br><span class="line"><span class="comment"> * */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtAuthenticationEntryPoint</span> <span class="keyword">implements</span> <span class="title">AuthenticationEntryPoint</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">7858869558953243875L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//当出错的时候 发送 Unauthorized</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commence</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span></span><br><span class="line"><span class="function"><span class="params">                         AuthenticationException authException)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">        response.sendError(HttpServletResponse.SC_UNAUTHORIZED, <span class="string">"Unauthorized"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>JwtRequestFilter</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 过滤器 用于 Spring Boot Security</span></span><br><span class="line"><span class="comment"> * OncePerRequestFilter 一次请求只通过一次filter，而不需要重复执行</span></span><br><span class="line"><span class="comment"> * */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtRequestFilter</span> <span class="keyword">extends</span> <span class="title">OncePerRequestFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtUserDetailsService jwtUserDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtTokenUtil jwtTokenUtil;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doFilterInternal</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        <span class="comment">//获得请求头</span></span><br><span class="line">        <span class="keyword">final</span> String requestTokenHeader = request.getHeader(<span class="string">"Authorization"</span>);</span><br><span class="line"></span><br><span class="line">        String username = <span class="keyword">null</span>;</span><br><span class="line">        String jwtToken = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// JWT Token 获取请求头部的 Bearer</span></span><br><span class="line">        <span class="comment">// only the Token</span></span><br><span class="line">        <span class="keyword">if</span> (requestTokenHeader != <span class="keyword">null</span> &amp;&amp; requestTokenHeader.startsWith(<span class="string">"Bearer "</span>)) &#123;</span><br><span class="line">            jwtToken = requestTokenHeader.substring(<span class="number">7</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//从token里获取用户名</span></span><br><span class="line">                username = jwtTokenUtil.getUsernameFromToken(jwtToken);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">                System.out.println(<span class="string">"Unable to get JWT Token"</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ExpiredJwtException e) &#123;</span><br><span class="line">                System.out.println(<span class="string">"JWT Token has expired"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            logger.warn(<span class="string">"JWT Token does not begin with Bearer String"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 验证</span></span><br><span class="line">        <span class="keyword">if</span> (username != <span class="keyword">null</span> &amp;&amp; SecurityContextHolder.getContext().getAuthentication() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//我猜，之所以要在这里再校验一次用户名，是防止上面的异常抛出的后，username为空的情况。</span></span><br><span class="line">            <span class="comment">//获取用户的在后台保存的账号密码，封装成一个对象，通过查询用户名的方式</span></span><br><span class="line">            UserDetails userDetails = <span class="keyword">this</span>.jwtUserDetailsService.loadUserByUsername(username);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// JWT 验证通过 使用Spring Security 管理</span></span><br><span class="line">            <span class="comment">//将token里面的用户名和保存的对象进行校验</span></span><br><span class="line">            <span class="keyword">if</span> (jwtTokenUtil.validateToken(jwtToken, userDetails)) &#123;</span><br><span class="line">                <span class="comment">//传入用户信息，</span></span><br><span class="line">                UsernamePasswordAuthenticationToken usernamePasswordAuthenticationToken = <span class="keyword">new</span> UsernamePasswordAuthenticationToken(</span><br><span class="line">                        userDetails, <span class="keyword">null</span>, userDetails.getAuthorities());</span><br><span class="line">                usernamePasswordAuthenticationToken</span><br><span class="line">                        .setDetails(<span class="keyword">new</span> WebAuthenticationDetailsSource().buildDetails(request));</span><br><span class="line">                <span class="comment">// After setting the Authentication in the context, we specify</span></span><br><span class="line">                <span class="comment">// that the current user is authenticated. So it passes the</span></span><br><span class="line">                <span class="comment">// Spring Security Configurations successfully.</span></span><br><span class="line">                SecurityContextHolder.getContext().setAuthentication(usernamePasswordAuthenticationToken);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//没有token，则跑去jwtcontroller</span></span><br><span class="line">        chain.doFilter(request, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>JwtUserDetailsService</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//用户信息来源</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtUserDetailsService</span> <span class="keyword">implements</span> <span class="title">UserDetailsService</span> </span>&#123;</span><br><span class="line"><span class="comment">//通过用户名加载</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDetails <span class="title">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"javainuse"</span>.equals(username)) &#123;</span><br><span class="line">            <span class="comment">//新建一个用户名为：javainuse的用户，密码为用BC加密的password,后面的数组是这个用户的权限列表，目前为空。</span></span><br><span class="line">            <span class="comment">//BC加密后的字符串有着它特殊的意思，前面的2a表示使用了bc加密，后面的10表示它hash了10次</span></span><br><span class="line">            <span class="comment">//然后从第三个$开始算起的21个字符都是它的salt，用于混淆用的</span></span><br><span class="line">            <span class="comment">//后面的全都是密文密码和slat hash10次之后的密文</span></span><br><span class="line">            <span class="comment">//如何校验？</span></span><br><span class="line">            <span class="comment">//获得前台传来的明文密码，取储存好的BC加密后的字符串，取其中的盐，hash10次之后，和密文进行匹配。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">//返回用户的用户名、BC加密后的密码、以及权限列表。</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> User(<span class="string">"javainuse"</span>, <span class="string">"$2a$10$slYQmyNdGzTn7ZLBXBChFOC9f6kFjAqPhccnP6DxlWXx2lPk1C3G6"</span>,</span><br><span class="line">                    <span class="keyword">new</span> ArrayList&lt;&gt;());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UsernameNotFoundException(<span class="string">"User not found with username: "</span> + username);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>WebSecurityConfig</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="meta">@EnableGlobalMethodSecurity</span>(prePostEnabled = <span class="keyword">true</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtAuthenticationEntryPoint jwtAuthenticationEntryPoint;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDetailsService jwtUserDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtRequestFilter jwtRequestFilter;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configureGlobal</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// configure AuthenticationManager so that it knows from where to load</span></span><br><span class="line">        <span class="comment">// user for matching credentials</span></span><br><span class="line">        <span class="comment">// Use BCryptPasswordEncoder</span></span><br><span class="line">        <span class="comment">//配置用于用户信息来源，并设置好加密方式</span></span><br><span class="line">        auth.userDetailsService(jwtUserDetailsService).passwordEncoder(passwordEncoder());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PasswordEncoder <span class="title">passwordEncoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BCryptPasswordEncoder();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthenticationManager <span class="title">authenticationManagerBean</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.authenticationManagerBean();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity httpSecurity)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 本示例不需要使用CSRF</span></span><br><span class="line">        httpSecurity.csrf().disable()</span><br><span class="line">                <span class="comment">// 认证页面不需要权限</span></span><br><span class="line">                .authorizeRequests().antMatchers(<span class="string">"/authenticate"</span>).permitAll().</span><br><span class="line">                <span class="comment">//其他页面</span></span><br><span class="line">                        anyRequest().authenticated().and().</span><br><span class="line">                <span class="comment">//登录页面 模拟客户端</span></span><br><span class="line">                formLogin().loginPage(<span class="string">"/login.html"</span>).permitAll().and().</span><br><span class="line">                <span class="comment">// store user's state.</span></span><br><span class="line">                 exceptionHandling().authenticationEntryPoint(jwtAuthenticationEntryPoint).and().sessionManagement()</span><br><span class="line">                <span class="comment">//不使用session</span></span><br><span class="line">                .sessionCreationPolicy(SessionCreationPolicy.STATELESS);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//验证请求是否正确</span></span><br><span class="line">        httpSecurity.addFilterBefore(jwtRequestFilter, UsernamePasswordAuthenticationFilter<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>HelloWorldController</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorldController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(&#123; <span class="string">"/hello"</span> &#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">firstPage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Hello World"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>JwtRequest</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtRequest</span></span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// private static final long serialVersionUID = 5926468583005150707L;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//need default constructor for JSON Parsing</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JwtRequest</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JwtRequest</span><span class="params">(String username, String password)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.setUsername(username);</span><br><span class="line">        <span class="keyword">this</span>.setPassword(password);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUsername</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.username = username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPassword</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPassword</span><span class="params">(String password)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.password = password;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>JwtResponse</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtResponse</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">8091879091924046844L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String jwttoken;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JwtResponse</span><span class="params">(String jwttoken)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.jwttoken = jwttoken;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getToken</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.jwttoken;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>JwtTokenUtil</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtTokenUtil</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">2550185165626007488L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> JWT_TOKEN_VALIDITY = <span class="number">5</span> * <span class="number">60</span> * <span class="number">60</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;jwt.secret&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String secret;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//retrieve username from jwt token</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUsernameFromToken</span><span class="params">(String token)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getClaimFromToken(token, Claims::getSubject);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//retrieve expiration date from jwt token</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Date <span class="title">getExpirationDateFromToken</span><span class="params">(String token)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getClaimFromToken(token, Claims::getExpiration);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getClaimFromToken</span><span class="params">(String token, Function&lt;Claims, T&gt; claimsResolver)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Claims claims = getAllClaimsFromToken(token);</span><br><span class="line">        <span class="keyword">return</span> claimsResolver.apply(claims);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//for retrieveing any information from token we will need the secret key</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Claims <span class="title">getAllClaimsFromToken</span><span class="params">(String token)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Jwts.parser().setSigningKey(secret).parseClaimsJws(token).getBody();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//check if the token has expired</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Boolean <span class="title">isTokenExpired</span><span class="params">(String token)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Date expiration = getExpirationDateFromToken(token);</span><br><span class="line">        <span class="keyword">return</span> expiration.before(<span class="keyword">new</span> Date());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//generate token for user</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">generateToken</span><span class="params">(UserDetails userDetails)</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; claims = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">return</span> doGenerateToken(claims, userDetails.getUsername());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//while creating the token -</span></span><br><span class="line">    <span class="comment">//1. Define  claims of the token, like Issuer, Expiration, Subject, and the ID</span></span><br><span class="line">    <span class="comment">//2. Sign the JWT using the HS512 algorithm and secret key.</span></span><br><span class="line">    <span class="comment">//3. According to JWS Compact Serialization(https://tools.ietf.org/html/draft-ietf-jose-json-web-signature-41#section-3.1)</span></span><br><span class="line">    <span class="comment">//   compaction of the JWT to a URL-safe string</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">doGenerateToken</span><span class="params">(Map&lt;String, Object&gt; claims, String subject)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Jwts.builder().setClaims(claims).setSubject(subject).setIssuedAt(<span class="keyword">new</span> Date(System.currentTimeMillis()))</span><br><span class="line">                .setExpiration(<span class="keyword">new</span> Date(System.currentTimeMillis() + JWT_TOKEN_VALIDITY * <span class="number">1000</span>))</span><br><span class="line">                .signWith(SignatureAlgorithm.HS512, secret).compact();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//校验 token</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Boolean <span class="title">validateToken</span><span class="params">(String token, UserDetails userDetails)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//获取token的用户名，并进行匹配</span></span><br><span class="line">        <span class="keyword">final</span> String username = getUsernameFromToken(token);</span><br><span class="line">        <span class="keyword">return</span> (username.equals(userDetails.getUsername()) &amp;&amp; !isTokenExpired(token));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>登录用的ajax：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        $(<span class="string">"#btnSave"</span>).click(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> username=$(<span class="string">"#userName"</span>).val();</span><br><span class="line">            <span class="keyword">var</span> password=$(<span class="string">"#password"</span>).val();</span><br><span class="line">            $.ajax(&#123;</span><br><span class="line">                cache: <span class="literal">true</span>,</span><br><span class="line">                type: <span class="string">"POST"</span>,</span><br><span class="line">                url: <span class="string">"/authenticate"</span>,</span><br><span class="line">                contentType: <span class="string">"application/json;charset=UTF-8"</span>,</span><br><span class="line">                data:<span class="built_in">JSON</span>.stringify(&#123;<span class="string">"username"</span>:username ,<span class="string">"password"</span> : password&#125;),</span><br><span class="line">                dataType: <span class="string">"json"</span>,</span><br><span class="line">                <span class="keyword">async</span>: <span class="literal">false</span>,</span><br><span class="line">                error: <span class="function"><span class="keyword">function</span> (<span class="params">request</span>) </span>&#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">"Connection error"</span>);</span><br><span class="line">                &#125;,</span><br><span class="line">                success: <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">                    <span class="comment">//save token</span></span><br><span class="line">                    localStorage.setItem(<span class="string">"token"</span>,data.token);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<p>注意，这个项目的java版本要求是java8，如果你是和我一样使用java11或更高的版本的话，可以使用我的pom.xml里面的配置。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.xml.bind<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jaxb-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.sun.xml.bind<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jaxb-impl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.sun.xml.bind<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jaxb-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.activation<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>activation<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.jsonwebtoken<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jjwt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.9.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.security<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-security-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>参考来源：</p>
<p><a href="https://www.cnblogs.com/fishpro/p/spring-boot-study-securing-jwt.html" target="_blank" rel="external nofollow noopener noreferrer">Spring Boot Security JWT 整合实现前后端分离认证示例</a></p>
<p><a href="https://www.javainuse.com/spring/boot-jwt" target="_blank" rel="external nofollow noopener noreferrer">Spring Boot Security + JWT Hello World Example</a></p>
<h2 id="4、-JWT-数据库-授权部分"><a href="#4、-JWT-数据库-授权部分" class="headerlink" title="4、 JWT+数据库 授权部分"></a>4、 JWT+数据库 授权部分</h2><p>​    我觉得这玩意可难了，学了个两天才勉勉强强搞明白个一小半。唉，吃了英语不好的亏。</p>
<p>​    以下是大概的流程：</p>
<img src="/img/image-20200628170759526.png" alt="A" style="zoom: 100%;">

<p>所用到的类：</p>
<h3 id="拦截器类-JWTAuthenticationTokenFilter"><a href="#拦截器类-JWTAuthenticationTokenFilter" class="headerlink" title="拦截器类 JWTAuthenticationTokenFilter"></a>拦截器类 JWTAuthenticationTokenFilter</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JWTAuthenticationTokenFilter</span> <span class="keyword">extends</span> <span class="title">BasicAuthenticationFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JWTAuthenticationTokenFilter</span><span class="params">(AuthenticationManager authenticationManager)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(authenticationManager);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doFilterInternal</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        <span class="comment">// 获取请求头中JWT的Token</span></span><br><span class="line">        String tokenHeader = request.getHeader(JWTConfig.tokenHeader);</span><br><span class="line">        <span class="comment">// &amp;&amp; tokenHeader.startsWith(JWTConfig.tokenPrefix)</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span>!=tokenHeader) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 截取JWT前缀</span></span><br><span class="line">                String token = tokenHeader.replace(<span class="string">"Bearer Sans-"</span>, <span class="string">""</span>);</span><br><span class="line">                <span class="comment">// 解析JWT</span></span><br><span class="line">                Claims claims = Jwts.parser()</span><br><span class="line">                        .setSigningKey(JWTConfig.secret)</span><br><span class="line">                        .parseClaimsJws(token)</span><br><span class="line">                        .getBody();</span><br><span class="line">                log.info(claims.toString());</span><br><span class="line">                <span class="comment">// 获取用户名</span></span><br><span class="line">                String username = claims.getSubject();</span><br><span class="line">                String userId=claims.getId();</span><br><span class="line">                <span class="keyword">if</span>(!StringUtils.isEmpty(username)&amp;&amp;!StringUtils.isEmpty(userId)) &#123;</span><br><span class="line">                    <span class="comment">// 获取角色</span></span><br><span class="line">                    List&lt;GrantedAuthority&gt; authorities = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">                    String authority = claims.get(<span class="string">"authorities"</span>).toString();</span><br><span class="line">                    log.info(authority);</span><br><span class="line">                    <span class="keyword">if</span>(!StringUtils.isEmpty(authority))&#123;</span><br><span class="line">                        List&lt;Map&lt;String,String&gt;&gt; authorityMap = JSONObject.parseObject(authority, List<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">                        <span class="keyword">for</span> (Map&lt;String, String&gt; stringStringMap : authorityMap) &#123;</span><br><span class="line">                            <span class="keyword">for</span> (String s : stringStringMap.keySet()) &#123;</span><br><span class="line">                                log.info(s);</span><br><span class="line">                                log.info(stringStringMap.get(s));</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">for</span>(Map&lt;String,String&gt; role : authorityMap)&#123;</span><br><span class="line">                            <span class="keyword">if</span>(!StringUtils.isEmpty(role)) &#123;</span><br><span class="line">                                authorities.add(<span class="keyword">new</span> SimpleGrantedAuthority(role.get(<span class="string">"authority"</span>)));</span><br><span class="line">                                <span class="comment">//log.info(role.get("authority"));</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//组装参数</span></span><br><span class="line">                    SelfUserEntity selfUserEntity = <span class="keyword">new</span> SelfUserEntity();</span><br><span class="line">                    selfUserEntity.setUsername(claims.getSubject());</span><br><span class="line">                    selfUserEntity.setUserId(Long.parseLong(claims.getId()));</span><br><span class="line">                    selfUserEntity.setAuthorities(authorities);</span><br><span class="line">                    UsernamePasswordAuthenticationToken authentication = <span class="keyword">new</span> UsernamePasswordAuthenticationToken(selfUserEntity, userId, authorities);</span><br><span class="line">                    SecurityContextHolder.getContext().setAuthentication(authentication);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ExpiredJwtException e)&#123;</span><br><span class="line">                log.info(<span class="string">"Token过期"</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(e.getMessage());</span><br><span class="line">                log.info(<span class="string">"Token无效"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        filterChain.doFilter(request, response);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Security配置类-SecurityConfig"><a href="#Security配置类-SecurityConfig" class="headerlink" title="Security配置类 SecurityConfig"></a>Security配置类 SecurityConfig</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="meta">@EnableGlobalMethodSecurity</span>(prePostEnabled = <span class="keyword">true</span>) <span class="comment">//开启权限注解,默认是关闭的</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义登录成功处理器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserLoginSuccessHandler userLoginSuccessHandler;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义登录失败处理器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserLoginFailureHandler userLoginFailureHandler;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义注销成功处理器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserLogoutSuccessHandler userLogoutSuccessHandler;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义暂无权限处理器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserAuthAccessDeniedHandler userAuthAccessDeniedHandler;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义未登录的处理器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserAuthenticationEntryPointHandler userAuthenticationEntryPointHandler;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义登录逻辑验证器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserAuthenticationProvider userAuthenticationProvider;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加密方式</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span> Sans</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@CreateTime</span> 2019/10/1 14:00</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BCryptPasswordEncoder <span class="title">bCryptPasswordEncoder</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BCryptPasswordEncoder();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注入自定义PermissionEvaluator</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DefaultWebSecurityExpressionHandler <span class="title">userSecurityExpressionHandler</span><span class="params">()</span></span>&#123;</span><br><span class="line">        DefaultWebSecurityExpressionHandler handler = <span class="keyword">new</span> DefaultWebSecurityExpressionHandler();</span><br><span class="line">        handler.setPermissionEvaluator(<span class="keyword">new</span> UserPermissionEvaluator());</span><br><span class="line">        <span class="keyword">return</span> handler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 配置登录验证逻辑</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span></span>&#123;</span><br><span class="line">        <span class="comment">//这里可启用我们自己的登陆验证逻辑</span></span><br><span class="line">        auth.authenticationProvider(userAuthenticationProvider);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 配置security的控制逻辑</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span> Sans</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@CreateTime</span> 2019/10/1 16:56</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Param</span>  http 请求</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                <span class="comment">// 不进行权限验证的请求或资源(从配置文件中读取)</span></span><br><span class="line">               .antMatchers(JWTConfig.antMatchers.split(<span class="string">","</span>)).permitAll()</span><br><span class="line">                <span class="comment">// 其他的需要登陆后才能访问</span></span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">                <span class="comment">// 配置未登录自定义处理类</span></span><br><span class="line">                .httpBasic().authenticationEntryPoint(userAuthenticationEntryPointHandler)</span><br><span class="line">                .and()</span><br><span class="line">                <span class="comment">// 配置登录地址</span></span><br><span class="line">                .formLogin()</span><br><span class="line">                .loginProcessingUrl(<span class="string">"/login/userLogin"</span>)</span><br><span class="line">                <span class="comment">// 配置登录成功自定义处理类</span></span><br><span class="line">                .successHandler(userLoginSuccessHandler)</span><br><span class="line">                <span class="comment">// 配置登录失败自定义处理类</span></span><br><span class="line">                .failureHandler(userLoginFailureHandler)</span><br><span class="line">                .and()</span><br><span class="line">                <span class="comment">// 配置登出地址</span></span><br><span class="line">                .logout()</span><br><span class="line">                .logoutUrl(<span class="string">"/login/userLogout"</span>)</span><br><span class="line">                <span class="comment">// 配置用户登出自定义处理类</span></span><br><span class="line">                .logoutSuccessHandler(userLogoutSuccessHandler)</span><br><span class="line">                .and()</span><br><span class="line">                <span class="comment">// 配置没有权限自定义处理类</span></span><br><span class="line">                .exceptionHandling().accessDeniedHandler(userAuthAccessDeniedHandler)</span><br><span class="line">                .and()</span><br><span class="line">                <span class="comment">// 开启跨域</span></span><br><span class="line">                .cors()</span><br><span class="line">                .and()</span><br><span class="line">                <span class="comment">// 取消跨站请求伪造防护</span></span><br><span class="line">                .csrf().disable();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 基于Token不需要session</span></span><br><span class="line">        http.sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS);</span><br><span class="line">        <span class="comment">// 禁用缓存</span></span><br><span class="line">        http.headers().cacheControl();</span><br><span class="line">        <span class="comment">// 添加JWT过滤器</span></span><br><span class="line">        http.addFilter(<span class="keyword">new</span> JWTAuthenticationTokenFilter(authenticationManager()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="角色实体类-SysRoleEntity"><a href="#角色实体类-SysRoleEntity" class="headerlink" title="角色实体类 SysRoleEntity"></a>角色实体类 SysRoleEntity</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@TableName</span>(<span class="string">"sys_role"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SysRoleEntity</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 角色ID</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@TableId</span></span><br><span class="line">	<span class="keyword">private</span> Long roleId;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 角色名称</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String roleName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="自定义认证逻辑处理器-UserAuthenticationProvider"><a href="#自定义认证逻辑处理器-UserAuthenticationProvider" class="headerlink" title="自定义认证逻辑处理器 UserAuthenticationProvider"></a>自定义认证逻辑处理器 UserAuthenticationProvider</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserAuthenticationProvider</span> <span class="keyword">implements</span> <span class="title">AuthenticationProvider</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SelfUserDetailsService selfUserDetailsService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SysUserService sysUserService;</span><br><span class="line">    <span class="comment">//authentication 这个参数是哪里来的呢？</span></span><br><span class="line">    <span class="comment">//我猜测是这样的：UsernamePasswordAuthenticationFilter 处理了从前台传入的账号密码，封装成一个实现了Authentication接口的UsernamePasswordAuthenticationToken类，此时这个账号密码尚未认证，所以没有权限。-&gt;调用ProviderManager类的authenticate方法处理Token-&gt;轮询在security配置里面注册好的登录逻辑处理类，检查是否支持当前token，找到之后进行处理。—&gt;于是，这个token就传进来了。</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Authentication <span class="title">authenticate</span><span class="params">(Authentication authentication)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">        <span class="comment">// 获取表单输入中返回的用户名</span></span><br><span class="line">        String userName = (String) authentication.getPrincipal();</span><br><span class="line">        <span class="comment">// 获取表单中输入的密码</span></span><br><span class="line">        String password = (String) authentication.getCredentials();</span><br><span class="line">        <span class="comment">// 查询用户是否存在</span></span><br><span class="line">        SelfUserEntity userInfo = selfUserDetailsService.loadUserByUsername(userName);</span><br><span class="line">        <span class="keyword">if</span> (userInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UsernameNotFoundException(<span class="string">"用户名不存在"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 我们还要判断密码是否正确，这里我们的密码使用BCryptPasswordEncoder进行加密的</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">new</span> BCryptPasswordEncoder().matches(password, userInfo.getPassword())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BadCredentialsException(<span class="string">"密码不正确"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 还可以加一些其他信息的判断，比如用户账号已停用等判断</span></span><br><span class="line">        <span class="keyword">if</span> (userInfo.getStatus().equals(<span class="string">"PROHIBIT"</span>))&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LockedException(<span class="string">"该用户已被冻结"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 角色集合</span></span><br><span class="line">        Set&lt;GrantedAuthority&gt; authorities = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">        <span class="comment">// 查询用户角色</span></span><br><span class="line">        <span class="comment">//一张表储存了用户id和他的所拥有的权限的id，另一张表储存了对应权限id的权限名。</span></span><br><span class="line">        <span class="comment">//所以查出来是一列权限实体类</span></span><br><span class="line">       </span><br><span class="line">        List&lt;SysRoleEntity&gt; sysRoleEntityList = sysUserService.selectSysRoleByUserId(userInfo.getUserId());</span><br><span class="line">        <span class="keyword">for</span> (SysRoleEntity sysRoleEntity: sysRoleEntityList)&#123;</span><br><span class="line">            authorities.add(<span class="keyword">new</span> SimpleGrantedAuthority(<span class="string">"ROLE_"</span> + sysRoleEntity.getRoleName()));</span><br><span class="line">        &#125;</span><br><span class="line">        userInfo.setAuthorities(authorities);</span><br><span class="line">        <span class="comment">// 进行登录</span></span><br><span class="line">        <span class="comment">//上方所说的轮询并检测是否成功的标志就是看返回的是不是为null,不为null则表明认证成功。</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> UsernamePasswordAuthenticationToken(userInfo, password, authorities);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Class&lt;?&gt; authentication)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="查询用户是否存在-SelfUserDetailsService"><a href="#查询用户是否存在-SelfUserDetailsService" class="headerlink" title="查询用户是否存在 SelfUserDetailsService"></a>查询用户是否存在 SelfUserDetailsService</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SelfUserDetailsService</span> <span class="keyword">implements</span> <span class="title">UserDetailsService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SysUserService sysUserService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询用户信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span> Sans</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@CreateTime</span> 2019/9/13 17:23</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Param</span>  username  用户名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Return</span> UserDetails SpringSecurity用户信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SelfUserEntity <span class="title">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException </span>&#123;</span><br><span class="line">        <span class="comment">// 查询用户信息</span></span><br><span class="line">        SysUserEntity sysUserEntity =sysUserService.selectUserByName(username);</span><br><span class="line">        <span class="keyword">if</span> (sysUserEntity!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="comment">// 组装参数</span></span><br><span class="line">            SelfUserEntity selfUserEntity = <span class="keyword">new</span> SelfUserEntity();</span><br><span class="line">            BeanUtils.copyProperties(sysUserEntity,selfUserEntity);</span><br><span class="line">            <span class="keyword">return</span> selfUserEntity;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="符合Security标准的用户类-SelfUserEntity"><a href="#符合Security标准的用户类-SelfUserEntity" class="headerlink" title="符合Security标准的用户类 SelfUserEntity"></a>符合Security标准的用户类 SelfUserEntity</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SelfUserEntity</span> <span class="keyword">implements</span> <span class="title">Serializable</span>, <span class="title">UserDetails</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 用户ID</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> Long userId;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 用户名</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String username;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 密码</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String password;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 状态:NORMAL正常  PROHIBIT禁用</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> String status;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 用户角色</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> Collection&lt;GrantedAuthority&gt; authorities;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 账户是否过期</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> isAccountNonExpired = <span class="keyword">false</span>;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 账户是否被锁定</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> isAccountNonLocked = <span class="keyword">false</span>;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 证书是否过期</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> isCredentialsNonExpired = <span class="keyword">false</span>;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 账户是否有效</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> isEnabled = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Collection&lt;GrantedAuthority&gt; <span class="title">getAuthorities</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> authorities;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAccountNonExpired</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> isAccountNonExpired;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAccountNonLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> isAccountNonLocked;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isCredentialsNonExpired</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> isCredentialsNonExpired;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isEnabled</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> isEnabled;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="登录成功处理类-UserLoginSuccessHandler"><a href="#登录成功处理类-UserLoginSuccessHandler" class="headerlink" title="登录成功处理类 UserLoginSuccessHandler"></a>登录成功处理类 UserLoginSuccessHandler</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserLoginSuccessHandler</span> <span class="keyword">implements</span> <span class="title">AuthenticationSuccessHandler</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 登录成功返回结果</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span> Sans</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@CreateTime</span> 2019/10/3 9:27</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAuthenticationSuccess</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span></span>&#123;</span><br><span class="line">        <span class="comment">// 组装JWT</span></span><br><span class="line">        <span class="comment">//在认证处理器部分，将userinfo传入给UsernamePasswordAuthenticationToken作为principal</span></span><br><span class="line">        SelfUserEntity selfUserEntity =  (SelfUserEntity) authentication.getPrincipal();</span><br><span class="line">        String token = JWTTokenUtil.createAccessToken(selfUserEntity);</span><br><span class="line">        log.info(selfUserEntity.toString());</span><br><span class="line">        token = JWTConfig.tokenPrefix + token;</span><br><span class="line">        <span class="comment">// 封装返回参数</span></span><br><span class="line">        Map&lt;String,Object&gt; resultData = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        resultData.put(<span class="string">"code"</span>,<span class="string">"200"</span>);</span><br><span class="line">        resultData.put(<span class="string">"msg"</span>, <span class="string">"登录成功"</span>);</span><br><span class="line">        resultData.put(<span class="string">"token"</span>,token);</span><br><span class="line">        ResultUtil.responseJson(response,resultData);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="与JWT有关的工具类-JWTTokenUtil"><a href="#与JWT有关的工具类-JWTTokenUtil" class="headerlink" title="与JWT有关的工具类 JWTTokenUtil"></a>与JWT有关的工具类 JWTTokenUtil</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JWTTokenUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 私有化构造器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">JWTTokenUtil</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成Token</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span> Sans</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@CreateTime</span> 2019/10/2 12:16</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Param</span>  selfUserEntity 用户安全实体</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Return</span> Token</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">createAccessToken</span><span class="params">(SelfUserEntity selfUserEntity)</span></span>&#123;</span><br><span class="line">        <span class="comment">// 登陆成功生成JWT</span></span><br><span class="line">        String token = Jwts.builder()</span><br><span class="line">                <span class="comment">// 放入用户名和用户ID</span></span><br><span class="line">                .setId(selfUserEntity.getUserId()+<span class="string">""</span>)</span><br><span class="line">                <span class="comment">// 主题</span></span><br><span class="line">                .setSubject(selfUserEntity.getUsername())</span><br><span class="line">                <span class="comment">// 签发时间</span></span><br><span class="line">                .setIssuedAt(<span class="keyword">new</span> Date())</span><br><span class="line">                <span class="comment">// 签发者</span></span><br><span class="line">                .setIssuer(<span class="string">"sans"</span>)</span><br><span class="line">                <span class="comment">// 自定义属性 放入用户拥有权限</span></span><br><span class="line">            	<span class="comment">//重申一遍，多角色的时候，这个属性长[&#123;"authority":"ROLE_USER"&#125;,&#123;"authority":"ROLE_ADMIN"&#125;]这样，表明他有两个角色</span></span><br><span class="line">                .claim(<span class="string">"authorities"</span>, JSON.toJSONString(selfUserEntity.getAuthorities()))</span><br><span class="line">                <span class="comment">// 失效时间</span></span><br><span class="line">                .setExpiration(<span class="keyword">new</span> Date(System.currentTimeMillis() + JWTConfig.expiration))</span><br><span class="line">                <span class="comment">// 签名算法和密钥</span></span><br><span class="line">                .signWith(SignatureAlgorithm.HS512, JWTConfig.secret)</span><br><span class="line">                .compact();</span><br><span class="line">        log.info(JSON.toJSONString(selfUserEntity.getAuthorities()));</span><br><span class="line">        <span class="keyword">return</span> token;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5、JWT-数据库-鉴权部分"><a href="#5、JWT-数据库-鉴权部分" class="headerlink" title="5、JWT+数据库 鉴权部分"></a>5、JWT+数据库 鉴权部分</h2><p>上图</p>
<img src="/img/image-20200629141557755.png" alt="image-20200629141557755" style="zoom:80%;">



<p>用到的类</p>
<h3 id="hasPermission-鉴权类-UserPermissionEvaluator"><a href="#hasPermission-鉴权类-UserPermissionEvaluator" class="headerlink" title="hasPermission 鉴权类 UserPermissionEvaluator"></a>hasPermission 鉴权类 UserPermissionEvaluator</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserPermissionEvaluator</span> <span class="keyword">implements</span> <span class="title">PermissionEvaluator</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SysUserService sysUserService;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * hasPermission鉴权方法</span></span><br><span class="line"><span class="comment">     * 这里仅仅判断PreAuthorize注解中的权限表达式</span></span><br><span class="line"><span class="comment">     * 实际中可以根据业务需求设计数据库通过targetUrl和permission做更复杂鉴权</span></span><br><span class="line"><span class="comment">     * 当然targetUrl不一定是URL可以是数据Id还可以是管理员标识等,这里根据需求自行设计</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span> Sans</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@CreateTime</span> 2019/10/6 18:25</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Param</span>  authentication  用户身份(在使用hasPermission表达式时Authentication参数默认会自动带上)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Param</span>  targetUrl  请求路径</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Param</span>  permission 请求路径权限</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Return</span> boolean 是否通过</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">//传入用户安全信息、目标url、需要的权限</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasPermission</span><span class="params">(Authentication authentication, Object targetUrl, Object permission)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 获取用户信息</span></span><br><span class="line">        SelfUserEntity selfUserEntity =(SelfUserEntity) authentication.getPrincipal();</span><br><span class="line">        Collection&lt;GrantedAuthority&gt; authorities = selfUserEntity.getAuthorities();</span><br><span class="line">        <span class="keyword">for</span> (GrantedAuthority authority : authorities) &#123;</span><br><span class="line">            log.info(authority.getAuthority());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 查询用户权限(这里可以将权限放入缓存中提升效率)</span></span><br><span class="line">        Set&lt;String&gt; permissions = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">        <span class="comment">//role，权限表，表示有什么权限</span></span><br><span class="line">        <span class="comment">//menu，功能表，表示能做什么</span></span><br><span class="line">        <span class="comment">//role_menu表，表示什么权限能做什么事情</span></span><br><span class="line">        <span class="comment">//user，用户表，表示你是谁</span></span><br><span class="line">        <span class="comment">//user_role表，表示你有什么权限</span></span><br><span class="line">        <span class="comment">//          SELECT DISTINCT m.* FROM sys_user_role ur</span></span><br><span class="line">        <span class="comment">//			LEFT JOIN sys_role_menu rm ON ur.role_id = rm.role_id</span></span><br><span class="line">        <span class="comment">//			LEFT JOIN sys_menu m ON rm.menu_id = m.menu_id</span></span><br><span class="line">        <span class="comment">//		    WHERE ur.user_id = #&#123;userId&#125;</span></span><br><span class="line">        <span class="comment">//通过用户的id，查询他能干什么。</span></span><br><span class="line">        List&lt;SysMenuEntity&gt; sysMenuEntityList = sysUserService.selectSysMenuByUserId(selfUserEntity.getUserId());</span><br><span class="line">        <span class="keyword">for</span> (SysMenuEntity sysMenuEntity:sysMenuEntityList) &#123;</span><br><span class="line">            permissions.add(sysMenuEntity.getPermission());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 权限对比</span></span><br><span class="line">        <span class="keyword">if</span> (permissions.contains(permission.toString()))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasPermission</span><span class="params">(Authentication authentication, Serializable targetId, String targetType, Object permission)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>详细代码与注释</strong>：<a href="https://gitee.com/gukkibokou/spring-boot-security-demo" target="_blank" rel="external nofollow noopener noreferrer">Gitee</a></p>

        
        <br>
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>

        <div id="lv-container">
        </div>

    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        

        

    </ul>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a href="https://hexo.io/" target="_blank" rel="external nofollow noopener noreferrer">Hexo</a>  Theme <a href="https://github.com/aircloud/hexo-theme-aircloud" target="_blank" rel="external nofollow noopener noreferrer">AirCloud</a></p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>

<script src="/js/index.js"></script>

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


    <script>
        /**
         *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
         *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
        */
        if( '' || '')
        var disqus_config = function () {
            this.page.url = '';  // Replace PAGE_URL with your page's canonical URL variable
            this.page.identifier = ''; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
        };

        (function() { // DON'T EDIT BELOW THIS LINE
            var d = document, s = d.createElement('script');
            s.src = 'https://dadala.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();
    </script>



</html>
